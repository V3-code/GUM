<form class="{{cssClass}} gum-item-sheet effect-sheet" autocomplete="off">

    {{!-- CABEÇALHO --}}
    <header class="sheet-header item-header">
        <img class="profile-img" src="{{item.img}}" data-edit="img" title="{{item.name}}"/>
        <div class="header-fields">
            <h1 class="charname"><input name="name" type="text" value="{{item.name}}" placeholder="Nome do Efeito"/></h1>
        </div>
    </header>

    <nav class="sheet-tabs tabs" data-group="primary">
        <a class="item active" data-tab="configuracao">Configuração</a>
        <a class="item" data-tab="description">Descrição</a>
    </nav>

    <main class="sheet-body">
        <div class="sheet-body-content effect-sheet-body">
            <div class="tab active" data-tab="configuracao" data-group="primary">

                <div class="effect-grid">
                    {{!-- SEÇÃO BARREIRA DE RESISTÊNCIA --}}
<section class="form-section effect-card effect-section">
  {{!-- HEADER (estilo “ataques”) --}}
  <div class="effect-section-header">
    <h4 class="effect-section-title">Barreira de Resistência</h4>

    <label class="effect-section-toggle" title="Ativar registro de barreira">
      <input type="checkbox" name="system.resistanceRoll.isResisted" {{checked system.resistanceRoll.isResisted}}/>
      <span></span>
    </label>
  </div>

  {{!-- BODY --}}
  <div class="effect-section-body {{#unless system.resistanceRoll.isResisted}}is-muted{{/unless}}">
    <div class="effect-row-grid effect-resistance-grid">
      <div class="effect-field">
        <div class="effect-label">Aplicar efeito em</div>
        <select name="system.resistanceRoll.applyOn" {{#unless system.resistanceRoll.isResisted}}disabled{{/unless}}>
          <option value="failure" {{#if (eq system.resistanceRoll.applyOn 'failure')}}selected{{/if}}>Em Falha</option>
          <option value="success" {{#if (eq system.resistanceRoll.applyOn 'success')}}selected{{/if}}>Em Sucesso</option>
        </select>
      </div>

      <div class="effect-field">
        <div class="effect-label">Atributo</div>
        <input type="text" name="system.resistanceRoll.attribute" value="{{system.resistanceRoll.attribute}}" {{#unless system.resistanceRoll.isResisted}}disabled{{/unless}}/>
      </div>

      <div class="effect-field">
        <div class="effect-label">Modificador</div>
        <input type="text" name="system.resistanceRoll.modifier" value="{{system.resistanceRoll.modifier}}" {{#unless system.resistanceRoll.isResisted}}disabled{{/unless}}/>
      </div>

      <div class="effect-field">
        <div class="effect-label">Margem Min</div>
        <input type="text" name="system.resistanceRoll.margin" value="{{system.resistanceRoll.margin}}" placeholder="Opcional" {{#unless system.resistanceRoll.isResisted}}disabled{{/unless}}/>
      </div>
    </div>

    <label class="custom-checkbox block effect-inline-checkbox">
      <input type="checkbox" name="system.resistanceRoll.skipPromptCard" {{checked system.resistanceRoll.skipPromptCard}} {{#unless system.resistanceRoll.isResisted}}disabled{{/unless}}/>
      <span>Realizar o teste automaticamente, mas não publicar no chat.</span>
    </label>
  </div>
</section>


                    {{!-- SEÇÃO EFEITO --}}
                    <section class="form-section effect-card">
<div class="effect-section-header">
  <h4 class="effect-section-title">Tipo de Efeito</h4>

  <div class="effect-section-select">
    <select name="system.type">
      <option value="attribute" {{#if (eq system.type 'attribute')}}selected{{/if}}>Modificador de Atributo</option>
      <option value="status" {{#if (eq system.type 'status')}}selected{{/if}}>Status</option>
      <option value="resource_change" {{#if (eq system.type 'resource_change')}}selected{{/if}}>Alteração de Recurso</option>
      <option value="roll_modifier" {{#if (eq system.type 'roll_modifier')}}selected{{/if}}>Modificador de Rolagem</option>
      <option value="chat" {{#if (eq system.type 'chat')}}selected{{/if}}>Mensagem de Chat</option>
      <option value="macro" {{#if (eq system.type 'macro')}}selected{{/if}}>Macro</option>
      <option value="flag" {{#if (eq system.type 'flag')}}selected{{/if}}>Flag</option>
    </select>
  </div>
</div>

                        <div class="hint-area">
                            {{#if system.type}}
                                <div class="hint-card single active">
                                   {{#if (eq system.type 'attribute')}}
                                        <h5>Modificador de Atributo</h5>
                                        <p>Use para efeitos contínuos no ator, como +1 ST ou -2 DX. Cria um efeito ativo.</p>
                                    {{else}}
                                        {{#if (eq system.type 'resource_change')}}
                                            <h5>Alteração de Recurso</h5>
                                            <p>Aplicação pontual: custo de PF, flechas gastas ou cura/dano imediato.</p>
                                        {{else}}
                                            {{#if (eq system.type 'status')}}
                                                <h5>Status</h5>
                                                <p>Aplica um ícone de status no token do alvo.</p>
                                            {{else}}
                                                {{#if (eq system.type 'roll_modifier')}}
                                                    <h5>Modificador de Rolagem</h5>
                                                    <p>Cria um modificador temporário para testes, respeitando contexto e teto.</p>
                                                {{else}}
                                                    {{#if (eq system.type 'macro')}}
                                                        <h5>Macro</h5>
                                                        <p>Executa uma macro existente. Ideal para ações complexas.</p>
                                                    {{else}}
                                                        {{#if (eq system.type 'flag')}}
                                                            <h5>Flag</h5>
                                                            <p>Define um estado personalizado que outras condições podem consultar.</p>
                                                        {{else}}
                                                            {{#if (eq system.type 'chat')}}
                                                                <h5>Mensagem de Chat</h5>
                                                                <p>Envia um texto informativo e, opcionalmente, inclui um teste rápido.</p>
                                                            {{/if}}
                                                        {{/if}}
                                                    {{/if}}
                                                {{/if}}
                                            {{/if}}
                                        {{/if}}
                                    {{/if}}
                                </div>
                            {{else}}
                                <div class="hint-card single muted">
                                    <h5>Escolha um tipo</h5>
                                    <p>Selecione um tipo de efeito para ver um resumo rápido do seu comportamento.</p>
                                </div>
                            {{/if}}
                        </div>
                    </section>
                </div>

                <section class="form-section effect-card">
                    <div class="section-header">
                        <div>
                            <p class="eyebrow">Configuração dinâmica</p>
                            <h4 class="section-title">Campos do Tipo Selecionado</h4>
                        </div>
                    </div>

                    <div class="conditional-fields modern">
                        {{!-- BLOCO COMBINADO PARA ATTRIBUTE e FLAG --}}
                        {{#if (or (eq system.type 'attribute') (eq system.type 'flag'))}}
                            <div class="conditional-card">
                                <div class="conditional-card-header">
                                    <div>
                                        <p class="eyebrow">Dados principais</p>
                                        <h5>{{#if (eq system.type 'attribute')}}Configuração do Atributo{{else}}Configuração da Flag{{/if}}</h5>
                                    </div>
                                    <span class="chip subtle">{{#if (eq system.type 'attribute')}}Contínuo{{else}}Marcador{{/if}}</span>
                                </div>

                                {{#if (eq system.type 'attribute')}}
                                    <div class="effect-detail-grid">
                                        <div class="form-row stacked">
                                            <label class="row-label">Caminho</label>
                                            <textarea name="system.path" rows="1" placeholder="Ex: system.attributes.dx.mod">{{system.path}}</textarea>
                                        </div>
                                        <div class="form-row stacked">
                                            <label class="row-label">Operação</label>
                                            <div class="radio-group horizontal">
                                                <label class="custom-radio"><input type="radio" name="system.operation" value="ADD" {{checked (or (eq system.operation 'ADD') (eq system.operation 'SUB') (not system.operation))}}><span>Adicionar (ADD)</span></label>
                                                <label class="custom-radio"><input type="radio" name="system.operation" value="OVERRIDE" {{checked (eq system.operation 'OVERRIDE')}}><span>Definir (SET/OVERRIDE)</span></label>
                                            </div>
                                        </div>
                                        <div class="form-row stacked">
                                            <label class="row-label">Valor</label>
                                            <textarea name="system.value" rows="1" placeholder="Ex: -2 ou @st.mod">{{system.value}}</textarea>
                                        </div>
                                    </div>
                                    <p class="hint inline">Use valores negativos para subtrair com "ADD". "SET" sobrescreve o valor base.</p>
                                {{/if}}

                                {{#if (eq system.type 'flag')}}
                                    <div class="effect-detail-grid">
                                        <div class="form-row stacked">
                                            <label class="row-label">Chave da Flag (Key)</label>
                                            <input type="text" name="system.key" value="{{system.key}}" placeholder="Ex: em_chamas"/>
                                        </div>
                                        <div class="form-row stacked">
                                            <label class="row-label">Valor da Flag</label>
                                            <div class="radio-group horizontal">
                                                <label class="custom-radio">
                                                    <input type="radio" name="system.flag_value_selector" value="true" {{checked (eq flagValueSelection 'true')}}>
                                                    <span>Verdadeiro</span>
                                                </label>
                                                <label class="custom-radio">
                                                    <input type="radio" name="system.flag_value_selector" value="false" {{checked (eq flagValueSelection 'false')}}>
                                                    <span>Falso</span>
                                                </label>
                                                <label class="custom-radio">
                                                    <input type="radio" name="system.flag_value_selector" value="custom" {{checked (eq flagValueSelection 'custom')}}>
                                                    <span>Outro</span>
                                                </label>
                                            </div>
                                        </div>
                                        {{#unless (eq flagValueSelection)}}
                                            <div class="form-row stacked">
                                                <label class="row-label">Valor Customizado</label>
                                                <input type="text" name="system.flag_value" value="{{system.flag_value}}"/>
                                            </div>
                                        {{/unless}}
                                    </div>
                                {{/if}}
                            </div>
                        {{/if}}

                        {{!-- SEÇÃO PARA STATUS --}}
                        {{#if (eq system.type 'status')}}
                            <div class="conditional-card">
                                <div class="conditional-card-header">
                                    <div>
                                        <p class="eyebrow">Marca visual</p>
                                        <h5>Ícone de Status</h5>
                                    </div>
                                    <span class="chip subtle">Token</span>
                                </div>
                                <div class="form-row stacked">
                                    <label class="row-label">Ícone de Status a Aplicar</label>
                                    <select name="system.statusId">
                                        {{#each statusEffects as |status|}}
                                            <option value="{{status.id}}" {{#if (eq ../system.statusId status.id)}}selected{{/if}}>
                                                {{status.label}}
                                            </option>
                                        {{/each}}
                                    </select>
                                </div>
 </div>
                        {{/if}}

                        {{!-- SEÇÃO PARA ROLL_MODIFIER --}}
                        {{#if (eq system.type 'roll_modifier')}}
                            <div class="conditional-card">
                                <div class="conditional-card-header">
                                    <div>
                                        <p class="eyebrow">Ajuste de teste</p>
                                        <h5>Modificador de Rolagem</h5>
                                    </div>
                                    <span class="chip subtle">Contextual</span>
                                </div>
                                <div class="effect-detail-grid">
                                    <div class="form-row stacked">
                                        <label class="row-label">Valor do Modificador</label>
                                        <input type="text" name="system.roll_modifier_value" value="{{system.roll_modifier_value}}" placeholder="Ex: +2 ou -1"/>
                                    </div>
                                    <div class="form-row stacked">
                                        <label class="row-label">Teto (Cap)</label>
                                        <input type="text" name="system.roll_modifier_cap" value="{{system.roll_modifier_cap}}" placeholder="Opcional"/>
                                    </div>
<div class="form-row stacked">
                                        <label class="row-label">Contextos Afetados</label>
                                        <input type="hidden" name="system.roll_modifier_context" value="{{rollModifierContextValue}}"/>
                                        <div class="roll-context-all">
                                            <label class="gm-checkbox">
                                                <input type="checkbox" class="roll-context-checkbox" data-context="{{rollModifierContextAll.id}}" {{checked rollModifierContextAll.selected}}/>
                                                <span>{{rollModifierContextAll.label}}</span>
                                            </label>
                                        </div>
                                        <div class="roll-context-columns">
                                            {{#each rollModifierContextGroups as |group|}}
                                                <div class="roll-context-group">
                                                    <p class="roll-context-title">{{group.title}}</p>
                                                    <div class="roll-context-list {{group.listClass}}">
                                                        {{#each group.contexts as |ctx|}}
                                                            <label class="gm-checkbox">
                                                                <input type="checkbox" class="roll-context-checkbox" data-context="{{ctx.id}}" {{checked ctx.selected}}/>
                                                                <span>{{ctx.label}}</span>
                                                            </label>
                                                        {{/each}}
                                                    </div>
                                                </div>
                                            {{/each}}
                                        </div>
                                        <p class="hint">Selecione mais de um contexto. "Qualquer rolagem" substitui as demais opções.</p>
                                    </div>
                                </div>
                            </div>
                        {{/if}}

                        {{!-- SEÇÃO PARA RESOURCE_CHANGE --}}
                        {{#if (eq system.type 'resource_change')}}
                            <div class="conditional-card">
                                <div class="conditional-card-header">
                                    <div>
                                        <p class="eyebrow">Impacto imediato</p>
                                        <h5>Alteração de Recurso</h5>
                                    </div>
                                    <span class="chip subtle">Consumir / Restaurar</span>
                                </div>
                                <div class="effect-detail-grid">
                                    <div class="form-row stacked">
                                        <label class="row-label">Valor da Alteração</label>
                                        <input type="text" name="system.value" value="{{system.value}}" placeholder="Ex: -1 ou 2d6"/>
                                    </div>
                                    <div class="form-row stacked">
                                        <label class="row-label">Alvo da Alteração</label>
                                        <select name="system.category">
                                            <option value="hp" {{#if (eq system.category 'hp')}}selected{{/if}}>Pontos de Vida</option>
                                            <option value="fp" {{#if (eq system.category 'fp')}}selected{{/if}}>Pontos de Fadiga</option>
                                            <option value="energy_reserve" {{#if (eq system.category 'energy_reserve')}}selected{{/if}}>Reserva de Energia</option>
                                            <option value="combat_tracker" {{#if (eq system.category 'combat_tracker')}}selected{{/if}}>Registro de Combate</option>
                                            <option value="item_quantity" {{#if (eq system.category 'item_quantity')}}selected{{/if}}>Quantidade de Equipamento</option>
                                        </select>
                                    </div>
                                    {{#if (or (eq system.category 'energy_reserve') (eq system.category 'combat_tracker') (eq system.category 'item_quantity'))}}
                                        <div class="form-row stacked">
                                            <label class="row-label">Nome Específico</label>
                                            <input type="text" name="system.name" value="{{system.name}}" placeholder="Digite o nome exato"/>
                                        </div>
                                    {{/if}}
                                </div>

                                <div class="advanced-options">
                                    <h6>Opções avançadas</h6>
                                    <div class="checkbox-options">
                                        <label class="custom-checkbox"><input type="checkbox" name="system.chat_notice" {{checked system.chat_notice}}/><span>Gerar aviso no chat</span></label>
                                        <label class="custom-checkbox"><input type="checkbox" name="system.confirm_prompt" {{checked system.confirm_prompt}}/><span>Pedir confirmação antes de aplicar</span></label>
                                        <label class="custom-checkbox"><input type="checkbox" name="system.variable_value" {{checked system.variable_value}}/><span>Permitir alterar o valor</span></label>
                                    </div>
                                </div>
                            </div>
                        {{/if}}

                        {{!-- SEÇÃO PARA MACRO --}}
                        {{#if (eq system.type 'macro')}}
                            <div class="conditional-card">
                                <div class="conditional-card-header">
                                    <div>
                                        <p class="eyebrow">Automação</p>
                                        <h5>Macro</h5>
                                    </div>
                                    <span class="chip subtle">Execução</span>
                                </div>
                                <div class="form-row stacked">
                                    <label class="row-label">Nome da Macro</label>
                                    <div class="input-with-validation">
                                        <input type="text" name="system.value" value="{{system.value}}" list="macro-list" autocomplete="off"/>
                                        <span class="validation-icon"></span>
                                    </div>
                                    <datalist id="macro-list">
                                        {{#each macros as |macroName|}}
                                            <option value="{{macroName}}">
                                        {{/each}}
                                    </datalist>
                                </div>
                            </div>
                        {{/if}}

                        {{!-- SEÇÃO PARA CHAT --}}
                        {{#if (eq system.type 'chat')}}
                            <div class="conditional-card">
                                <div class="conditional-card-header">
                                    <div>
                                        <p class="eyebrow">Comunicação</p>
                                        <h5>Mensagem de Chat</h5>
                                    </div>
                                    <span class="chip subtle">Texto</span>
                                </div>
                                    <div class="form-group">
                                        <label>Texto da Mensagem</label>
                                            <textarea name="system.chat_text" rows="3">{{system.chat_text}}</textarea>
                                            <label class="custom-checkbox hint block">
                                                <input type="checkbox" name="system.has_roll" {{checked system.has_roll}}/>
                                                <span>Incluir teste?</span>
                                            </label>
                                        {{#if system.has_roll}}
                                            <div class="form-grid-3">
                                                <div class="form-group"><label>Rótulo</label><input type="text" name="system.roll_label" value="{{system.roll_label}}"/></div>
                                                <div class="form-group"><label>Atributo/Perícia</label><input type="text" name="system.roll_attribute" value="{{system.roll_attribute}}"/></div>
                                                <div class="form-group"><label>Modificador</label><input type="text" name="system.roll_modifier" value="{{system.roll_modifier}}"/></div>
                                            </div>
                                        {{/if}}
                                    </div>
                                </div>
                        {{/if}}
                    </div>
                </section>

                {{#if (or (eq system.type 'attribute') (eq system.type 'status') (eq system.type 'flag') (eq system.type 'roll_modifier'))}}
<section class="form-section effect-card effect-section">
  <div class="effect-section-header">
    <h4 class="effect-section-title">Duração do Efeito</h4>

    {{!-- DROPDOWN de modo (visual) --}}
    <div class="effect-section-select">
      <select class="duration-mode-select" name="system.duration._uiMode">
        <option value="permanent" {{#if system.duration.isPermanent}}selected{{/if}}>Permanente</option>
        <option value="combat" {{#if (and (not system.duration.isPermanent) system.duration.inCombat)}}selected{{/if}}>Temporária/Combate</option>
        <option value="timed" {{#if (and (not system.duration.isPermanent) (not system.duration.inCombat))}}selected{{/if}}>Temporária</option>
      </select>
    </div>
  </div>

  {{!-- Mantemos os campos reais do sistema (pode deixar oculto via CSS) --}}
  <input type="checkbox" class="duration-hidden" name="system.duration.isPermanent" {{checked system.duration.isPermanent}}/>
  <input type="checkbox" class="duration-hidden" name="system.duration.inCombat" {{checked system.duration.inCombat}}/>

  <div class="effect-section-body">

    {{!-- Só aparece quando NÃO for permanente --}}
    {{#unless system.duration.isPermanent}}

      {{!-- Temporária/Combate: mostra o seu bloco atual (com leve reorganização em grid) --}}
      {{#if system.duration.inCombat}}
        <div class="effect-row-grid effect-duration-grid">
          <div class="effect-field">
            <div class="effect-label">Início da contagem</div>
            <select name="system.duration.startMode">
              <option value="apply" {{#if (eq system.duration.startMode 'apply')}}selected{{/if}}>Ao aplicar</option>
              <option value="nextTurnStart" {{#if (eq system.duration.startMode 'nextTurnStart')}}selected{{/if}}>No início do próximo turno</option>
            </select>
          </div>

          <div class="effect-field">
            <div class="effect-label">Rodadas (seg)</div>
            <input type="number" name="system.duration.value" value="{{system.duration.value}}" min="1"/>
          </div>

          <div class="effect-field">
            <div class="effect-label">Fim da contagem</div>
            <select name="system.duration.endMode">
              <option value="turnStart" {{#if (eq system.duration.endMode 'turnStart')}}selected{{/if}}>No início do turno final</option>
              <option value="turnEnd" {{#if (eq system.duration.endMode 'turnEnd')}}selected{{/if}}>No fim do turno final</option>
            </select>
          </div>
        </div>
      {{/if}}

      {{!-- Se “Temporária” (fora de combate) no futuro: você decide o que mostrar aqui --}}
      {{#if (and (not system.duration.inCombat))}}
        <p class="hint">Modo temporário fora de combate: (se quiser usar depois, definimos a UI aqui).</p>
      {{/if}}

    {{/unless}}

  </div>
</section>

                {{/if}}
            </div>

            {{! ========================================================= }}
            {{!  ABA "DESCRIÇÃO" (COM O EDITOR CORRETO)     }}
            {{! ========================================================= }}
            <div class="tab" data-tab="description" data-group="primary">
              <div class="description-tab">
                <div class="description-grid">
                  <div class="form-section description-section">
                    <div class="description-header">
                      <div>
                        <h4 class="section-title">Descrição Resumida (Chat)</h4>
                        <p class="hint">Use para tooltips e mensagens rápidas.</p>
                      </div>
                      {{#if editable}}
                      <div class="description-actions">
                        <button type="button" class="toggle-editor" data-field="system.chat_description">
                          <i class="fas fa-pen"></i> Editar
                        </button>
                      </div>
                      {{/if}}
                    </div>
                    <div class="description-view">{{{system.chat_description}}}</div>

                    <div class="description-editor" style="display:none;">
                      {{editor system.chat_description target="system.chat_description" engine="prosemirror" owner=owner editable=editable}}
                      <div class="description-actions">
                        <button type="button" class="save-description" data-field="system.chat_description"><i class="fas fa-save"></i> Salvar</button>
                        <button type="button" class="expand-description" data-expanded="false"><i class="fas fa-expand"></i> Expandir</button>
                        <button type="button" class="cancel-description"><i class="fas fa-times"></i> Cancelar</button>
                      </div>
                    </div>
                  </div>

                  <div class="form-section description-section">
                    <div class="description-header">
                      <div>
                        <h4 class="section-title">Descrição Completa</h4>
                        <p class="hint">Inclua detalhes extensos, efeitos narrativos e referências.</p>
                      </div>
                      {{#if editable}}
                      <div class="description-actions">
                        <button type="button" class="toggle-editor" data-field="system.description">
                          <i class="fas fa-pen"></i> Editar
                        </button>
                      </div>
                      {{/if}}
                    </div>
                    <div class="description-view">{{{system.description}}}</div>

                    <div class="description-editor" style="display:none;">
                      {{editor system.description target="system.description" engine="prosemirror" owner=owner editable=editable}}
                      <div class="description-actions">
                        <button type="button" class="save-description" data-field="system.description"><i class="fas fa-save"></i> Salvar</button>
                        <button type="button" class="expand-description" data-expanded="false"><i class="fas fa-expand"></i> Expandir</button>
                        <button type="button" class="cancel-description"><i class="fas fa-times"></i> Cancelar</button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
        </div>
    </main>
</form>