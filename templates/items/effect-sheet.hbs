<form class="{{cssClass}} gum-item-sheet effect-sheet" autocomplete="off">

    {{!-- CABEÇALHO --}}
    <header class="sheet-header item-header">
        <img class="profile-img" src="{{item.img}}" data-edit="img" title="{{item.name}}"/>
        <div class="header-fields">
            <h1 class="charname"><input name="name" type="text" value="{{item.name}}" placeholder="Nome do Efeito"/></h1>
        </div>
    </header>

    <main class="sheet-body">
        <div class="sheet-body-content">
            
            {{!-- SEÇÃO BARREIRA DE RESISTÊNCIA --}}
            <div class="form-section">
                <h4 class="section-title">Barreira de Resistência</h4>
                <div class="resistance-section">
                    <label class="custom-checkbox">
                        <input type="checkbox" name="system.resistanceRoll.isResisted" {{checked system.resistanceRoll.isResisted}}/>
                        <span>Resistência específica para este efeito antes dele ser aplicado.</span>
                    </label>

                    {{#if system.resistanceRoll.isResisted}}
                    <div class="indented">
                        <hr>
                        <div class="form-grid-2">
                            <div class="form-group"><label>Atributo do Teste</label><input type="text" name="system.resistanceRoll.attribute" value="{{system.resistanceRoll.attribute}}"/></div>
                            <div class="form-group"><label>Modificador</label><input type="text" name="system.resistanceRoll.modifier" value="{{system.resistanceRoll.modifier}}"/></div>
                        </div>

                        {{!-- Linha de "Aplicar Se" --}}
                        <div class="form-row">
                            <label class="row-label">Aplicar efeito se obter:</label>
                            <div class="radio-group horizontal">
                                <label class="custom-radio"><input type="radio" name="system.resistanceRoll.applyOn" value="failure" {{checked (eq system.resistanceRoll.applyOn 'failure')}}><span>Falha</span></label>
                                <label class="custom-radio"><input type="radio" name="system.resistanceRoll.applyOn" value="success" {{checked (eq system.resistanceRoll.applyOn 'success')}}><span>Sucesso</span></label>
                            </div>
                        </div>

                        {{!-- Linha da "Margem Mínima" --}}
                        <div class="form-row">
                            <label class="row-label">Margem Mínima:</label>
                            <input type="text" name="system.resistanceRoll.margin" value="{{system.resistanceRoll.margin}}" placeholder="Opcional"/>
                        </div>
                    </div>
                    {{/if}}
                </div>
            </div>

{{!-- SEÇÃO EFEITO --}}
<div class="form-section">
    <h4 class="section-title">Efeito</h4>
    
    {{!-- Linha do "Tipo de Efeito" --}}
    <div class="form-row">
        <label class="row-label">Tipo de Efeito:</label>
        <select name="system.type">
            <option value="attribute" {{#if (eq system.type 'attribute')}}selected{{/if}}>Modificador de Atributo</option>
            <option value="status" {{#if (eq system.type 'status')}}selected{{/if}}>Status</option>
            <option value="resource_change" {{#if (eq system.type 'resource_change')}}selected{{/if}}>Alteração de Recurso</option>
            <option value="chat" {{#if (eq system.type 'chat')}}selected{{/if}}>Mensagem de Chat</option>
            <option value="macro" {{#if (eq system.type 'macro')}}selected{{/if}}>Macro</option>
            <option value="flag" {{#if (eq system.type 'flag')}}selected{{/if}}>Flag</option>
        </select>
    </div>

    {{!-- Textos de Ajuda (Hints) --}}
    {{#if (eq system.type 'attribute')}}<p class="hint">Modifica um atributo de forma contínua (Ex: +1 ST, -2 DX). Cria um Efeito Ativo.</p>{{/if}}
    {{#if (eq system.type 'resource_change')}}<p class="hint">Altera um recurso de forma pontual (Ex: custo de PF, consumo de flechas, cura de PV).</p>{{/if}}
    {{#if (eq system.type 'status')}}<p class="hint">Aplica um ícone de status no token do alvo.</p>{{/if}}
    {{#if (eq system.type 'macro')}}<p class="hint">Executa uma macro previamente feita.</p>{{/if}}
    
    <hr>

    {{!-- Campos Condicionais --}}
    <div class="conditional-fields">
    
        {{!-- ✅ SEÇÃO DE CAMPOS PARA O NOSSO NOVO TIPO 'RESOURCE_CHANGE' --}}
        {{#if (eq system.type 'resource_change')}}
            <div class="resource-change-layout">
                {{!-- Valor da Alteração --}}
                <div class="form-row">
                    <label class="row-label">Valor da Alteração:</label>
                    <input type="text" name="system.value" value="{{system.value}}" placeholder="Ex: -1 ou 2d6"/>
                </div>

                {{!-- Categoria do Alvo --}}
                <div class="form-row">
                    <label class="row-label">Alvo da Alteração:</label>
                    <select name="system.category">
                        <option value="hp" {{#if (eq system.category 'hp')}}selected{{/if}}>Pontos de Vida</option>
                        <option value="fp" {{#if (eq system.category 'fp')}}selected{{/if}}>Pontos de Fadiga</option>
                        <option value="energy_reserve" {{#if (eq system.category 'energy_reserve')}}selected{{/if}}>Reserva de Energia</option>
                        <option value="combat_tracker" {{#if (eq system.category 'combat_tracker')}}selected{{/if}}>Registro de Combate</option>
                        <option value="item_quantity" {{#if (eq system.category 'item_quantity')}}selected{{/if}}>Quantidade de Equipamento</option>
                    </select>
                </div>

                {{!-- Nome do Alvo (se necessário) --}}
                {{#if (or (eq system.category 'energy_reserve') (eq system.category 'combat_tracker') (eq system.category 'item_quantity'))}}
                <div class="form-row indented">
                    <label class="row-label">Nome Específico:</label>
                    <input type="text" name="system.name" value="{{system.name}}" placeholder="Digite o nome exato da Reserva/Registro/Item"/>
                </div>
                {{/if}}

                <hr>
                <h4 class="subsection-title">Opções Avançadas</h4>

                {{!-- Checkboxes de Funcionalidades --}}
                <div class="checkbox-options">
                    <label class="custom-checkbox">
                        <input type="checkbox" name="system.chat_notice" {{checked system.chat_notice}}/>
                        <span>Gerar aviso no chat</span>
                    </label>
                    <label class="custom-checkbox">
                        <input type="checkbox" name="system.confirm_prompt" {{checked system.confirm_prompt}}/>
                        <span>Pedir confirmação antes de aplicar</span>
                    </label>
                    <label class="custom-checkbox">
                        <input type="checkbox" name="system.variable_value" {{checked system.variable_value}}/>
                        <span>Permitir alterar o valor</span>
                    </label>
                </div>
            </div>
        {{/if}}

            {{!-- Campos Condicionais (VERSÃO FINAL COM GRANDE UNIFICAÇÃO) --}}
            <div class="conditional-fields">

                {{!-- ======================================================= --}}
                {{!--  BLOCO COMBINADO PARA ATTRIBUTE e FLAG                 --}}
                {{!-- ======================================================= --}}
                {{#if (or (eq system.type 'attribute') (eq system.type 'flag'))}}
                    <div class="attribute-flag-layout"> {{!-- Container comum --}}
                        
                        {{!-- CAMPOS ESPECÍFICOS DO 'ATTRIBUTE' (só aparecem se for attribute) --}}
                        {{#if (eq system.type 'attribute')}}
                            <h4 class="subsection-title">Configuração do Atributo</h4>
                            <div class="form-row">
                                <label class="row-label">Caminho:</label>
                                <textarea name="system.path" rows="1" placeholder="Ex: system.attributes.dx.mod">{{system.path}}</textarea>
                            </div>
                            <div class="form-row">
                                <label class="row-label">Operação:</label>
                                <div class="radio-group horizontal">
                                    {{!-- Mapeamento: ADD -> ADD (2), SET -> OVERRIDE (5) --}}
                                    <label class="custom-radio"><input type="radio" name="system.operation" value="ADD" {{checked (or (eq system.operation 'ADD') (eq system.operation 'SUB') (not system.operation))}}><span>Adicionar (ADD)</span></label>
                                    <label class="custom-radio"><input type="radio" name="system.operation" value="OVERRIDE" {{checked (eq system.operation 'OVERRIDE')}}><span>Definir (SET/OVERRIDE)</span></label>
                                </div>
                            </div>
                            <div class="form-row">
                                <label class="row-label">Valor:</label>
                                <textarea name="system.value" rows="1" placeholder="Ex: -2 ou @st.mod">{{system.value}}</textarea>
                            </div>
                            <p class="hint">Use valores negativos para subtrair com 'ADD'. 'SET' sobrescreve o valor base (Override).</p>
                            <hr> 
                        {{/if}}

                        {{!-- CAMPOS ESPECÍFICOS DO 'FLAG' (só aparecem se for flag) --}}
                        {{#if (eq system.type 'flag')}}
                            <h4 class="subsection-title">Configuração da Flag</h4>
                            <p class="hint">Define uma flag customizada no alvo. Útil para criar estados que outras condições podem verificar.</p>
                            <div class="form-row">
                                <label class="row-label">Chave da Flag (Key):</label>
                                <input type="text" name="system.key" value="{{system.key}}" placeholder="Ex: em_chamas"/>
                            </div>
                            {{!-- Linha do Valor Lógico --}}
                            <div class="form-row">
                                <label class="row-label">Valor da Flag:</label>
                                <div class="radio-group horizontal">
                                    <label class="custom-radio">
                                        <input type="radio" name="system.flag_value_selector" value="true" {{checked (eq flagValueSelection 'true')}}>
                                        <span>Verdadeiro</span>
                                    </label>
                                    <label class="custom-radio">
                                        <input type="radio" name="system.flag_value_selector" value="false" {{checked (eq flagValueSelection 'false')}}>
                                        <span>Falso</span>
                                    </label>
                                    <label class="custom-radio">
                                        <input type="radio" name="system.flag_value_selector" value="custom" {{checked (eq flagValueSelection 'custom')}}>
                                        <span>Outro</span>
                                    </label>
                                </div>
                            </div>
                            {{!-- Campo de valor customizado --}}
                            {{#unless flagValueIsBoolean}}
                                <div class="form-row indented">
                                    <label class="row-label">Valor Customizado:</label>
                                    <input type="text" name="system.flag_value" value="{{system.flag_value}}"/>
                                </div>
                            {{/unless}}
                            <hr> 
                        {{/if}}                       
                    </div>
                {{/if}}

                {{!-- ======================================================= --}}
                {{!--  SEÇÃO PARA STATUS (Restaurada)                      --}}
                {{!-- ======================================================= --}}
                {{#if (eq system.type 'status')}}  
                <div class="form-row">
                <label class="row-label">Ícone de Status a Aplicar:</label>
                <select name="system.statusId">
                {{!-- Popula com a lista de status do config.js --}}
                {{#each statusEffects as |status|}}
                <option value="{{status.id}}" {{#if (eq ../system.statusId status.id)}}selected{{/if}}>
                {{status.label}}
                </option>
                {{/each}}
                </select>
                </div>
                <p class="hint">Este efeito aplicará o ícone de status selecionado ao token do alvo.</p>
                {{/if}}

                {{!-- ======================================================= --}}
                {{!--  SEÇÃO PARA RESOURCE_CHANGE (Seu código original)     --}}
                {{!-- ======================================================= --}}
                {{#if (eq system.type 'resource_change')}}
                    <div class="resource-change-layout">
                        {{!-- Valor da Alteração --}}
                        <div class="form-row">
                            <label class="row-label">Valor da Alteração:</label>
                            <input type="text" name="system.value" value="{{system.value}}" placeholder="Ex: -1 ou 2d6"/>
                        </div>
                        {{!-- Categoria do Alvo --}}
                        <div class="form-row">
                            <label class="row-label">Alvo da Alteração:</label>
                            <select name="system.category">
                                <option value="hp" {{#if (eq system.category 'hp')}}selected{{/if}}>Pontos de Vida</option>
                                <option value="fp" {{#if (eq system.category 'fp')}}selected{{/if}}>Pontos de Fadiga</option>
                                <option value="energy_reserve" {{#if (eq system.category 'energy_reserve')}}selected{{/if}}>Reserva de Energia</option>
                                <option value="combat_tracker" {{#if (eq system.category 'combat_tracker')}}selected{{/if}}>Registro de Combate</option>
                                <option value="item_quantity" {{#if (eq system.category 'item_quantity')}}selected{{/if}}>Quantidade de Equipamento</option>
                            </select>
                        </div>
                        {{!-- Nome do Alvo (se necessário) --}}
                        {{#if (or (eq system.category 'energy_reserve') (eq system.category 'combat_tracker') (eq system.category 'item_quantity'))}}
                        <div class="form-row indented">
                            <label class="row-label">Nome Específico:</label>
                            <input type="text" name="system.name" value="{{system.name}}" placeholder="Digite o nome exato"/>
                        </div>
                        {{/if}}
                        <hr>
                        <h4 class="subsection-title">Opções Avançadas</h4>
                        {{!-- Checkboxes de Funcionalidades --}}
                        <div class="checkbox-options">
                            <label class="custom-checkbox"><input type="checkbox" name="system.chat_notice" {{checked system.chat_notice}}/><span>Gerar aviso no chat</span></label>
                            <label class="custom-checkbox"><input type="checkbox" name="system.confirm_prompt" {{checked system.confirm_prompt}}/><span>Pedir confirmação antes de aplicar</span></label>
                            <label class="custom-checkbox"><input type="checkbox" name="system.variable_value" {{checked system.variable_value}}/><span>Permitir alterar o valor</span></label>
                        </div>
                    </div>
                {{/if}}

                {{!-- ======================================================= --}}
                {{!--  SEÇÃO PARA MACRO (Seu código original)                --}}
                {{!-- ======================================================= --}}
                {{#if (eq system.type 'macro')}}
                    <div class="form-row">
                        <label class="row-label">Nome da Macro:</label>
                        <div class="input-with-validation">
                            <input type="text" name="system.value" value="{{system.value}}" list="macro-list" autocomplete="off"/>
                            <span class="validation-icon"></span>
                        </div>
                        <datalist id="macro-list">
                            {{#each macros as |macroName|}}
                                <option value="{{macroName}}">
                            {{/each}}
                        </datalist>
                    </div>
                {{/if}}

                {{!-- ======================================================= --}}
                {{!--  SEÇÃO PARA CHAT (Seu código original)                 --}}
                {{!-- ======================================================= --}}
                {{#if (eq system.type 'chat')}}
                    <div class="form-group"><label>Texto da Mensagem</label><textarea name="system.chat_text" rows="3">{{system.chat_text}}</textarea></div>
                    <label class="custom-checkbox hint"><input type="checkbox" name="system.has_roll" {{checked system.has_roll}}/><span>Incluir um botão de teste?</span></label>
                    {{#if system.has_roll}}
                    <div class="form-grid-3 indented">
                        <div class="form-group"><label>Rótulo</label><input type="text" name="system.roll_label" value="{{system.roll_label}}"/></div>
                        <div class="form-group"><label>Atributo</label><input type="text" name="system.roll_attribute" value="{{system.roll_attribute}}"/></div>
                        <div class="form-group"><label>Modificador</label><input type="text" name="system.roll_modifier" value="{{system.roll_modifier}}"/></div>
                    </div>
                    {{/if}}
                {{/if}}

            </div> {{!-- Fim de conditional-fields --}}

            </div>

        </div>

            {{#if (or (eq system.type 'attribute') (eq system.type 'status') (eq system.type 'flag'))}}
                  
                    <div class="form-section">
                        <h4 class="section-title">Duração & Expiração</h4>
                                                <label class="custom-checkbox permanent-duration-checkbox">
                            <input type="checkbox" name="system.duration.isPermanent" {{checked system.duration.isPermanent}}/>
                            <span>Duração Permanente / Indeterminada</span>
                        </label>
                        <p class="hint">Se marcado, o efeito não expirará automaticamente.</p>

                        {{!-- Campos de Duração (só aparecem se NÃO for permanente) --}}
                        {{#unless system.duration.isPermanent}}
                            <div class="timed-duration-fields">
                                <hr>
                                <div class="form-grid-2">
                                    {{!-- Campo do Valor da Duração --}}
                                    <div class="form-group">
                                        <label>Duração</label>
                                        <input type="number" name="system.duration.value" value="{{system.duration.value}}" min="1"/> {{!-- Valor mínimo 1 --}}
                                    </div>

                                    {{!-- Campo da Unidade (Simplificado) --}}
                                    <div class="form-group">
                                        <label>Unidade</label>
                                        <select name="system.duration.unit">
                                            {{!-- Opção padrão --}}
                                            <option value="rounds" {{#if (or (eq system.duration.unit 'rounds') (eq system.duration.unit 'seconds'))}}selected{{/if}}>Turnos (1s)</option>
                                            <option value="turns" {{#if (eq system.duration.unit 'turns')}}selected{{/if}}>Em construção</option>
                                            {{!-- Outras unidades (minutos, horas) podem ser adicionadas se necessário --}}
                                        </select>
                                    </div>
                                </div>
                                
                                {{!-- Checkbox "Apenas em Combate" --}}
                                <label class="custom-checkbox hint combat-checkbox-row">
                                    <input type="checkbox" name="system.duration.inCombat" {{checked system.duration.inCombat}}/>
                                    <span>Contagem apenas em combate.</span>
                                </label>
                            </div>
                        {{/unless}}
                    </div>
                {{/if}}

                        
        {{!-- SEÇÃO DE DESCRIÇÃO --}}
            <div class="form-section">
                <div class="section-header">
                    <h4 class="section-title">Descrição Resumida (para a Tag)</h4>
                    <a class="edit-text-btn" data-target="system.chat_description" title="Editar Descrição Resumida"><i class="fas fa-edit"></i></a>
                </div>
                <div class="rendered-text">
                    {{{enrichedChatDescription}}}
                </div>
            </div>
    </main>
</form>