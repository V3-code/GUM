<form class="{{cssClass}}" autocomplete="off">
    <header class="sheet-header item-header">
        <img class="profile-img" src="{{item.img}}" data-edit="img" title="{{item.name}}"/>
        <div class="header-fields">
            <h1 class="charname"><input name="name" type="text" value="{{item.name}}" placeholder="Nome da Condição"/></h1>
            <div class="form-group-inline">
                <label>Categoria</label>
                <select name="system.category">
                    <option value="general" {{#if (eq system.category 'general')}}selected{{/if}}>Condição Geral</option>
                    <option value="temporary" {{#if (eq system.category 'temporary')}}selected{{/if}}>Efeito Temporário</option>
                </select>
            </div>
        </div>
    </header>

    <main class="sheet-body">
        <div class="sheet-body-content">
            
            {{!-- Seção da Condição de Ativação com TEXTAREA --}}
            <div class="form-section">
                <h4 class="section-title">Condição de Ativação</h4>
                <p class="hint">Regra para aplicar os efeitos. Deixe em branco para ser incondicional.</p>
                {{!-- ✅ INPUT SUBSTITUÍDO POR TEXTAREA ✅ --}}
                <textarea name="system.when" rows="4" placeholder="ex: actor.system.attributes.hp.value <= 10">{{system.when}}</textarea>
                <div class="button-container">
                    <a class="button condition-assistant-btn">
                        <i class="fas fa-magic"></i> Assistente de Condições
                    </a>
                </div>
            </div>

{{!-- Seção de Efeitos Aplicados (VERSÃO FINAL E COMPLETA) --}}
<div class="form-section effects-section">
    <h4 class="section-title">Efeitos Aplicados</h4>
    <div class="effects-list-container">
        {{#each system.effects as |effect effIndex|}}
            <div class="effect-block" data-effect-index="{{effIndex}}">
                <div class="effect-header">
                    <select class="effect-type-selector" name="system.effects.{{effIndex}}.type">
                        <option value="attribute" {{#if (eq effect.type 'attribute')}}selected{{/if}}>Modificar Atributo</option>
                        <option value="status" {{#if (eq effect.type 'status')}}selected{{/if}}>Aplicar Status do Token</option>
                        <option value="macro" {{#if (eq effect.type 'macro')}}selected{{/if}}>Executar Macro</option>
                        <option value="chat" {{#if (eq effect.type 'chat')}}selected{{/if}}>Enviar Mensagem</option>
                    </select>
                    <a class="delete-effect" title="Deletar Efeito"><i class="fas fa-trash"></i></a>
                </div>
                <div class="effect-content">
                    {{!-- Campos para Modificar Atributo --}}
                    {{#if (eq effect.type "attribute")}}
                        <div class="effect-row">
                            <input type="text" name="system.effects.{{effIndex}}.path" value="{{effect.path}}" placeholder="Caminho (ex: system.attributes.dx.temp)"/>
                            <select name="system.effects.{{effIndex}}.operation">
                                <option value="ADD" {{#if (eq effect.operation 'ADD')}}selected{{/if}}>Adicionar</option>
                                <option value="SUB" {{#if (eq effect.operation 'SUB')}}selected{{/if}}>Subtrair</option>
                                <option value="SET" {{#if (eq effect.operation 'SET')}}selected{{/if}}>Definir</option>
                            </select>
                            <input type="text" name="system.effects.{{effIndex}}.value" value="{{effect.value}}" placeholder="Valor"/>
                        </div>
                    {{/if}}

                    {{!-- Campos para Aplicar Status --}}
                    {{#if (eq effect.type "status")}}
                        <div class="form-group-inline path-input-group">
                            <label>ID do Status</label>
                            <input type="text" name="system.effects.{{effIndex}}.statusId" value="{{effect.statusId}}" placeholder="Ex: prone"/>
                            <a class="open-status-picker" title="Selecionar Status"><i class="fas fa-search"></i></a>
                        </div>
                    {{/if}}

                    {{!-- Campo para Executar Macro --}}
                    {{#if (eq effect.type "macro")}}
                        <div class="form-group-inline">
                            <label>Nome da Macro</label>
                            <input type="text" name="system.effects.{{effIndex}}.value" value="{{effect.value}}" placeholder="Nome exato da Macro"/>
                        </div>
                    {{/if}}
                    
                    {{!-- ✅ INTERFACE RESTAURADA PARA MENSAGEM / TESTE ✅ --}}
                    {{#if (eq effect.type "chat")}}
                        <div class="form-group">
                            <label>Texto da Mensagem</label>
                            <textarea name="system.effects.{{effIndex}}.chat_text" rows="2" placeholder="Ex: {actor.name} sente um calafrio!">{{effect.chat_text}}</textarea>
                        </div>
                         <div class="form-group-inline">
                            <label>Visibilidade</label>
                            <select name="system.effects.{{effIndex}}.whisperMode">
                                <option value="public" {{#if (eq effect.whisperMode 'public')}}selected{{/if}}>Público</option>
                                <option value="gm" {{#if (eq effect.whisperMode 'gm')}}selected{{/if}}>Apenas para MJs</option>
                                <option value="blind" {{#if (eq effect.whisperMode 'blind')}}selected{{/if}}>Rolagem Cega</option>
                            </select>
                        </div>
                        <div class="form-group-inline">
                            <label>Incluir Botão de Teste?</label>
                            <input type="checkbox" name="system.effects.{{effIndex}}.has_roll" {{checked effect.has_roll}}/>
                        </div>
                        {{#if effect.has_roll}}
                        <div class="form-grid-3 sub-effect-group">
                            <div class="form-group">
                                <label>Atributo do Teste</label>
                                <select name="system.effects.{{effIndex}}.roll_attribute">
                                    <option value="st.final" {{#if (eq effect.roll_attribute 'st.final')}}selected{{/if}}>ST</option>
                                    <option value="dx.final" {{#if (eq effect.roll_attribute 'dx.final')}}selected{{/if}}>DX</option>
                                    <option value="iq.final" {{#if (eq effect.roll_attribute 'iq.final')}}selected{{/if}}>IQ</option>
                                    <option value="ht.final" {{#if (eq effect.roll_attribute 'ht.final')}}selected{{/if}}>HT</option>
                                    <option value="vont.final" {{#if (eq effect.roll_attribute 'vont.final')}}selected{{/if}}>Vontade</option>
                                    <option value="per.final" {{#if (eq effect.roll_attribute 'per.final')}}selected{{/if}}>Percepção</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Modificador</label>
                                <input type="number" name="system.effects.{{effIndex}}.roll_modifier" value="{{effect.roll_modifier}}" placeholder="0"/>
                            </div>
                            <div class="form-group">
                                <label>Texto do Botão</label>
                                <input type="text" name="system.effects.{{effIndex}}.roll_label" value="{{effect.roll_label}}" placeholder="Rolar Teste"/>
                            </div>
                        </div>
                        {{/if}}
                    {{/if}}
                </div>
            </div>
        {{/each}}
    </div>
    <a class="button add-effect"><i class="fas fa-plus"></i> Adicionar Efeito</a>
</div>

            {{!-- Seção de Descrição (sem alterações) --}}
            <div class="form-section">
                <div class="section-header">
                    <h4 class="section-title">Descrição</h4>
                    <a class="edit-text-btn" data-target="system.description" title="Editar Descrição"><i class="fas fa-edit"></i></a>
                </div>
                <div class="rendered-text">
                    {{{enrichedDescription}}}
                </div>
            </div>

        </div>
    </main>
</form>