<form class="{{cssClass}} gum-item-sheet condition-sheet" autocomplete="off">

    {{!-- CABEÇALHO ALINHADO AO PADRÃO DOS ITENS --}}
    <header class="sheet-header">
        <img class="profile-img" src="{{item.img}}" data-edit="img" title="{{item.name}}"/>
        <div class="header-info">
            <div class="header-main-line">
                <textarea name="name" rows="1" placeholder="Nome da Condição">{{item.name}}</textarea>
                <span class="item-tag small-tag">Condição</span>
            </div>
        </div>
    </header>

    <section class="sheet-content">

        {{!-- NAVEGAÇÃO DAS ABAS --}}
        <nav class="sheet-tabs tabs" data-group="primary">
            <a class="item" data-tab="description">Descrição</a>
            <a class="item" data-tab="gatilho">Gatilho</a>
            <a class="item" data-tab="effects">Efeitos</a>
        </nav>

        <section class="sheet-body-content">

            {{!-- ABA: DESCRIÇÃO (MODELO PADRÃO) --}}
            <div class="tab" data-group="primary" data-tab="description">
                <div class="description-tab">
                    <div class="description-hero">
                        <div class="hero-text">
                            <p class="eyebrow">Narrativa & Referência</p>
                            <h3>Descrição da Condição</h3>
                            <p class="hint">Mantenha um resumo rápido para o chat e uma versão completa para consultas detalhadas.</p>
                        </div>
                        <div class="hero-meta">
                            <div class="meta-chip">
                                <i class="fas fa-book-open"></i>
                                <span>Resumo (Chat)</span>
                            </div>
                            <div class="meta-chip">
                                <i class="fas fa-scroll"></i>
                                <span>Completa</span>
                            </div>
                        </div>
                    </div>

                    <div class="description-grid">
                        <div class="form-section description-section">
                            <div class="description-header">
                                <div>
                                    <h4 class="section-title">Descrição Resumida (Chat)</h4>
                                    <p class="hint">Use para tooltips e mensagens rápidas.</p>
                                </div>
                                {{#if editable}}
                                <div class="description-actions">
                                    <button type="button" class="toggle-editor" data-field="system.chat_description">
                                        <i class="fas fa-pen"></i> Editar
                                    </button>
                                </div>
                                {{/if}}
                            </div>
                            <div class="description-view">{{{enrichedChatDescription}}}</div>

                            <div class="description-editor" style="display:none;">
                                {{editor system.chat_description target="system.chat_description" engine="prosemirror" owner=owner editable=editable}}
                                <div class="description-actions">
                                    <button type="button" class="save-description" data-field="system.chat_description"><i class="fas fa-save"></i> Salvar</button>
                                    <button type="button" class="expand-description" data-expanded="false"><i class="fas fa-expand"></i> Expandir</button>
                                    <button type="button" class="cancel-description"><i class="fas fa-times"></i> Cancelar</button>
                                </div>
                            </div>
                        </div>

                        <div class="form-section description-section">
                            <div class="description-header">
                                <div>
                                    <h4 class="section-title">Descrição Completa</h4>
                                    <p class="hint">Inclua detalhes extensos, efeitos narrativos e referências.</p>
                                </div>
                                {{#if editable}}
                                <div class="description-actions">
                                    <button type="button" class="toggle-editor" data-field="system.description">
                                        <i class="fas fa-pen"></i> Editar
                                    </button>
                                </div>
                                {{/if}}
                            </div>
                            <div class="description-view">{{{enrichedDescription}}}</div>

                            <div class="description-editor" style="display:none;">
                                {{editor system.description target="system.description" engine="prosemirror" owner=owner editable=editable}}
                                <div class="description-actions">
                                    <button type="button" class="save-description" data-field="system.description"><i class="fas fa-save"></i> Salvar</button>
                                    <button type="button" class="expand-description" data-expanded="false"><i class="fas fa-expand"></i> Expandir</button>
                                    <button type="button" class="cancel-description"><i class="fas fa-times"></i> Cancelar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {{!-- ABA: GATILHO --}}
            <div class="tab" data-group="primary" data-tab="gatilho">
                <section class="form-section condition-card">
                    <div class="section-header">
                        <div>
                            <p class="eyebrow">Regra de ativação</p>
                            <h4 class="section-title">Gatilho</h4>
                        </div>
                        <span class="section-tag">JavaScript</span>
                    </div>
                    <p class="hint">Regra para aplicar os efeitos. Deixe em branco para ser incondicional.</p>
                    <div class="condition-input-area">
                        <textarea name="system.when" rows="6" placeholder="ex: actor.system.attributes.hp.value <= 10">{{system.when}}</textarea>
                        <div class="button-group">
                            <a class="button saved-triggers-btn" title="Buscar Gatilho Salvo">
                                <i class="fas fa-bookmark"></i>
                                Gatilhos Salvos
                            </a>
                            <a class="button condition-assistant-btn" title="Assistente de Condições">
                                <i class="fas fa-magic"></i>
                                Assistente de Construção
                            </a>
                        </div>
                    </div>
                </section>
            </div>

            {{!-- ABA: EFEITOS --}}
            <div class="tab" data-group="primary" data-tab="effects">

                <section class="form-section condition-card">
                    <div class="section-header">
                        <div>
                            <p class="eyebrow">Ferramenta do Mestre</p>
                            <h4 class="section-title">Classificação da Condição</h4>
                        </div>
                    </div>
                     <div class="duration-block">
                            
                            <div class="radio-group">
                                <label class="grid-label">Classificação</label>
                                <label class="custom-radio" title="Para regras globais e estados persistentes definidos pelo mestre (Ex: Choque, Cambaleando).">
                                    <input type="radio" name="system.category" value="general" {{checked (eq system.category 'general')}}>
                                    <span>Condição Padrão</span>
                                </label>
                                <label class="custom-radio" title="Um estado temporário, geralmente de curta duração e aplicado em situações como o combate.">
                                    <input type="radio" name="system.category" value="temporary" {{checked (eq system.category 'temporary')}}>
                                    <span>Condição Temporária</span>
                                </label>
                            </div>
                        </div>
                </section>

                <section class="form-section condition-card">
                    <div class="section-header">
                        <div>
                            <p class="eyebrow">Controle de tempo</p>
                            <h4 class="section-title">Duração</h4>
                        </div>
                        <span class="section-tag subtle">Condição</span>
                    </div>
                    <div>
                            <label class="custom-checkbox combat-checkbox-row">
                                <input type="checkbox" name="system.duration.inCombat" {{checked system.duration.inCombat}}/>
                                <span>Duração contada apenas em combate.</span>
                            </label>
                    </div>
                    <div class="condition-duration-grid">
                        <div class="duration-block">
                            <div class="duration-inline-group">
                                <label class="grid-label">Duração</label>
                                <div class="input-group">
                                    <input class="duration-value" type="number" name="system.duration.value" value="{{system.duration.value}}" min="0" placeholder="0"/>
                                    <select name="system.duration.unit">
                                        <option value="unlimited" {{#if (eq system.duration.unit "unlimited")}}selected{{/if}}>Indefinido</option>
                                        <option value="rounds" {{#if (eq system.duration.unit "rounds")}}selected{{/if}}>Rodadas</option>
                                        <option value="seconds" {{#if (eq system.duration.unit "seconds")}}selected{{/if}}>Segundos</option>
                                        <option value="minutes" {{#if (eq system.duration.unit "minutes")}}selected{{/if}}>Minutos</option>
                                        <option value="hours" {{#if (eq system.duration.unit "hours")}}selected{{/if}}>Horas</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="duration-block">

                                <div class="radio-group horizontal">
                                    <label class="grid-label">Ao Expirar:</label>
                                    <label class="custom-radio" title="O item será removido permanentemente da ficha do ator.">
                                        <input type="radio" name="system.duration.expiration" value="delete" {{checked (eq system.duration.expiration 'delete')}}>
                                        <span>Deletar Item</span>
                                    </label>
                                    <label class="custom-radio" title="O item será desativado (marcado com um cadeado na ficha do ator), mas não removido.">
                                        <input type="radio" name="system.duration.expiration" value="disable" {{checked (eq system.duration.expiration 'disable')}}>
                                        <span>Desativar Item</span>
                                    </label>
                                </div>

                        </div>
                    </div>
                </section>

                <section class="form-section condition-card">
                    <div class="section-header">
                        <div>
                            <p class="eyebrow">Vínculo de efeitos</p>
                            <h4 class="section-title">Gerenciador de Efeitos</h4>
                        </div>
                     <a class="button item-add-button add-effect"><i class="fas fa-plus"></i> Adicionar</a>
                    </div>
                    <p class="hint">Use o buscador para anexar efeitos existentes a esta condição.</p>

                    <div class="effect-group">
                        <div class="group-header">
                            <div class="group-heading">
                                <h5 class="group-title"><i class="fas fa-link"></i> Efeitos Vinculados</h5>
                                <p class="group-subtitle">Lista de efeitos atualmente associados.</p>
                            </div>
  
                        </div>
                        {{#if preparedEffects.length}}
                        <ol class="effects-list">
                            {{#each preparedEffects as |effect|}}
                                <li class="effect-entry" data-effect-index="{{effect.index}}" data-effect-uuid="{{effect.uuid}}">
                                    <div class="effect-header">
                                        <div class="effect-main">
                                            <img src="{{effect.img}}" class="effect-icon"/>
                                            <div class="effect-text">
                                                <span class="effect-name">{{effect.name}}</span>
                                                <span class="effect-context">{{capitalize effect.type}}</span>
                                            </div>
                                        </div>
                                        <div class="effect-controls">
                                            <a class="view-effect" title="Ver Item Efeito Original"><i class="fas fa-eye"></i></a>
                                            <a class="delete-effect" title="Remover Link do Efeito"><i class="fas fa-trash"></i></a>
                                        </div>
                                    </div>
                                    {{#if effect.summary}}
                                        <div class="effect-summary-line">{{effect.summary}}</div>
                                    {{/if}}
                                    {{#if effect.chat_description}}
                                        <div class="effect-summary-line muted">"{{effect.chat_description}}"</div>
                                    {{/if}}
                                </li>
                            {{/each}}
                        </ol>
                        {{else}}
                            <p class="empty-hint">Nenhum efeito vinculado.</p>
                        {{/if}}
                    </div>
                </section>
            </div>

        </section>
    </section>

</form>