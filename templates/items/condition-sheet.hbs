<form class="{{cssClass}}" autocomplete="off">
    <header class="sheet-header item-header">
        <img class="profile-img" src="{{item.img}}" data-edit="img" title="{{item.name}}"/>
        <div class="header-fields">
            <h1 class="charname"><input name="name" type="text" value="{{item.name}}" placeholder="Nome da Condição"/></h1>
            <div class="form-group-inline">
                <label>Categoria</label>
                <select name="system.category">
                    <option value="general" {{#if (eq system.category 'general')}}selected{{/if}}>Condição Geral</option>
                    <option value="temporary" {{#if (eq system.category 'temporary')}}selected{{/if}}>Efeito Temporário</option>
                </select>
            </div>
        </div>
    </header>

    <main class="sheet-body">
        <div class="sheet-body-content">

            {{!-- Seção de Duração e Expiração (VERSÃO REFINADA) --}}
<div class="form-section">
    <h4 class="section-title">Duração e Expiração</h4>
    <div class="form-grid-3">
        <div class="form-group">
            <label>Duração</label>
            <input type="number" name="system.duration.value" value="{{system.duration.value}}" min="0" placeholder="0"/>
        </div>

        <div class="form-group">
            <label>Unidade</label>
            <select name="system.duration.unit">
                <option value="unlimited" {{#if (eq system.duration.unit "unlimited")}}selected{{/if}}>Ilimitada</option>
                <option value="rounds" {{#if (eq system.duration.unit "rounds")}}selected{{/if}}>Rodadas</option>
                <option value="seconds" {{#if (eq system.duration.unit "seconds")}}selected{{/if}}>Segundos</option>
                <option value="minutes" {{#if (eq system.duration.unit "minutes")}}selected{{/if}}>Minutos</option>
                <option value="hours" {{#if (eq system.duration.unit "hours")}}selected{{/if}}>Horas</option>
            </select>
        </div>

        <div class="form-group">
            <label>Ao Expirar</label>
            <select name="system.duration.expiration">
                <option value="delete" {{#if (eq system.duration.expiration "delete")}}selected{{/if}}>Deletar Item</option>
                <option value="disable" {{#if (eq system.duration.expiration "disable")}}selected{{/if}}>Desativar Item</option>
            </select>
        </div>
    </div>

    <div class="form-group-inline">
        <input type="checkbox" name="system.duration.inCombat" {{checked system.duration.inCombat}}/>
        <label class="hint">A duração só é contada durante o combate?</label>
    </div>
</div>
            
            {{!-- Seção da Condição de Ativação com TEXTAREA --}}
            <div class="form-section">
                <h4 class="section-title">Condição de Ativação</h4>
                <p class="hint">Regra para aplicar os efeitos. Deixe em branco para ser incondicional.</p>
                {{!-- ✅ INPUT SUBSTITUÍDO POR TEXTAREA ✅ --}}
                <textarea name="system.when" rows="4" placeholder="ex: actor.system.attributes.hp.value <= 10">{{system.when}}</textarea>
                <div class="button-container">
                    <a class="button condition-assistant-btn">
                        <i class="fas fa-magic"></i> Assistente de Condições
                    </a>
                </div>
            </div>

{{!-- Seção de Efeitos Aplicados (VERSÃO FINAL E COMPLETA) --}}
<div class="form-section effects-section">
    <h4 class="section-title">Efeitos Aplicados</h4>
    <div class="effects-list-container">
        {{#each system.effects as |effect effIndex|}}
            <div class="effect-summary" data-effect-index="{{effIndex}}">
                <div class="effect-summary-info">
                    <strong class="effect-type-label">{{capitalize effect.type}}</strong>
                    <span class="effect-details">
                        {{#if (eq effect.type 'attribute')}}{{effect.path}} {{effect.operation}} {{effect.value}}{{/if}}
                        {{#if (eq effect.type 'status')}}{{effect.statusId}}{{/if}}
                        {{#if (eq effect.type 'macro')}}Macro: {{effect.value}}{{/if}}
                        
                        {{!-- ✅ LÓGICA DE EXIBIÇÃO APRIMORADA ✅ --}}
                        {{#if (eq effect.type 'chat')}}
                            "{{effect.chat_text}}"
                            {{#if effect.has_roll}}
                                <span class="roll-summary-tag">(Teste: {{effect.roll_attribute}} {{#if effect.roll_modifier}}vs {{effect.roll_modifier}}{{/if}})</span>
                            {{/if}}
                        {{/if}}
                    </span>
                </div>
                <div class="effect-controls">
                    <a class="edit-effect" title="Editar Efeito"><i class="fas fa-edit"></i></a>
                    <a class="delete-effect" title="Deletar Efeito"><i class="fas fa-trash"></i></a>
                </div>
            </div>
        {{/each}}
        {{#unless system.effects.length}}
            <p class="hint">Nenhum efeito adicionado.</p>
        {{/unless}}
    </div>
    <a class="button add-effect"><i class="fas fa-plus"></i> Adicionar Efeito</a>
</div>

            {{!-- Seção de Descrição (sem alterações) --}}
            <div class="form-section">
                <div class="section-header">
                    <h4 class="section-title">Descrição</h4>
                    <a class="edit-text-btn" data-target="system.description" title="Editar Descrição"><i class="fas fa-edit"></i></a>
                </div>
                <div class="rendered-text">
                    {{{enrichedDescription}}}
                </div>
            </div>

        </div>
    </main>
</form>