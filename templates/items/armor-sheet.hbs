{{!-- =================================================================== --}}
{{!--           FICHA DE ARMADURA (GURPS ARMOR SHEET) v2                --}}
{{!-- =================================================================== --}}

{{!-- 1. PARTIAL: DETALHES GERAIS (Atualizado com Custo/Peso Calculados e Novos Campos) --}}
{{#*inline "itemDetailsGeneral"}}
    <div class="form-section"><h4 class="section-title">Geral</h4>
        <div class="form-grid-3">
            <div class="form-group input-narrow"><label>Quantidade</label><input type="number" name="system.quantity" value="{{system.quantity}}"/></div>
            
            {{!-- PESO COM CÁLCULO --}}
            <div class="form-group input-narrow">
                <label>Peso (kg)</label>
                {{#if hasWeightChange}}
                    <div class="calculated-value-group" style="display:flex; gap:5px; align-items:center;">
                        <input type="number" step="0.01" name="system.weight" value="{{system.weight}}" style="width: 50px; opacity: 0.7;" title="Peso Base"/>
                        <i class="fas fa-arrow-right" style="font-size: 0.8em; color: #666;"></i>
                        <span style="font-weight:bold; color: #c5a05b;" title="Peso Final">{{finalWeightString}}</span>
                    </div>
                {{else}}
                    <input type="number" step="0.01" name="system.weight" value="{{system.weight}}"/>
                {{/if}}
            </div>

            {{!-- CUSTO COM CÁLCULO --}}
            <div class="form-group input-narrow">
                <label>Custo ($)</label>
                {{#if hasCostChange}}
                    <div class="calculated-value-group" style="display:flex; gap:5px; align-items:center;">
                        <input type="number" name="system.cost" value="{{system.cost}}" style="width: 50px; opacity: 0.7;" title="Custo Base"/>
                        <i class="fas fa-arrow-right" style="font-size: 0.8em; color: #666;"></i>
                        <span style="font-weight:bold; color: #c5a05b;" title="Custo Final">{{finalCostString}}</span>
                    </div>
                {{else}}
                    <input type="number" name="system.cost" value="{{system.cost}}"/>
                {{/if}}
            </div>
        </div>
        <div class="form-grid-3">
            <div class="form-group input-narrow"><label title="Nível Tecnológico">NT</label><input type="text" name="system.tech_level" value="{{system.tech_level}}"/></div>
            <div class="form-group input-narrow"><label title="Classe de Legalidade">CL</label><input type="text" name="system.legality_class" value="{{system.legality_class}}"/></div>
            
            <div class="form-group input-narrow">
                <label title="Livro e Página de Referência"><a class="open-reference-link" title="Abrir Referência"><i class="fas fa-book-open"></i></a> - REF</label>
                <div class="input-with-button">
                    <input type="text" name="system.ref" value="{{system.ref}}"/>
                    
                </div>
            </div>
        </div>
    </div>

    {{!-- SEÇÃO: PROPRIEDADES FÍSICAS (NOVA) --}}
    <div class="form-section"><h4 class="section-title">Propriedades Físicas</h4>
        <div class="form-grid-4">
            <div class="form-group input-narrow" title="Modificador de Tamanho (SM)">
                <label>MT (SM)</label>
                <input type="number" name="system.tech_sm" value="{{system.tech_sm}}" placeholder="+0"/>
            </div>
            <div class="form-group input-narrow" title="Resistência a Dano do próprio Item">
                <label>RD Item</label>
                <input type="number" name="system.item_dr" value="{{system.item_dr}}"/>
            </div>
            <div class="form-group input-narrow" title="Pontos de Vida do Item">
                <label>PV Item</label>
                <input type="number" name="system.item_hp" value="{{system.item_hp}}"/>
            </div>
            <div class="form-group input-narrow" title="Vitalidade (HT) do Item">
                <label>HT Item</label>
                <input type="number" name="system.item_ht" value="{{system.item_ht}}"/>
            </div>
        </div>
    </div>

    {{!-- SEÇÃO: USO E LOGÍSTICA (NOVA) --}}
    <div class="form-section"><h4 class="section-title">Uso & Defesa</h4>
        <div class="form-grid-3">
            <div class="form-group input-narrow" title="Penalidade de Ocultamento (Holdout)">
                <label>Ocultar</label>
                <input type="number" name="system.holdout" value="{{system.holdout}}" placeholder="0"/>
            </div>
            <div class="form-group input-narrow" title="Tempo para equipar/vestir em segundos">
                <label>T. Vestir (s)</label>
                <input type="number" name="system.equip_time" value="{{system.equip_time}}"/>
            </div>
            <div class="form-group input-narrow" title="Bônus de Defesa (DB) para Escudos ou Capas">
                <label>DB (Escudo)</label>
                <input type="number" name="system.defense_bonus" value="{{system.defense_bonus}}"/>
            </div>
        </div>
        <div class="form-grid-2" style="margin-top: 10px;">
             <div class="form-group"><label>Qualidade</label><input type="text" name="system.quality" value="{{system.quality}}" placeholder="Ex: Fina, Barata"/></div>
             <div class="form-group"><label>Material</label><input type="text" name="system.material" value="{{system.material}}" placeholder="Ex: Aço, Madeira"/></div>
        </div>
    </div>
{{/inline}}

{{!-- 2. PARTIAL: EFEITOS (Copiado para garantir funcionamento inline) --}}
{{#*inline "effectsTab"}}
    <div class="form-section effect-category">
        <h4 class="section-title">Efeitos Passivos</h4>
        <p class="hint">Aplicados automaticamente enquanto a armadura estiver EQUIPADA.</p>
        <div class="effect-group passive"> 
            <div class="group-header">
                <a class="button add-effect" data-target-list="passiveEffects" title="Adicionar Efeito Passivo"><i class="fas fa-plus"></i> Adicionar Efeito Passivo</a>
            </div>
            <ol class="effects-list">
                {{#each system.preparedEffects.passive as |effect|}}
                    <li class="effect-entry" data-list-name="passiveEffects" data-effect-id="{{effect.id}}">
                        <div class="effect-header">
                            <img src="{{effect.img}}" class="effect-icon"/>
                            <span class="effect-name">{{effect.name}}</span>
                            <div class="effect-controls">
                                <a class="view-original-effect" title="Ver Efeito Original" data-uuid="{{effect.uuid}}"><i class="fas fa-eye"></i></a>
                                <a class="delete-effect" title="Remover Efeito"><i class="fas fa-trash"></i></a>
                            </div>
                        </div>
                    </li>
                {{else}}
                    <p class="hint small">Nenhum efeito passivo definido.</p>
                {{/each}}
            </ol>
        </div>
    </div>
    {{!-- Você pode adicionar as outras seções de efeitos aqui se desejar, mas para armadura "Passivo" é o principal --}}
{{/inline}}

{{!-- =================================================================== --}}
{{!-- 3. ESTRUTURA PRINCIPAL DA FICHA                                   --}}
{{!-- =================================================================== --}}
<form class="{{cssClass}} gum-item-sheet" autocomplete="off">

<header class="sheet-header">
  <img class="profile-img" src="{{item.img}}" data-edit="img" title="{{item.name}}" />
  <div class="header-info">
    <div class="header-main-line">
      <textarea name="name" rows="1" placeholder="Nome da Armadura">{{item.name}}</textarea>
      <span class="item-tag small-tag">Armadura</span>
    </div>
  </div>
</header>

<section class="sheet-content">

  {{!-- NAVEGAÇÃO: Inclui a nova aba "Mods" --}}
  <nav class="sheet-tabs tabs" data-group="primary">
      <a class="item" data-tab="details">Detalhes</a>
      <a class="item" data-tab="description">Descrição</a>
      <a class="item" data-tab="protection">Proteção</a>
      <a class="item" data-tab="eqp_modifiers">Mods</a> {{!-- ✅ NOVA ABA --}}
      <a class="item" data-tab="effects">Efeitos</a>
  </nav>

  <section class="sheet-body-content">

    {{!-- ABA: DETALHES --}}
    <div class="tab" data-tab="details">
        {{> itemDetailsGeneral}}
    </div>

    {{!-- ABA: DESCRIÇÃO --}}
    <div class="tab" data-tab="description">
      <div class="form-section description-section">
        <h4 class="section-title">Descrição Resumida (Chat)</h4>
        <div class="description-view">{{{system.chat_description}}}</div>
        <button type="button" class="toggle-editor" data-field="system.chat_description">Editar</button>
        <div class="description-editor" style="display:none;">
          {{editor system.chat_description target="system.chat_description" owner=owner editable=editable}}
          <button type="button" class="save-description" data-field="system.chat_description">Salvar</button>
          <button type="button" class="cancel-description">Cancelar</button>
        </div>
      </div>
      <div class="form-section description-section">
        <h4 class="section-title">Descrição Completa</h4>
        <div class="description-view">{{{system.description}}}</div>
        <button type="button" class="toggle-editor" data-field="system.description">Editar</button>
        <div class="description-editor" style="display:none;">
          {{editor system.description target="system.description" owner=owner editable=editable}}
          <button type="button" class="save-description" data-field="system.description">Salvar</button>
          <button type="button" class="cancel-description">Cancelar</button>
        </div>
      </div>
    </div>

    {{!-- ABA: PROTEÇÃO (Específica da Armadura) --}}
    <div class="tab" data-tab="protection">
        <div class="form-section">
            <h4 class="section-title">Proteção por Localização</h4>
            <p class="hint" style="margin-top: 5px; font-size: 12px; opacity: 0.8; text-align: center;">
                Digite a RD para cada local. (ex: <code>5</code>, <code>5, 2 cont</code>, <code>3 pi++</code>).
            </p>
            
            <div class="hit-locations-grid-inputs" style="margin-top: 15px;">
                {{!-- Loop pelos 15 locais de acerto --}}
                {{#each (array "head" "face" "eyes" "neck" "torso" "vitals" "groin" "arm_l" "arm_r" "hand_l" "hand_r" "leg_l" "leg_r" "foot_l" "foot_r") as |loc|}}
                    <div class="form-group form-group-small">
                        <label>{{lookup (object 
                            head="Crânio" face="Rosto" eyes="Olhos" neck="Pescoço" torso="Torso" vitals="Órg. Vitais" groin="Virilha" 
                            arm_l="Braço E" arm_r="Braço D" hand_l="Mão E" hand_r="Mão D" 
                            leg_l="Perna E" leg_r="Perna D" foot_l="Pé E" foot_r="Pé D"
                        ) loc}}</label>
                        <input type="text" name="system.dr_locations.{{loc}}" value="{{lookup ../formattedDrLocations loc}}" />
                    </div>
                {{/each}}
            </div>
        </div>
    </div>

    {{!-- ABA: MODIFICADORES DE EQUIPAMENTO (NOVA) --}}
    <div class="tab" data-tab="eqp_modifiers">
        <div class="modifiers-toolbar">
            <a class="add-eqp-modifier button"><i class="fas fa-plus"></i> Adicionar Modificador</a>
        </div>

        <div class="form-section">
            <p class="hint">Adicione qualidades, materiais ou modificações mágicas aqui. O Custo Final e Peso serão recalculados automaticamente.</p>
            
            <ol class="modifier-list">
                {{#each eqpModifiersList as |mod|}}
                    <li class="modifier-tag" data-modifier-id="{{mod.id}}" style="background: rgba(0,0,0,0.2); border: 1px solid #777;">
                        <div class="modifier-info" style="flex-grow: 1;">
                            <span class="modifier-name">{{mod.name}}</span>
                            <span class="modifier-divider">|</span>
                            <span class="modifier-effect" style="font-size: 0.85em; color: #ccc;">
                                CF {{#if (gt mod.cost_factor 0)}}+{{/if}}{{mod.cost_factor}} • Peso {{mod.weight_mod}}
                            </span>
                        </div>
                        <div class="modifier-controls">
                            {{!-- ✅ Botão de View --}}
                            <a class="view-eqp-modifier" title="Ver Detalhes" style="margin-right: 5px;"><i class="fas fa-eye"></i></a>
                            <a class="delete-eqp-modifier" title="Remover"><i class="fas fa-trash"></i></a>
                        </div>
                    </li>
                {{else}}
                    <li class="placeholder-text">
                        <p>Nenhum modificador de equipamento aplicado.</p>
                    </li>
                {{/each}}
            </ol>
        </div>
        
        {{!-- Exibição dos Efeitos de Texto dos Mods --}}
        {{#if eqpModifiersList}}
        <div class="form-section" style="margin-top: 10px;">
            <h4 class="section-title">Resumo dos Efeitos</h4>
            <ul style="padding-left: 20px; margin: 5px 0; color: #ccc; font-size: 0.9em;">
                {{#each eqpModifiersList as |mod|}}
                    {{#if mod.features}}
                        <li><strong>{{mod.name}}:</strong> {{mod.features}}</li>
                    {{/if}}
                {{/each}}
            </ul>
        </div>
        {{/if}}
    </div>

    {{!-- ABA: EFEITOS --}}
    <div class="tab" data-tab="effects">
        {{> effectsTab}}
    </div>

  </section> 
</section> 
</form>