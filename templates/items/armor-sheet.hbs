{{!-- =================================================================== --}}
{{!--           FICHA DE ARMADURA (GURPS ARMOR SHEET) v2                --}}
{{!-- =================================================================== --}}

{{!-- 1. PARTIAL: DETALHES GERAIS (Atualizado com Custo/Peso Calculados e Novos Campos) --}}
{{#*inline "itemDetailsGeneral"}}
    <div class="form-section"><h4 class="section-title">Geral</h4>
        <div class="form-grid-3">
            <div class="form-group input-narrow"><label>Quantidade</label><input type="number" name="system.quantity" value="{{system.quantity}}"/></div>
            
            {{!-- PESO COM CÁLCULO --}}
            <div class="form-group input-narrow">
                <label>Peso (kg)</label>
                {{#if hasWeightChange}}
                    <div class="calculated-value-group" style="display:flex; gap:5px; align-items:center;">
                        <input type="number" step="0.01" name="system.weight" value="{{system.weight}}" style="width: 50px; opacity: 0.7;" title="Peso Base"/>
                        <i class="fas fa-arrow-right" style="font-size: 0.8em; color: #666;"></i>
                        <span style="font-weight:bold; color: #c5a05b;" title="Peso Final">{{finalWeightString}}</span>
                    </div>
                {{else}}
                    <input type="number" step="0.01" name="system.weight" value="{{system.weight}}"/>
                {{/if}}
            </div>

            {{!-- CUSTO COM CÁLCULO --}}
            <div class="form-group input-narrow">
                <label>Custo ($)</label>
                {{#if hasCostChange}}
                    <div class="calculated-value-group" style="display:flex; gap:5px; align-items:center;">
                        <input type="number" name="system.cost" value="{{system.cost}}" style="width: 50px; opacity: 0.7;" title="Custo Base"/>
                        <i class="fas fa-arrow-right" style="font-size: 0.8em; color: #666;"></i>
                        <span style="font-weight:bold; color: #c5a05b;" title="Custo Final">{{finalCostString}}</span>
                    </div>
                {{else}}
                    <input type="number" name="system.cost" value="{{system.cost}}"/>
                {{/if}}
            </div>
        </div>
        <div class="form-grid-3">
            <div class="form-group input-narrow"><label title="Nível Tecnológico">NT</label><input type="text" name="system.tech_level" value="{{system.tech_level}}"/></div>
            <div class="form-group input-narrow"><label title="Classe de Legalidade">CL</label><input type="text" name="system.legality_class" value="{{system.legality_class}}"/></div>
            
            <div class="form-group input-narrow">
                <label title="Livro e Página de Referência"><a class="open-reference-link" title="Abrir Referência"><i class="fas fa-book-open"></i></a> - REF</label>
                <div class="input-with-button">
                    <input type="text" name="system.ref" value="{{system.ref}}"/>
                    
                </div>
            </div>
        </div>
    </div>

    {{!-- SEÇÃO: PROPRIEDADES FÍSICAS (NOVA) --}}
    <div class="form-section"><h4 class="section-title">Propriedades Físicas</h4>
        <div class="form-grid-4">
            <div class="form-group input-narrow" title="Modificador de Tamanho (SM)">
                <label>MT (SM)</label>
                <input type="number" name="system.tech_sm" value="{{system.tech_sm}}" placeholder="+0"/>
            </div>
            <div class="form-group input-narrow" title="Resistência a Dano do próprio Item">
                <label>RD Item</label>
                <input type="number" name="system.item_dr" value="{{system.item_dr}}"/>
            </div>
            <div class="form-group input-narrow" title="Pontos de Vida do Item">
                <label>PV Item</label>
                <input type="number" name="system.item_hp" value="{{system.item_hp}}"/>
            </div>
            <div class="form-group input-narrow" title="Vitalidade (HT) do Item">
                <label>HT Item</label>
                <input type="number" name="system.item_ht" value="{{system.item_ht}}"/>
            </div>
        </div>
    </div>

    {{!-- SEÇÃO: USO E LOGÍSTICA (NOVA) --}}
    <div class="form-section"><h4 class="section-title">Uso & Defesa</h4>
        <div class="form-grid-3">
            <div class="form-group input-narrow" title="Penalidade de Ocultamento (Holdout)">
                <label>Ocultar</label>
                <input type="number" name="system.holdout" value="{{system.holdout}}" placeholder="0"/>
            </div>
            <div class="form-group input-narrow" title="Tempo para equipar/vestir em segundos">
                <label>T. Vestir (s)</label>
                <input type="number" name="system.equip_time" value="{{system.equip_time}}"/>
            </div>
            <div class="form-group input-narrow" title="Bônus de Defesa (DB) para Escudos ou Capas">
                <label>DB (Escudo)</label>
                <input type="number" name="system.defense_bonus" value="{{system.defense_bonus}}"/>
            </div>
        </div>
        <div class="form-grid-2" style="margin-top: 10px;">
             <div class="form-group"><label>Qualidade</label><input type="text" name="system.quality" value="{{system.quality}}" placeholder="Ex: Fina, Barata"/></div>
             <div class="form-group"><label>Material</label><input type="text" name="system.material" value="{{system.material}}" placeholder="Ex: Aço, Madeira"/></div>
        </div>
    </div>
{{/inline}}

{{!-- 2. PARTIAL: EFEITOS (Copiado para garantir funcionamento inline) --}}
{{#*inline "effectsTab"}}
    <div class="form-section effect-category">
        <h4 class="section-title">Efeitos Passivos</h4>
        <p class="hint">Aplicados automaticamente enquanto a armadura estiver EQUIPADA.</p>
        <div class="effect-group passive"> 
            <div class="group-header">
                <a class="button add-effect" data-target-list="passiveEffects" title="Adicionar Efeito Passivo"><i class="fas fa-plus"></i> Adicionar Efeito Passivo</a>
            </div>
            <ol class="effects-list">
                {{#each system.preparedEffects.passive as |effect|}}
                    <li class="effect-entry" data-list-name="passiveEffects" data-effect-id="{{effect.id}}">
                        <div class="effect-header">
                            <img src="{{effect.img}}" class="effect-icon"/>
                            <span class="effect-name">{{effect.name}}</span>
                            <div class="effect-controls">
                                <a class="view-original-effect" title="Ver Efeito Original" data-uuid="{{effect.uuid}}"><i class="fas fa-eye"></i></a>
                                <a class="delete-effect" title="Remover Efeito"><i class="fas fa-trash"></i></a>
                            </div>
                        </div>
                    </li>
                {{else}}
                    <p class="hint small">Nenhum efeito passivo definido.</p>
                {{/each}}
            </ol>
        </div>
    </div>
    {{!-- Você pode adicionar as outras seções de efeitos aqui se desejar, mas para armadura "Passivo" é o principal --}}
{{/inline}}

{{!-- =================================================================== --}}
{{!-- 3. ESTRUTURA PRINCIPAL DA FICHA                                   --}}
{{!-- =================================================================== --}}
<form class="{{cssClass}} gum-item-sheet" autocomplete="off">

<header class="sheet-header">
  <img class="profile-img" src="{{item.img}}" data-edit="img" title="{{item.name}}" />
  <div class="header-info">
    <div class="header-main-line">
      <textarea name="name" rows="1" placeholder="Nome da Armadura">{{item.name}}</textarea>
      <span class="item-tag small-tag">Armadura</span>
    </div>
  </div>
</header>

<section class="sheet-content">

  {{!-- NAVEGAÇÃO: Inclui a nova aba "Mods" --}}
  <nav class="sheet-tabs tabs" data-group="primary">
      <a class="item" data-tab="details">Detalhes</a>
      <a class="item" data-tab="description">Descrição</a>
      <a class="item" data-tab="protection">Proteção</a>
      <a class="item" data-tab="eqp_modifiers">Mods</a> {{!-- ✅ NOVA ABA --}}
      <a class="item" data-tab="effects">Efeitos</a>
  </nav>

  <section class="sheet-body-content">

    {{!-- ABA: DETALHES --}}
    <div class="tab" data-tab="details">
        {{> itemDetailsGeneral}}
    </div>

    {{!-- ABA: DESCRIÇÃO --}}
    <div class="tab" data-tab="description">
      <div class="description-tab">
        <div class="description-grid">
          <div class="form-section description-section">
            <div class="description-header">
              <div>
                <h4 class="section-title">Descrição Resumida (Chat)</h4>
                <p class="hint">Use para tooltips e mensagens rápidas.</p>
              </div>
              {{#if editable}}
              <div class="description-actions">
                <button type="button" class="toggle-editor" data-field="system.chat_description">
                  <i class="fas fa-pen"></i> Editar
                </button>
              </div>
              {{/if}}
            </div>
            <div class="description-view">{{{system.chat_description}}}</div>

                        <div class="description-editor" style="display:none;">
              {{editor system.chat_description target="system.chat_description" engine="prosemirror" owner=owner editable=editable}}
              <div class="description-actions">
                <button type="button" class="save-description" data-field="system.chat_description"><i class="fas fa-save"></i> Salvar</button>
                <button type="button" class="expand-description" data-expanded="false"><i class="fas fa-expand"></i> Expandir</button>
                <button type="button" class="cancel-description"><i class="fas fa-times"></i> Cancelar</button>
              </div>
            </div>
          </div>

          <div class="form-section description-section">
            <div class="description-header">
              <div>
                <h4 class="section-title">Descrição Completa</h4>
                <p class="hint">Inclua detalhes extensos, efeitos narrativos e referências.</p>
              </div>
              {{#if editable}}
              <div class="description-actions">
                <button type="button" class="toggle-editor" data-field="system.description">
                  <i class="fas fa-pen"></i> Editar
                </button>
              </div>
              {{/if}}
            </div>
            <div class="description-view">{{{system.description}}}</div>

            <div class="description-editor" style="display:none;">
              {{editor system.description target="system.description" engine="prosemirror" owner=owner editable=editable}}
              <div class="description-actions">
                <button type="button" class="save-description" data-field="system.description"><i class="fas fa-save"></i> Salvar</button>
                <button type="button" class="expand-description" data-expanded="false"><i class="fas fa-expand"></i> Expandir</button>
                <button type="button" class="cancel-description"><i class="fas fa-times"></i> Cancelar</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    {{!-- ABA: PROTEÇÃO (Específica da Armadura) --}}
    <div class="tab" data-tab="protection">
        <div class="form-section protection-grid">
            <div class="attacks-editor-section">
                <div class="attack-section-header">
                    <h4 class="attack-section-title">Proteção por Localização</h4>
                    <a class="attack-add-button add-dr-location" title="Adicionar RD"><i class="fas fa-plus"></i></a>
                </div>
            </div>

            <ol class="attack-list dr-locations-table">

                {{#each drLocationRows as |row|}}
                    <li class="attack-item dr-location-item" data-dr-location-row>
                        <div class="attack-display-card">
                            <div class="attack-line">
                                <div class="attack-cell">
                                    <input class="dr-location-label" type="text" list="gum-body-location-options" value="{{row.label}}" placeholder="Ex: Braço E"/>
                                    <input class="dr-location-key" type="hidden" value="{{row.key}}"/>
                                </div>
                                <div class="attack-cell">
                                    <input class="dr-location-value" type="text" value="{{row.dr}}" placeholder="0"/>
                                </div>
                                <div class="attack-cell">
                                    <button class="dr-location-delete" type="button" title="Remover"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        </div>
                    </li>
                {{/each}}
            </ol>

            <datalist id="gum-body-location-options">
                {{#each bodyLocationOptions as |loc|}}
                    <option value="{{loc.name}}" data-key="{{loc.id}}"></option>
                {{/each}}
            </datalist>
        </div>
    </div>


    {{!-- ABA: MODIFICADORES DE EQUIPAMENTO (NOVA) --}}
     <div class="tab" data-tab="eqp_modifiers">
        <div class="modifiers-tab">
            <div class="form-section modifiers-panel">
                <div class="mod-panel-header">
                    <div>
                        <h4 class="section-title">Modificadores de Equipamento</h4>
                        <p class="hint">CF e Peso ajustados são exibidos aqui.</p>
                    </div>
                    <a class="button item-add-button add-eqp-modifier"><i class="fas fa-plus"></i> Adicionar Modificador</a>
                </div>

                <ol class="modifier-list">
                    {{#each eqpModifiersList as |mod|}}
                        <li class="modifier-card is-eqp" data-modifier-id="{{mod.id}}">
                            <div class="mod-info">
                                <div class="mod-name">{{mod.name}}</div>
                                <div class="mod-effect">
                                    CF {{#if (gt mod.cost_factor 0)}}+{{/if}}{{mod.cost_factor}} • Peso {{mod.weight_mod}}
                                </div>
                                {{#if mod.features}}
                                    <div class="mod-notes">{{mod.features}}</div>
                                {{/if}}
                            </div>
                            <div class="mod-meta">
                                <span class="mod-cost-badge">CF {{#if (gt mod.cost_factor 0)}}+{{/if}}{{mod.cost_factor}}</span>
                                <span class="mod-cost-badge">Peso {{mod.weight_mod}}</span>
                                <div class="modifier-controls">
                                    <a class="view-eqp-modifier" title="Ver Detalhes"><i class="fas fa-eye"></i></a>
                                    <a class="delete-eqp-modifier" title="Remover"><i class="fas fa-trash"></i></a>
                                </div>
                            </div>
                        </li>
                    {{else}}
                        <li class="placeholder-text">
                            <p>Nenhum modificador de equipamento aplicado.</p>
                        </li>
                    {{/each}}
                </ol>
            </div>

            {{#if eqpModifiersHasFeatures}}
            <div class="form-section mod-effects-summary">
                <div class="mod-panel-header">
                    <div>
                        <h4 class="section-title">Resumo de Efeitos</h4>
                        <p class="hint">Textos e observações consolidadas dos mods.</p>
                    </div>
                </div>
                <ul class="mod-effects-list">
                    {{#each eqpModifiersList as |mod|}}
                        {{#if mod.features}}
                            <li>
                                <strong>{{mod.name}}:</strong>
                                <span>{{mod.features}}</span>
                            </li>
                        {{/if}}
                    {{/each}}
                </ul>
            </div>
            {{/if}}
        </div>
    </div>

    {{!-- ABA: EFEITOS --}}
    <div class="tab" data-tab="effects">
        <div class="effects-tab-layout">
            <div class="effects-columns">
                <div class="form-section effect-category">
                    <div class="section-header">
                        <div>
                            <h4 class="section-title">Efeitos Passivos</h4>
                            <p class="hint">Aplicados automaticamente enquanto a armadura estiver EQUIPADA.</p>
                        </div>
                        <div class="section-actions">
                            <span class="section-tag">Equipado</span>
                        </div>
                    </div>
                    <div class="effect-group passive"> 
                        <div class="group-header">
                            <div class="group-heading">
                                <h5 class="group-title"><i class="fas fa-shield-alt"></i> Ativos na Armadura</h5>
                                <p class="group-subtitle">Inclua bônus, resistências ou penalidades permanentes.</p>
                            </div>
                            <a class="button item-add-button add-effect" data-target-list="passiveEffects" title="Adicionar Efeito Passivo"><i class="fas fa-plus"></i> Adicionar</a>
                        </div>
                        <ol class="effects-list">
                            {{#each system.preparedEffects.passive as |effect|}}
                                <li class="effect-entry" data-list-name="passiveEffects" data-effect-id="{{effect.id}}">
                                    <div class="effect-header">
                                        <div class="effect-main">
                                            <img src="{{effect.img}}" class="effect-icon"/>
                                            <div class="effect-text">
                                                <span class="effect-name">{{effect.name}}</span>
                                                <span class="effect-context">Aplicado enquanto equipada</span>
                                            </div>
                                        </div>
                                        <div class="effect-controls">
                                            <a class="view-original-effect" title="Ver Efeito Original" data-uuid="{{effect.uuid}}"><i class="fas fa-eye"></i></a>
                                            <a class="delete-effect" title="Remover Efeito"><i class="fas fa-trash"></i></a>
                                        </div>
                                    </div>
                                </li>
                            {{else}}
                                <p class="empty-hint">Nenhum efeito passivo definido.</p>
                            {{/each}}
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    </div>

  </section> 
</section> 
</form>