{{!-- Definindo o partial 'inline' no topo do arquivo --}}
{{#*inline "itemDetailsGeneral"}}
    {{!-- Este bloco contém os campos gerais para equipamentos e armas. --}}
    <div class="form-section"><h4 class="section-title">Geral</h4>
        <div class="form-grid-3">
            <div class="form-group input-narrow"><label>Quantidade</label><input type="number" name="system.quantity" value="{{system.quantity}}"/></div>
            
            {{!-- PESO COM CÁLCULO --}}
            <div class="form-group input-narrow">
                <label>Peso (kg)</label>
                {{#if hasWeightChange}}
                    <div class="calculated-value-group" style="display:flex; gap:5px; align-items:center;">
                        <input type="number" step="0.01" name="system.weight" value="{{system.weight}}" style="width: 50px; opacity: 0.7;" title="Peso Base"/>
                        <i class="fas fa-arrow-right" style="font-size: 0.8em; color: #666;"></i>
                        <span style="font-weight:bold; color: #c5a05b;" title="Peso Final">{{finalWeightString}}</span>
                    </div>
                {{else}}
                    <input type="number" step="0.01" name="system.weight" value="{{system.weight}}"/>
                {{/if}}
            </div>

            {{!-- CUSTO COM CÁLCULO --}}
            <div class="form-group input-narrow">
                <label>Custo ($)</label>
                {{#if hasCostChange}}
                    <div class="calculated-value-group" style="display:flex; gap:5px; align-items:center;">
                        <input type="number" name="system.cost" value="{{system.cost}}" style="width: 50px; opacity: 0.7;" title="Custo Base"/>
                        <i class="fas fa-arrow-right" style="font-size: 0.8em; color: #666;"></i>
                        <span style="font-weight:bold; color: #c5a05b;" title="Custo Final">{{finalCostString}}</span>
                    </div>
                {{else}}
                    <input type="number" name="system.cost" value="{{system.cost}}"/>
                {{/if}}
            </div>
        </div>
        <div class="form-grid-3">
            <div class="form-group input-narrow"><label title="Nível Tecnológico">NT</label><input type="text" name="system.tech_level" value="{{system.tech_level}}"/></div>
            <div class="form-group input-narrow"><label title="Classe de Legalidade">CL</label><input type="text" name="system.legality_class" value="{{system.legality_class}}"/></div>
            
            {{!-- Campo REF com botão --}}
            <div class="form-group input-narrow">
                <label title="Livro e Página de Referência"><a class="open-reference-link" title="Abrir Referência"><i class="fas fa-book-open"></i></a> REF</label>         
                <div class="input-with-button">
                    <input type="text" name="system.ref" value="{{system.ref}}"/>
                </div>
            </div>
        </div>
    </div>

    {{!-- ✅ NOVA SEÇÃO: PROPRIEDADES FÍSICAS --}}
    <div class="form-section"><h4 class="section-title">Propriedades Físicas</h4>
        <div class="form-grid-4">
            <div class="form-group input-narrow" title="Modificador de Tamanho (SM)">
                <label>MT (SM)</label>
                <input type="number" name="system.tech_sm" value="{{system.tech_sm}}" placeholder="+0"/>
            </div>
            <div class="form-group input-narrow" title="Resistência a Dano do próprio Item">
                <label>RD Item</label>
                <input type="number" name="system.item_dr" value="{{system.item_dr}}"/>
            </div>
            <div class="form-group input-narrow" title="Pontos de Vida do Item">
                <label>PV Item</label>
                <input type="number" name="system.item_hp" value="{{system.item_hp}}"/>
            </div>
            <div class="form-group input-narrow" title="Vitalidade (HT) do Item">
                <label>HT Item</label>
                <input type="number" name="system.item_ht" value="{{system.item_ht}}"/>
            </div>
        </div>
    </div>

    {{!-- ✅ NOVA SEÇÃO: USO E LOGÍSTICA --}}
    <div class="form-section"><h4 class="section-title">Uso & Defesa</h4>
        <div class="form-grid-3">
            <div class="form-group input-narrow" title="Penalidade de Ocultamento (Holdout)">
                <label>Ocultar</label>
                <input type="number" name="system.holdout" value="{{system.holdout}}" placeholder="0"/>
            </div>
            <div class="form-group input-narrow" title="Tempo para equipar/vestir em segundos">
                <label>T. Vestir (s)</label>
                <input type="number" name="system.equip_time" value="{{system.equip_time}}"/>
            </div>
            <div class="form-group input-narrow" title="Bônus de Defesa (DB) para Escudos ou Capas">
                <label>DB (Escudo)</label>
                <input type="number" name="system.defense_bonus" value="{{system.defense_bonus}}"/>
            </div>
        </div>
        {{!-- Campos de Texto Livre --}}
        <div class="form-grid-2" style="margin-top: 10px;">
             <div class="form-group"><label>Qualidade</label><input type="text" name="system.quality" value="{{system.quality}}" placeholder="Ex: Fina, Barata"/></div>
             <div class="form-group"><label>Material</label><input type="text" name="system.material" value="{{system.material}}" placeholder="Ex: Aço, Madeira"/></div>
        </div>
    </div>
{{/inline}}

{{!-- ======================================================== --}}
{{!--        NOVA ABA DE EFEITOS (ESTRUTURA VERSÃO 3)        --}}
{{!-- ======================================================== --}}
{{#*inline "effectsTab"}}
    <div class="effects-tab-layout">
        <div class="effects-columns">

        {{!-- ================================================== --}}
        {{!-- EM SUCESSO --}}
        {{!-- ================================================== --}}
        <div class="effects-block">
            <div class="effects-block-header">
            <h4 class="effects-block-title">Em Sucesso</h4>
            <a class="effects-add-button add-effect" data-target-list="activationEffects.success" title="Adicionar Efeito em Sucesso"><i class="fas fa-plus"></i></a>
            </div>

            <ol class="effects-line-list">
            {{#each system.preparedEffects.activation.success as |effect|}}
                <li class="effects-line-item" data-list-name="activationEffects.success" data-effect-id="{{effect.id}}">
                <div class="effects-line effects-line-basic">
                    {{!-- Coluna: ícone + nome --}}
                    <div class="effects-cell effects-identity">
                    <img src="{{effect.img}}" class="effects-icon" />
                    <div class="effects-text">
                        <div class="effects-name">{{effect.name}}</div>
                    </div>
                    </div>

                    {{!-- Coluna: destinatário --}}
                    <div class="effects-cell effects-recipient">
                    <div class="effects-label">Dest.</div>
                    <select name="system.activationEffects.success.{{effect.id}}.recipient">
                        <option value="self" {{#if (eq effect.recipient 'self')}}selected{{/if}}>Próprio</option>
                        <option value="target" {{#if (eq effect.recipient 'target')}}selected{{/if}}>Alvo</option>
                    </select>
                    </div>

                    {{!-- Coluna: ações --}}
                    <div class="effects-cell effects-actions">
                    <span class="effects-controls">
                        <a class="view-original-effect" title="Ver Efeito Original" data-uuid="{{effect.uuid}}"><i class="fas fa-eye"></i></a>
                        <a class="delete-effect" title="Remover Efeito"><i class="fas fa-trash"></i></a>
                    </span>
                    </div>
                </div>
                </li>
            {{else}}
                <li class="effects-empty">Nenhum efeito.</li>
            {{/each}}
            </ol>
        </div>

        {{!-- ================================================== --}}
        {{!-- EM FALHA --}}
        {{!-- ================================================== --}}
        <div class="effects-block">
            <div class="effects-block-header">
            <h4 class="effects-block-title">Em Falha</h4>
            <a class="effects-add-button add-effect" data-target-list="activationEffects.failure" title="Adicionar Efeito em Falha"><i class="fas fa-plus"></i></a>
            </div>

            <ol class="effects-line-list">
            {{#each system.preparedEffects.activation.failure as |effect|}}
                <li class="effects-line-item" data-list-name="activationEffects.failure" data-effect-id="{{effect.id}}">
                <div class="effects-line effects-line-basic">
                    <div class="effects-cell effects-identity">
                    <img src="{{effect.img}}" class="effects-icon" />
                    <div class="effects-text">
                        <div class="effects-name">{{effect.name}}</div>
                    </div>
                    </div>

                    <div class="effects-cell effects-recipient">
                    <div class="effects-label">Dest.</div>
                    <select name="system.activationEffects.failure.{{effect.id}}.recipient">
                        <option value="self" {{#if (eq effect.recipient 'self')}}selected{{/if}}>Próprio</option>
                        <option value="target" {{#if (eq effect.recipient 'target')}}selected{{/if}}>Alvo</option>
                    </select>
                    </div>

                    <div class="effects-cell effects-actions">
                    <span class="effects-controls">
                        <a class="view-original-effect" title="Ver Efeito Original" data-uuid="{{effect.uuid}}"><i class="fas fa-eye"></i></a>
                        <a class="delete-effect" title="Remover Efeito"><i class="fas fa-trash"></i></a>
                    </span>
                    </div>
                </div>
                </li>
            {{else}}
                <li class="effects-empty">Nenhum efeito.</li>
            {{/each}}
            </ol>
        </div>

        {{!-- ================================================== --}}
        {{!-- AO CAUSAR DANO --}}
        {{!-- ================================================== --}}
        <div class="effects-block">
            <div class="effects-block-header">
            <h4 class="effects-block-title">Ao Causar Dano</h4>
            <a class="effects-add-button add-effect" data-target-list="onDamageEffects" title="Adicionar Efeito ao Causar Dano"><i class="fas fa-plus"></i></a>
            </div>

            <ol class="effects-line-list">
            {{#each system.preparedEffects.onDamage as |effect|}}
                <li class="effects-line-item" data-list-name="onDamageEffects" data-effect-id="{{effect.id}}">
                <div class="effects-line effects-line-damage">
                    <div class="effects-cell effects-identity">
                    <img src="{{effect.img}}" class="effects-icon" />
                    <div class="effects-text">
                        <div class="effects-name">{{effect.name}}</div>
                    </div>
                    </div>

                    <div class="effects-cell is-center">
                    <div class="effects-label">Lesão</div>
                    <input class="effects-mini-input" type="number" name="system.onDamageEffects.{{effect.id}}.minInjury" value="{{effect.minInjury}}" placeholder="1"/>
                    </div>

                    <div class="effects-cell">
                    <div class="effects-label">Tipo</div>
                    <input class="effects-mini-input" type="text" name="system.onDamageEffects.{{effect.id}}.requiredDamageType" value="{{effect.requiredDamageType}}" placeholder="Qualquer"/>
                    </div>

                    <div class="effects-cell is-center">
                    <div class="effects-label">Chance</div>
                    <input class="effects-mini-input" type="number" name="system.onDamageEffects.{{effect.id}}.activationChance" value="{{effect.activationChance}}" placeholder="100"/>
                    </div>

                    <div class="effects-cell effects-actions">
                    <span class="effects-controls">
                        <a class="view-original-effect" title="Ver Efeito Original" data-uuid="{{effect.uuid}}"><i class="fas fa-eye"></i></a>
                        <a class="delete-effect" title="Remover Efeito"><i class="fas fa-trash"></i></a>
                    </span>
                    </div>
                </div>
                </li>
            {{else}}
                <li class="effects-empty">Nenhum efeito.</li>
            {{/each}}
            </ol>
        </div>

        {{!-- ================================================== --}}
        {{!-- EFEITOS PASSIVOS --}}
        {{!-- ================================================== --}}
        <div class="effects-block">
            <div class="effects-block-header">
            <h4 class="effects-block-title">Efeitos Passivos</h4>
            <a class="effects-add-button add-effect" data-target-list="passiveEffects" title="Adicionar Efeito Passivo"><i class="fas fa-plus"></i></a>
            </div>

            <ol class="effects-line-list">
            {{#each system.preparedEffects.passive as |effect|}}
                <li class="effects-line-item" data-list-name="passiveEffects" data-effect-id="{{effect.id}}">
                <div class="effects-line effects-line-passive">
                    <div class="effects-cell effects-identity">
                    <img src="{{effect.img}}" class="effects-icon" />
                    <div class="effects-text">
                        <div class="effects-name">{{effect.name}}</div>
                    </div>
                    </div>

                    <div class="effects-cell effects-actions">
                    <span class="effects-controls">
                        <a class="view-original-effect" title="Ver Efeito Original" data-uuid="{{effect.uuid}}"><i class="fas fa-eye"></i></a>
                        <a class="delete-effect" title="Remover Efeito"><i class="fas fa-trash"></i></a>
                    </span>
                    </div>
                </div>
                </li>
            {{else}}
                <li class="effects-empty">Nenhum efeito.</li>
            {{/each}}
            </ol>
        </div>

        {{!-- ================================================== --}}
        {{!-- CONDIÇÕES GERAIS --}}
        {{!-- ================================================== --}}
        <div class="effects-block">
            <div class="effects-block-header">
            <h4 class="effects-block-title">Condições Gerais</h4>
            <a class="effects-add-button add-general-condition" title="Anexar Condição"><i class="fas fa-plus"></i></a>
            </div>

            <ol class="effects-line-list">
            {{#each system.preparedEffects.general as |condition|}}
                <li class="effects-line-item" data-list-name="generalConditions" data-effect-id="{{condition.id}}">
                <div class="effects-line effects-line-passive">
                    <div class="effects-cell effects-identity">
                    <img src="{{condition.img}}" class="effects-icon" />
                    <div class="effects-text">
                        <div class="effects-name">{{condition.name}}</div>
                    </div>
                    </div>

                    <div class="effects-cell effects-actions">
                    <span class="effects-controls">
                        <a class="view-original-condition" title="Ver Condição Original" data-uuid="{{condition.uuid}}"><i class="fas fa-eye"></i></a>
                        <a class="delete-effect" title="Remover Condição"><i class="fas fa-trash"></i></a>
                    </span>
                    </div>
                </div>
                </li>
            {{else}}
                <li class="effects-empty">Nenhuma condição.</li>
            {{/each}}
            </ol>
        </div>

        </div>
    </div>
{{/inline}}

{{!-- ============================================= --}}
{{!-- INÍCIO DA ESTRUTURA DAS FICHAS                --}}
{{!-- ============================================= --}}
<form class="{{cssClass}} gum-item-sheet effect-sheet" autocomplete="off">

{{!-- Cabeçalho da Ficha --}}
<header class="sheet-header">
  <img class="profile-img" src="{{item.img}}" data-edit="img" title="{{item.name}}" />
  <div class="header-info">
    <div class="header-main-line">
      <textarea name="name" rows="1" placeholder="Nome do Item">{{item.name}}</textarea>
    </div>
    <div class="header-subline">
      <span class="item-type-tag">{{lookup (object 
        armor="Armadura" melee_weapon="Arma C.C." ranged_weapon="Arma L.D." 
        equipment="Equipamento" skill="Perícia" spell="Magia" 
        advantage="Vantagem" disadvantage="Desvantagem" power="Poder" modifier="Modificador" eqp_modifier="Mod. Equip." gm_modifier="GM MOD") item.type}}</span>
    </div>
    <span class="header-divider" aria-hidden="true"></span>
  </div>
</header>

{{!-- NOVA ESTRUTURA COM ABAS --}}
<section class="sheet-content">

  {{!-- 1. Navegação das Abas (CORRIGIDA) --}}
  <nav class="sheet-tabs tabs" data-group="primary">
        <a class="item" data-tab="description">Descrição</a>
        <a class="item" data-tab="details">Detalhes</a>
       
        {{!-- Bloco 2: Aba "Modos de Ataque" para Equipamentos --}}
        {{#if (eq item.type "equipment")}}
        <a class="item" data-tab="attacks">Modos de Ataque</a>
        {{/if}}

        {{!-- Bloco 2.1: Aba "Proteção" para Equipamentos --}}
        {{#if (eq item.type "equipment")}}
        <a class="item" data-tab="protection">Proteção</a>
        {{/if}}
        
        {{!-- Bloco 3: Aba "Efeitos" (lógica original) --}}
        {{#if (or (eq item.type "skill") (eq item.type "spell") (eq item.type "power") (eq item.type "equipment") (eq item.type "armor") (eq item.type "advantage") (eq item.type "disadvantage"))}}
        <a class="item" data-tab="effects">Efeitos</a>
        {{/if}}
        
        {{!-- Bloco 4: Aba "Modificadores" (lógica original) --}}
        {{#if (or (eq item.type "advantage") (eq item.type "disadvantage") (eq item.type "power"))}}
        <a class="item" data-tab="modifiers">Modificadores</a>
        {{/if}}

        {{!-- Aba Mods para Equipamentos e Armaduras --}}
        {{#if (or (eq item.type "equipment") (eq item.type "armor"))}}
        <a class="item" data-tab="eqp_modifiers">Mods</a>
        {{/if}}
  </nav>

    {{!-- 2. Corpo das Abas --}}
    <section class="sheet-body-content">

     {{!-- Aba "Detalhes" --}}
     <div class="tab" data-tab="details">
        
        {{!-- ===================================================================== --}}
        {{!-- 		ABA DETALHES: ITEM EQUIPAMENTO 				 --}}
        {{!-- ===================================================================== --}}
        {{#if (eq item.type "equipment")}}
            {{> itemDetailsGeneral}}
        {{/if}}
        
        {{!-- ===================================================================== --}}
        {{!-- 		ABA DETALHES: ITEM ARMADURA 				 --}}
        {{!-- ===================================================================== --}}
        {{#if (eq item.type "armor")}}
            {{> itemDetailsGeneral}}
        {{/if}}

        {{!-- ===================================================================== --}}
        {{!-- 		ABA DETALHES: ITEM MODIFICADOR DE EQUIPAMENTO (LAYOUT v2)	 --}}
        {{!-- ===================================================================== --}}
        {{#if (eq item.type "eqp_modifier")}}
            
            {{!-- Seção 1: Mecânica (Custo, Peso, TL) --}}
            <div class="form-section"><h4 class="section-title">Mecânica</h4>
                <div class="form-grid-4">
                    <div class="form-group" title="Fator de Custo (ex: +1, +4.5)">
                        <label>Fator Custo (CF)</label>
                        <input type="number" step="0.1" name="system.cost_factor" value="{{system.cost_factor}}" placeholder="+0"/>
                    </div>
                    <div class="form-group" title="Modificador de Peso (ex: x0.75, x1.5)">
                        <label>Mod. Peso</label>
                        <input type="text" name="system.weight_mod" value="{{system.weight_mod}}" placeholder="x1"/>
                    </div>
                    <div class="form-group" title="Nível Tecnológico do Modificador">
                        <label>NT (TL)</label>
                        <input type="text" name="system.tech_level" value="{{system.tech_level}}" placeholder="0"/>
                    </div>
                    {{!-- Campo REF com botão --}}
                    <div class="form-group">
                        <label><a class="open-reference-link" title="Abrir Referência"><i class="fas fa-book-open"></i></a> - Ref.</label>
                        <div class="input-with-button">
                            <input type="text" name="system.ref" value="{{system.ref}}"/>
                        </div>
                    </div>
                </div>
                
                {{!-- Tags para busca --}}
                <div class="form-group" style="margin-top: 8px;">
                    <label>Tags / Palavras-Chave</label>
                    <input type="text" name="system.tags" value="{{system.tags}}" placeholder="Ex: Metal, Mágico, Élfico, Qualidade (Separar por vírgula)"/>
                </div>
            </div>
            {{!-- Seção: Tipo de Aplicação (Filtros) --}}
            <div class="form-section"><h4 class="section-title">Aplica-se a:</h4>
                <div class="form-grid-3 attack-flags-grid">
                    <label class="custom-checkbox">
                        <input type="checkbox" name="system.target_type.general" {{checked system.target_type.general}}/>
                        <span>Geral (Todos)</span>
                    </label>
                    <label class="custom-checkbox">
                        <input type="checkbox" name="system.target_type.melee" {{checked system.target_type.melee}}/>
                        <span>Arma C.C.</span>
                    </label>
                    <label class="custom-checkbox">
                        <input type="checkbox" name="system.target_type.ranged" {{checked system.target_type.ranged}}/>
                        <span>Arma Dist.</span>
                    </label>
                    <label class="custom-checkbox">
                        <input type="checkbox" name="system.target_type.armor" {{checked system.target_type.armor}}/>
                        <span>Armadura</span>
                    </label>
                    <label class="custom-checkbox">
                        <input type="checkbox" name="system.target_type.shield" {{checked system.target_type.shield}}/>
                        <span>Escudo</span>
                    </label>
                    <label class="custom-checkbox">
                        <input type="checkbox" name="system.target_type.ammo" {{checked system.target_type.ammo}}/>
                        <span>Munição</span>
                    </label>
                    <label class="custom-checkbox">
                        <input type="checkbox" name="system.target_type.enchantment" {{checked system.target_type.enchantment}}/>
                        <span>Encantamento</span>
                    </label>
                </div>
            </div>
            {{!-- Seção 2: Dados de Cenário (Layout Ajustado) --}}
            <div class="form-section"><h4 class="section-title">Dados de Cenário</h4>
                
                {{!-- Linha 1: Raridade e Disponibilidade (Lado a Lado) --}}
                <div class="form-grid-2">
                    <div class="form-group">
                        <label>Raridade</label>
                        <input type="text" name="system.scenario.rarity" value="{{system.scenario.rarity}}" placeholder="Ex: Comum, Único"/>
                    </div>
                    <div class="form-group">
                        <label>Disponibilidade</label>
                        <input type="text" name="system.scenario.availability" value="{{system.scenario.availability}}" placeholder="Ex: Mercado 12-, Apenas Conexão"/>
                    </div>
                </div>

                {{!-- Linha 2: Região / Origem (Largura Total) --}}
                <div class="form-group" style="margin-top: 8px;">
                    <label>Região / Origem</label>
                    <input type="text" name="system.scenario.location" value="{{system.scenario.location}}" placeholder="Ex: Montanhas do Norte, Forjas Reais de Khazad"/>
                </div>
                
                {{!-- Linha 3: Materiais (Largura Total) --}}
                <div class="form-group" style="margin-top: 8px;">
                    <label>Materiais / Componentes Necessários</label>
                    <input type="text" name="system.scenario.components" value="{{system.scenario.components}}" placeholder="Ex: 1kg de Oricalco Bruto, Forja Vulcânica"/>
                </div>
            </div>
            
            {{!-- Seção 3: Efeitos e Notas --}}
            <div class="form-section"><h4 class="section-title">Efeitos e Notas</h4>
                 <p class="hint">Descreva aqui os efeitos mecânicos (ex: +1 Dano, RD +1) ou narrativos.</p>
                 <div class="form-group">
                    <textarea name="system.features" rows="4" placeholder="Ex: +1 de dano no ataque. Trata a RD como se fosse 2 menor.">{{system.features}}</textarea>
                 </div>
            </div>
        {{/if}}

{{!-- ===================================================================== --}}
{{!-- 		ABA DETALHES: MODIFICADOR DO MESTRE (LAYOUT COMPACTO)        --}}
{{!-- ===================================================================== --}}
{{#if (eq item.type "gm_modifier")}}


        <div class="form-section">
            <h4 class="section-title">Organização</h4>
            <div class="effect-row-grid effect-duration-grid is-two-col-rows">
                <div class="effect-field effect-field-row-auto">
                <label class="effect-label">Bloco na Janela de Rolagem</label>
                <select name="system.ui_category">
                    {{selectOptions (object 
                        location="Localização de Acerto" 
                        maneuver="Manobras" 
                        
                        attack_opt="Opções de Ataque" 
                        defense_opt="Opções de Defesa" 
                        
                        posture="Postura"
                        range="Distância / Alcance"
                        
                        ritual="Magia: Ritual & Mana"
                        time="Tempo / Duração"
                        effort="Esforço Extra"
                        
                        situation="Situação / Condição"
                        other="Outros / Customizado"
                    ) selected=system.ui_category}}
                </select>
                </div>
            </div>
        </div>

        <div class="form-section">
            <h4 class="section-title">Valor do Modificador</h4>
            <div class="gm-stats-grid dense two-rows">
                <div class="gm-stat wide" title="O valor que será somado (ex: -2, +1)">
                    <div class="skill-stat-card level-card">
                        <div class="stat-label">Modificador</div>
                        <div class="stat-value counter-wrapper">
                            <a class="adjust-value" data-action="decrease" data-target="system.modifier"><i class="fas fa-minus"></i></a>
                            <input type="number" name="system.modifier" value="{{system.modifier}}" class="tight-input" placeholder="0"/>
                            <a class="adjust-value" data-action="increase" data-target="system.modifier"><i class="fas fa-plus"></i></a>
                        </div>
                    </div>
                </div>
                <div class="gm-stat" title="O valor máximo permitido para o teste (ex: 9 para Mover e Atacar). Deixe vazio para sem limite.">
                    <div class="skill-stat-card">
                        <div class="stat-label">Limite do NH (teto)</div>
                        <div class="stat-value">
                            <input type="number" name="system.nh_cap" value="{{system.nh_cap}}" placeholder="9" class="tight-input"/>
                        </div>
                    </div>
                </div>
                <div class="gm-stat full-row" title="Lembrete de duração">
                    <label class="stat-label">Obersvações</label>
                    <div class="stat-input centered">
                        <input type="text" name="system.duration" value="{{system.duration}}" placeholder="Ex: Terreno difícil" class="tight-input"/>
                    </div>
                    <p class="hint">Campo não automatizado. Serve apenas como referência ou lembrete para o Mestre.</p>
                </div>
            </div>
        </div>


    <div class="form-section">
        <h4 class="section-title"> Rolagens Afetadas pelo modificador</h4>
        <div class="form-grid-3">
                    <label class="gm-chip">
                        <input type="checkbox" name="system.target_type.global" {{checked system.target_type.global}}/>
                        <div class="chip-body">
                            <span class="chip-title">Global</span>
                            <span class="chip-hint">Marca tudo</span>
                        </div>
                    </label>
                    <label class="gm-chip">
                        <input type="checkbox" name="system.target_type.reaction" {{checked system.target_type.reaction}}/>
                        <div class="chip-body">
                            <span class="chip-title">Reação</span>
                            <span class="chip-hint">Sociais</span>
                        </div>
                    </label>
                    <label class="gm-chip">
                        <input type="checkbox" name="system.target_type.check_fright" {{checked system.target_type.check_fright}}/> 
                            <div class="chip-body">
                                <span class="chip-title">Verificação de Pânico</span>
                            </div>
                    </label>
        </div>

        <details class="gm-tree-group" id="gm-tree-combat">
           
            <summary>
                <div class="summary-icon"><i class="fas fa-fist-raised"></i></div>
                <div>
                    <h5>Combate</h5>
                    <p>Testes de ataque, dano e defesa.</p>
                </div>
                <span class="gm-pill subtle">Ataques/Defesas</span>
            </summary>
                <div class="gm-tree-content">
                    <label class="gm-checkbox parent-check">
                        <input type="checkbox" name="system.target_type.combat_all" {{checked system.target_type.combat_all}}/>
                        <span>Todos os Testes de Combate</span>
                    </label>
                    
                    <div class="combat-grid condensed">
                        <div class="subgroup">
                            <strong class="subgroup-title">Ataque</strong>
                            <label class="gm-checkbox"><input type="checkbox" name="system.target_type.combat_attack_melee" {{checked system.target_type.combat_attack_melee}}/> <span>Corpo a Corpo</span></label>
                            <label class="gm-checkbox"><input type="checkbox" name="system.target_type.combat_attack_ranged" {{checked system.target_type.combat_attack_ranged}}/> <span>Distância</span></label>
                            <label class="gm-checkbox"><input type="checkbox" name="system.target_type.combat_attack_spell" {{checked system.target_type.combat_attack_spell}}/> <span>Magia</span></label>
                            <label class="gm-checkbox"><input type="checkbox" name="system.target_type.combat_attack_power" {{checked system.target_type.combat_attack_power}}/> <span>Poder</span></label>
                        </div>
                        <div class="subgroup">
                            <strong class="subgroup-title">Dano</strong>
                            <label class="gm-checkbox"><input type="checkbox" name="system.target_type.combat_damage_melee" {{checked system.target_type.combat_damage_melee}}/> <span>C.C.</span></label>
                            <label class="gm-checkbox"><input type="checkbox" name="system.target_type.combat_damage_ranged" {{checked system.target_type.combat_damage_ranged}}/> <span>Dist.</span></label>
                            <label class="gm-checkbox"><input type="checkbox" name="system.target_type.combat_damage_spell" {{checked system.target_type.combat_damage_spell}}/> <span>Magia</span></label>
                            <label class="gm-checkbox"><input type="checkbox" name="system.target_type.combat_damage_power" {{checked system.target_type.combat_damage_power}}/> <span>Poder</span></label>
                        </div>
                        <div class="subgroup">
                            <strong class="subgroup-title">Defesa</strong>
                            <label class="gm-checkbox"><input type="checkbox" name="system.target_type.combat_defense_dodge" {{checked system.target_type.combat_defense_dodge}}/> <span>Esquiva</span></label>
                            <label class="gm-checkbox"><input type="checkbox" name="system.target_type.combat_defense_parry" {{checked system.target_type.combat_defense_parry}}/> <span>Aparar</span></label>
                            <label class="gm-checkbox"><input type="checkbox" name="system.target_type.combat_defense_block" {{checked system.target_type.combat_defense_block}}/> <span>Bloqueio</span></label>
                        </div>
                    </div>
                </div>
        </details>

        <details class="gm-tree-group" id="gm-tree-attributes">
            <summary>
                <div class="summary-icon"><i class="fas fa-brain"></i></div>
                <div>
                    <h5>Atributos &amp; Habilidades</h5>
                    <p>Marque atributos completos ou as linhas específicas.</p>
                </div>
                <span class="gm-pill subtle">Testes gerais</span>
            </summary>
                <div class="gm-tree-content">
                    
                    <div class="gm-chip-grid tight two-cols top-row">
                        <label class="gm-chip">
                            <input type="checkbox" name="system.target_type.attr_all" {{checked system.target_type.attr_all}}/>
                            <div class="chip-body">
                                <span class="chip-title">Todos os Atributos</span>
                            </div>
                        </label>
                        <label class="gm-chip">
                            <input type="checkbox" name="system.target_type.skill_all" {{checked system.target_type.skill_all}}/>
                            <div class="chip-body">
                                <span class="chip-title">Todas as Perícias</span>
                            </div>
                        </label>

                    </div>

                    <div class="gm-attributes-grid">
                        {{!-- CABEÇALHO DA TABELA --}}
                        <div class="attr-row header-row">
                            <span class="attr-label">Base</span>
                            <span title="Teste direto do atributo (ex: rolar DX)">Atributo</span>
                            <span title="Perícias baseadas neste atributo">Perícia</span>
                            <span title="Magias baseadas neste atributo">Magia</span>
                            <span title="Poderes baseados neste atributo">Poder</span>
                        </div>

                        {{!-- LINHAS (ST, DX, etc.) --}}
                        {{#each (object Per="per" Vont="will" IQ="iq" HT="ht" DX="dx" ST="st") as |key label|}}
                        <div class="attr-row">
                            {{!-- Coluna 1: Rótulo + Selecionar Linha --}}
                            <div class="attr-label">
                                <label class="gm-checkbox parent-row-check" title="Marcar toda a linha {{label}}">
                                    <input type="checkbox" class="attr-parent-toggle" data-attr="{{key}}" name="system.target_type.attr_{{key}}_all" {{checked (lookup ../system.target_type (concat "attr_" key "_all"))}}/>
                                    <span>{{label}}</span>
                                </label>
                            </div>
                            
                            {{!-- Colunas: As opções específicas --}}
                            <div><input type="checkbox" class="attr-child-{{key}}" name="system.target_type.check_{{key}}" {{checked (lookup ../system.target_type (concat "check_" key))}} title="Teste de {{label}} Puro"/></div>
                            <div><input type="checkbox" class="attr-child-{{key}}" name="system.target_type.skill_{{key}}" {{checked (lookup ../system.target_type (concat "skill_" key))}} title="Perícias de {{label}}"/></div>
                            <div><input type="checkbox" class="attr-child-{{key}}" name="system.target_type.spell_{{key}}" {{checked (lookup ../system.target_type (concat "spell_" key))}} title="Magias de {{label}}"/></div>
                            <div><input type="checkbox" class="attr-child-{{key}}" name="system.target_type.power_{{key}}" {{checked (lookup ../system.target_type (concat "power_" key))}} title="Poderes de {{label}}"/></div>
                        </div>
                            {{/each}}
                    </div>

                    {{!-- EXTRAS (Pânico e Sentidos) --}}
                    <div class="gm-extras compact">
                        <div class="gm-senses wrap">
                            <span class="senses-label">Sentidos:</span>
                            <label class="gm-checkbox"><input type="checkbox" name="system.target_type.sense_vision" {{checked system.target_type.sense_vision}}/> <span>Visão</span></label>
                            <label class="gm-checkbox"><input type="checkbox" name="system.target_type.sense_hearing" {{checked system.target_type.sense_hearing}}/> <span>Audição</span></label>
                            <label class="gm-checkbox"><input type="checkbox" name="system.target_type.sense_tastesmell" {{checked system.target_type.sense_tastesmell}}/> <span>Olfato</span></label>
                            <label class="gm-checkbox"><input type="checkbox" name="system.target_type.sense_touch" {{checked system.target_type.sense_touch}}/> <span>Tato</span></label>
                        </div>
                    </div>

                </div>
        </details>

    </div>

{{/if}}
        {{!-- ===================================================================== --}}
        {{!-- 		ABA DETALHES: ITEM VANTAGENS E DESVANTAGENS				 --}}
        {{!-- ===================================================================== --}}
        {{#if (or (eq item.type "advantage") (eq item.type "disadvantage"))}}

            {{!-- Grupo 1: Organização --}}
            <div class="form-section"><h4 class="section-title">Organização na Ficha</h4>
            <div class="form-group">
                <label>Bloco na Ficha de Personagem</label>
                <select name="system.block_id">{{selectOptions characteristic_blocks selected=system.block_id}}</select>
                <p class="notes">"Nenhuma" mantém a organização padrão por tipo (vantagem/desvantagem).</p>
            </div>
            </div>

            {{!-- Grupo 2: Custo e Pontos --}}
            <div class="form-section"><h4 class="section-title">Custo e Pontos</h4>
            <div class="form-grid-2">
                <div class="form-group">
                    <label>Pontos Base</label>
                    <input type="number" name="system.points" value="{{system.points}}"/>
                </div>
                <div class="form-group calculated-cost">
                    <label>Custo Final (c/ Modificadores)</label>
                    <div class="value">
                        <span>{{calculatedCost.finalPoints}}</span>
                        <small> (Mod: {{calculatedCost.totalModifier}}%)</small>
                    </div>
                </div>
            </div>
            </div>
            {{!-- Grupo 3: Mecânica e Detalhes --}}
            <div class="form-section"><h4 class="section-title">Mecânica e Detalhes</h4>
            <div class="form-grid-3">
                <div class="form-group">
                    <label>Nível</label>
                    <input type="text" name="system.level" value="{{system.level}}"/>
                </div>
                <div class="form-group">
                    <label>Rolagem de Auto-Controle</label>
                    <input type="text" name="system.self_control_roll" value="{{system.self_control_roll}}"/>
                </div>
                {{!-- Campo REF com botão --}}
                <div class="form-group">
                    <label><a class="open-reference-link" title="Abrir Referência"><i class="fas fa-book-open"></i></a>Ref. Página</label>
                    <div class="input-with-button">
                        <input type="text" name="system.ref" value="{{system.ref}}"/>

                    </div>
                </div>
            </div>
            </div>
        {{/if}}
       
{{!-- ===================================================================== --}}
{{!--       ABA DETALHES: ITEM PERÍCIAS (SKILL TREE POWER-UPS 10)           --}}
{{!-- ===================================================================== --}}
{{#if (eq item.type "skill")}} 

{{!-- SEÇÃO 1: ORGANIZAÇÃO & HIERARQUIA --}}
    <div class="form-section skill-organization">
        <h4 class="section-title">Organização</h4>
        <p class="section-hint">Defina como a perícia se agrupa e se conecta na árvore.</p>
        
        <div class="form-grid-2">
            <div class="form-group">
                <label>Grupo / Tronco</label>
                <input type="text" name="system.group" value="{{system.group}}" placeholder="Ex: Combate, Social..." list="groups-list"/>
                <datalist id="groups-list">
                    <option value="Animais">
                    <option value="Artes">
                    <option value="Atléticas">
                    <option value="Combate Corpo a Corpo">
                    <option value="Combate à Distância">
                    <option value="Conhecimento">
                    <option value="Criminosas">
                    <option value="Influência">
                    <option value="Mágicas">
                    <option value="M militares">
                    <option value="Natureza">
                    <option value="Outras">
                    <option value="Pessoais">
                    <option value="Plantas">
                    <option value="Profissionais">
                    <option value="Sociais">
                    <option value="Técnicas">
                    <option value="Veículos">
                </datalist>
            </div>
            
            <div class="form-group">
                <label><a class="open-reference-link" title="Abrir Referência"><i class="fas fa-book-open"></i></a> Ref. Página</label>
                <div class="input-with-button">
                    <input type="text" name="system.ref" value="{{system.ref}}"/>
                </div>
            </div>
        </div>

        <hr class="section-divider">

        <div class="form-group">
            <label>Nível na Árvore (Tier)</label>
            <select name="system.hierarchy_type" class="hierarchy-select">
                {{!-- CORREÇÃO: Usando config.hierarchyTypes --}}
                {{selectOptions config.hierarchyTypes selected=system.hierarchy_type localize=true}}
            </select>
        </div>

        <div class="skill-hierarchy-grid">
        {{!-- CONDICIONAIS DE VÍNCULO --}}
        
        {{!-- TRUNK --}}
        {{#if (eq system.hierarchy_type "trunk")}}
        <div class="skill-hierarchy-card">
            <p class="hint-text">
                <i class="fas fa-info-circle"></i> Este item define um <strong>Tronco</strong>. Outras perícias usarão o nome deste grupo ("{{system.group}}") para se agrupar aqui.
            </p>
        </div>
        {{/if}}

        {{!-- BRANCH --}}
        {{#if (eq system.hierarchy_type "branch")}}
        <div class="skill-hierarchy-card">
            <label>Vinculado ao Tronco (Opcional)</label>
            <input type="text" name="system.root_parent" value="{{system.root_parent}}" placeholder="Nome do Tronco Pai (se diferente do Grupo)"/>
        </div>
        {{/if}}

        {{!-- TWIG --}}
        {{#if (eq system.hierarchy_type "twig")}}
        <div class="skill-hierarchy-card">
            <label>Vinculado ao Ramo (Branch)</label>
            <div class="input-with-button">
                <input type="text" name="system.branch_parent" value="{{system.branch_parent}}" placeholder="Nome exato da perícia Ramo"/>
                <a class="link-skill-button" title="Buscar Ramo"><i class="fas fa-link"></i></a>
            </div>
        </div>
        {{/if}}

        {{!-- LEAF --}}
        {{#if (eq system.hierarchy_type "leaf")}}
        <div class="skill-hierarchy-card">
            <label>Vinculado ao Pai (Twig/Branch)</label>
            <div class="input-with-button">
                <input type="text" name="system.twig_parent" value="{{system.twig_parent}}" placeholder="Nome do Pai imediato"/>
                <a class="link-skill-button" title="Buscar Pai"><i class="fas fa-link"></i></a>
            </div>
        </div>
        {{/if}}
        </div>
    </div>

    {{!-- SEÇÃO 2: HABILIDADE & CUSTO --}}
    <div class="form-section skill-ability">
        <div class="skill-ability-header">
            <div>
                <h4 class="section-title">Habilidade</h4>
                <p class="section-hint">Escolha o modelo de custo e ajuste os valores principais.</p>
            </div>
        </div>

        <div class="skill-ability-toggle">
            <label class="custom-checkbox inline-checkbox">
                <input type="checkbox" name="system.auto_points" {{checked (ne system.auto_points false)}}/>
                <span>Calcular Pontos Automaticamente</span>
            </label>
        </div>

        <div class="skill-ability-grid trio">
            <div class="form-group">
                <label>Modo de Custo</label>
                <div class="form-fields">
                    <select name="system.cost_mode" class="cost-mode-select">
                        {{selectOptions config.costModes selected=system.cost_mode localize=true}}
                    </select>
                </div>
            </div>

           <div class="form-group">
                <label>Atributo Base</label>
                <div class="form-fields">
                    <select name="system.base_attribute_select">
                        {{#select skillBaseAttributeSelect}}
                        <option value="st">ST</option>
                        <option value="dx">DX</option>
                        <option value="iq">IQ</option>
                        <option value="ht">HT</option>
                        <option value="per">Per</option>
                        <option value="will">Vont</option>
                        <option value="skill">Perícia</option>
                        {{/select}}
                    </select>
                </div>
                <div class="form-fields skill-base-attribute-custom" {{#unless (eq skillBaseAttributeSelect "skill")}}style="display:none;"{{/unless}}>
                    <input type="text" name="system.base_attribute_custom" value="{{skillBaseAttributeCustom}}" placeholder="Nome da perícia base"/>
                </div>
            </div>

            <div class="form-group difficulty-group">
                <label>{{#if (eq system.cost_mode "linear")}}Custo por Nível{{else}}Dificuldade{{/if}}</label>
                <div class="form-fields">
                    {{#if (eq system.cost_mode "linear")}}
                        <input type="number" name="system.cost_per_level" value="{{system.cost_per_level}}" class="short-input cost-input" placeholder="pts/nível">
                    {{else}}
                        <select name="system.difficulty">
                            {{selectOptions config.difficulties selected=system.difficulty localize=true}}
                        </select>
                    {{/if}}
                </div>
            </div>
        </div>

        <div class="skill-ability-grid trio">
            {{!-- Nível Relativo com Botões --}}
            <div class="skill-stat-card level-card">
                <div class="stat-label">Nível Relativo</div>
                <div class="stat-value counter-wrapper">
                    <a class="adjust-value" data-action="decrease" data-target="system.skill_level"><i class="fas fa-minus"></i></a>
                    <input type="number" name="system.skill_level" value="{{system.skill_level}}" data-dtype="Number">
                    <a class="adjust-value" data-action="increase" data-target="system.skill_level"><i class="fas fa-plus"></i></a>
                </div>
            </div>

            <div class="skill-stat-card">
                <div class="stat-label">Pontos</div>
                <input type="number" name="system.points" value="{{system.points}}" {{#if (ne system.auto_points false)}}disabled{{/if}}/>
            </div>
            
            <div class="skill-stat-card">
                <div class="stat-label">Mods. NH</div>
                <input type="number" name="system.other_mods" value="{{system.other_mods}}" placeholder="+0"/>
            </div>
        </div>
    </div>
{{/if}}
        
        {{!-- ===================================================================== --}}
        {{!--           ABA DETALHES: ITEM MAGIAS (COM INPUT HÍBRIDO)                   --}}
        {{!-- ===================================================================== --}}
        {{#if (eq item.type "spell")}}

            <div class="form-section">
                <h4 class="section-title">Classificação</h4>
                <div class="effect-row-grid effect-duration-grid is-two-col-rows">
                    <div class="form-grid-2">
                        <div class="effect-field effect-field-row-auto">
                            <label class="effect-label">Grupo</label>
                            <input type="text" name="system.group" value="{{system.group}}" placeholder="Ex: Evocação"/>
                        </div>
                        <div class="effect-field effect-field-row-auto">
                            <label class="effect-label">Classe</label>
                            <input type="text" name="system.spell_class" value="{{system.spell_class}}"/>
                        </div>
                        <div class="effect-field effect-field-row-auto">
                            <label class="effect-label">Escola</label>
                            <input type="text" name="system.spell_school" value="{{system.spell_school}}"/>
                        </div>
                    </div>
                    <div class="form-grid-2">
                        <div class="effect-field effect-field-row-auto">
                            <label class="effect-label">Fonte</label>
                            <input type="text" name="system.source" value="{{system.source}}"/>
                        </div>
                        <div class="effect-field effect-field-row-auto">
                            <label class="effect-label"><a class="open-reference-link" title="Abrir Referência"><i class="fas fa-book-open"></i></a> - REF</label>
                            <div class="input-with-button">
                                <input type="text" name="system.ref" value="{{system.ref}}"/>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h4 class="section-title">Execução e Custo de Mana</h4>
                <div class="effect-row-grid effect-duration-grid is-two-col-rows">
                    <div class="form-grid-2">
                        <div class="effect-field effect-field-row-auto">
                            <label class="effect-label">Tempo de Conjuração</label>
                            <input type="text" name="system.casting_time" value="{{system.casting_time}}"/>
                        </div>
                        <div class="effect-field effect-field-row-auto">
                            <label class="effect-label">Custo de Mana</label>
                            <input type="text" name="system.mana_cost" value="{{system.mana_cost}}"/>
                        </div>
                        <div class="effect-field effect-field-row-auto">
                            <label class="effect-label">Duração</label>
                            <input type="text" name="system.duration" value="{{system.duration}}"/>
                        </div>
                        <div class="effect-field effect-field-row-auto">
                            <label class="effect-label">Manutenção</label>
                            <input type="text" name="system.mana_maint" value="{{system.mana_maint}}"/>
                        </div>
                    </div>
                </div>
            </div>

            {{!-- SEÇÃO DE CONJURAÇÃO/ATIVAÇÃO DA MAGIA --}}
            <section class="effect-card effect-section">
                <div class="effect-section-header">
                    <div>
                        <h4 class="effect-section-title">Conjuração</h4>
                    </div>
                </div>
                
                {{! -- SEÇÃO DE ATRIBUTO BASE DA MAGIA --}}
                <div class="effect-section-body">
                <div class="effect-row-grid effect-duration-grid is-two-col-rows">
                    <div class="form-grid-2">
                        <div class="effect-field effect-field-row-auto">
                            <label class="effect-label">Atributo Base <a class="link-skill-button" title="Vincular Perícia do Ator"><i class="fas fa-link"></i></a></label>
                            <input type="text" name="system.base_attribute" value="{{system.base_attribute}}" placeholder="IQ, DX, Perícia ou Valor fixo"/>
                        </div>
                        <div class="effect-field effect-field-row-auto">
                            <label class="effect-label">Dificuldade</label>
                            <div class="form-fields">
                                {{#if (ne system.auto_points false)}}
                                    <select name="system.difficulty">
                                        {{selectOptions skillDifficulties selected=system.difficulty}}
                                    </select>
                                {{else}}
                                    <input type="text" name="system.difficulty_manual" value="{{system.difficulty_manual}}" placeholder="Ex: Média, Difícil"/>
                                {{/if}}
                            </div>
                        </div>
                        <div class="effect-field effect-field-row-auto">
                            <label class="effect-label">Resistido Por</label>
                            <input type="text" name="system.resistance" value="{{system.resistance}}"/>
                        </div>
                        <div class="effect-field effect-field-row-auto">
                            <label class="effect-label">Condição</label>
                            <input type="text" name="system.effect" value="{{system.effect}}" placeholder="Ex: Atordoado"/>
                        </div>
                    </div>
                </div>

                {{! -- SEÇÃO DE AUTOMATIZAÇÃO DE CÁLCULO -- }}
                <div class="skill-ability-toggle">
                    <label class="custom-checkbox inline-checkbox">
                        <input type="checkbox" name="system.auto_points" {{checked (ne system.auto_points false)}}/>
                        <span>Calcular Pontos Automaticamente</span>
                    </label>
                </div>

                {{! -- SEÇÃO DE NÍVEL DE HABILIADDE -- }}
                <div class="skill-ability-grid trio">
                    <div class="skill-stat-card level-card">
                        <div class="stat-label">Nível (Relativo)</div>
                        <div class="stat-value counter-wrapper">
                            <a class="adjust-value" data-action="decrease" data-target="system.skill_level"><i class="fas fa-minus"></i></a>
                            <input type="number" name="system.skill_level" value="{{system.skill_level}}" data-dtype="Number">
                            <a class="adjust-value" data-action="increase" data-target="system.skill_level"><i class="fas fa-plus"></i></a>
                        </div>
                    </div>
                    <div class="skill-stat-card">
                        <div class="stat-label">Pontos</div>
                        <input type="number" name="system.points" value="{{system.points}}" {{#if (ne system.auto_points false)}}disabled{{/if}}/>
                    </div>
                    <div class="skill-stat-card">
                        <div class="stat-label">Mods. NH</div>
                        <input type="number" name="system.other_mods" value="{{system.other_mods}}" placeholder="+0"/>
                    </div>
                </div>

                {{! SEÇÃO EXTRA DE ROLAGEM DE ATAQUE}}
                <div class="effect-row-grid effect-duration-grid is-two-col-rows advanced-options">
                    <p class="section-hint">Para Magias que precisam realizar um ataque própio após sua conjuração.</p>
                    <div class="effect-row-grid effect-duration-grid is-two-col-rows">
                        <div class="effect-field effect-field-row-auto">
                            <label class="effect-label">Perícia de Ataque <a class="link-skill-button" title="Vincular Perícia do Ator"><i class="fas fa-link"></i></a></label>
                            <input type="text" name="system.attack_roll.skill_name" value="{{system.attack_roll.skill_name}}" placeholder="Ex: Ataque Inato (Projétil), DX, 14"/>
                        </div>
                        <div class="effect-field effect-field-row-auto">
                            <label class="effect-label">Mod. de NH do Ataque</label>
                            <input type="number" name="system.attack_roll.skill_level_mod" value="{{system.attack_roll.skill_level_mod}}"/>
                        </div>
                    </div>
                </div>
              </div>
            </section>

            {{!-- SEÇÃO DE DANO DA MAGIA --}}
            
            <section class="effect-card effect-section">
                <div class="effect-section-header">
                    <div>
                        <h4 class="effect-section-title">Dano</h4>
                    </div>
                </div>

                <div class="effect-section-body">
                    <div class="effect-row-grid effect-duration-grid is-two-col-rows">
                        <div class="effect-field effect-field-row-auto">
                            <label class="effect-label">Dano Primário</label>

                                <div class="form-grid-3">
                                    <div class="form-group">
                                        <label>Fórmula</label>
                                        <input type="text" name="system.damage.formula" value="{{system.damage.formula}}"/>
                                    </div>
                                    <div class="form-group">
                                        <label>Tipo</label>
                                        <input type="text" name="system.damage.type" value="{{system.damage.type}}"/>
                                    </div>
                                    <div class="form-group" title="Divisor de Armadura">
                                        <label>Divisor</label>
                                        <input type="number" step="0.1" name="system.damage.armor_divisor" value="{{system.damage.armor_divisor}}"/>
                                    </div>
                                </div>
                        </div>
                    </div>
                    <div class="effect-row-grid effect-duration-grid is-two-col-rows">
                        <div class="effect-field effect-field-row-auto">
                            <label class="effect-label">Dano de Acompanhamento</label>
                            <div class="form-grid-3">
                                <div class="form-group">
                                    <label>Fórmula</label>
                                    <input type="text" name="system.damage.follow_up_damage.formula" value="{{system.damage.follow_up_damage.formula}}"/>
                                </div>
                                <div class="form-group">
                                    <label>Tipo</label>
                                    <input type="text" name="system.damage.follow_up_damage.type" value="{{system.damage.follow_up_damage.type}}"/>
                                </div>
                                <div class="form-group" title="Divisor">
                                    <label>Divisor</label>
                                    <input type="number" step="0.1" name="system.damage.follow_up_damage.armor_divisor" value="{{system.damage.follow_up_damage.armor_divisor}}"/>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="effect-row-grid effect-duration-grid is-two-col-rows">
                        <div class="effect-field effect-field-row-auto">
                            <label class="effect-label">Dano de Fragmentação</label>
                            <div class="form-grid-3">
                                <div class="form-group">
                                    <label>Fórmula</label>
                                    <input type="text" name="system.damage.fragmentation_damage.formula" value="{{system.damage.fragmentation_damage.formula}}"/>
                                </div>
                                <div class="form-group">
                                    <label>Tipo</label>
                                    <input type="text" name="system.damage.fragmentation_damage.type" value="{{system.damage.fragmentation_damage.type}}"/>
                                </div>
                                <div class="form-group" title="Divisor">
                                    <label>Divisor</label>
                                    <input type="number" step="0.1" name="system.damage.fragmentation_damage.armor_divisor" value="{{system.damage.fragmentation_damage.armor_divisor}}"/>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
             </section>
        {{/if}}
        
        {{!-- ===================================================================== --}}
        {{!--           ABA DETALHES: ITEM PODERES (COM INPUT HÍBRIDO)                  --}}
        {{!-- ===================================================================== --}}
        {{#if (eq item.type "power")}}

        <div class="form-section">
            <h4 class="section-title">Classificação e Custo</h4>

            <div class="effect-row-grid effect-duration-grid is-two-col-rows">
                <div class="form-grid-2">
                    <div class="effect-field effect-field-row-auto">
                        <label class="effect-label">Pontos Base</label>
                        <input type="number" name="system.points" value="{{system.points}}"/>
                    </div>

                    <div class="effect-field effect-field-row-auto">
                        <label class="effect-label">Custo Final</label>
                        <div class="calculated-cost value">
                            <span>{{calculatedCost.finalPoints}}</span>
                            <small>(Mod: {{calculatedCost.totalModifier}}%)</small>
                        </div>
                    </div>
                </div>

                <div class="form-grid-2">
                    <div class="effect-field effect-field-row-auto">
                        <label class="effect-label">Fonte</label>
                        <input type="text" name="system.source" value="{{system.source}}"/>
                    </div>

                    <div class="effect-field effect-field-row-auto">
                        <label class="effect-label">
                            <a class="open-reference-link" title="Abrir Referência">
                                <i class="fas fa-book-open"></i>
                            </a> REF
                        </label>
                        <div class="input-with-button">
                            <input type="text" name="system.ref" value="{{system.ref}}"/>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="form-section">
            <h4 class="section-title">Execução e Custo de Energia</h4>

            <div class="effect-row-grid effect-duration-grid is-two-col-rows">
                <div class="form-grid-2">
                    <div class="effect-field effect-field-row-auto">
                        <label class="effect-label">Tempo de Ativação</label>
                        <input type="text" name="system.activation_time" value="{{system.activation_time}}"/>
                    </div>

                    <div class="effect-field effect-field-row-auto">
                        <label class="effect-label">Custo</label>
                        <input type="text" name="system.activation_cost" value="{{system.activation_cost}}"/>
                    </div>

                    <div class="effect-field effect-field-row-auto">
                        <label class="effect-label">Duração</label>
                        <input type="text" name="system.duration" value="{{system.duration}}"/>
                    </div>

                    <div class="effect-field effect-field-row-auto">
                        <label class="effect-label">Manutenção</label>
                        <input type="text" name="system.maint_cost" value="{{system.maint_cost}}"/>
                    </div>
                </div>
            </div>
        </div>

        <section class="effect-card effect-section">
            <div class="effect-section-header">
                <h4 class="effect-section-title">Ativação</h4>
            </div>

            <div class="effect-section-body">

                <div class="effect-row-grid effect-duration-grid is-two-col-rows">
                    <div class="form-grid-2">
                        <div class="effect-field effect-field-row-auto">
                            <label class="effect-label">
                                Atributo Base
                                <a class="link-skill-button" title="Vincular Perícia do Ator">
                                    <i class="fas fa-link"></i>
                                </a>
                            </label>
                            <input type="text"
                                name="system.base_attribute"
                                value="{{system.base_attribute}}"
                                placeholder="IQ, DX, Perícia ou Valor fixo"/>
                        </div>

                        <div class="effect-field effect-field-row-auto">
                            <label class="effect-label">Dificuldade</label>
                            {{#if (ne system.auto_points false)}}
                                <select name="system.difficulty">
                                    {{selectOptions skillDifficulties selected=system.difficulty}}
                                </select>
                            {{else}}
                                <input type="text"
                                    name="system.difficulty_manual"
                                    value="{{system.difficulty_manual}}"
                                    placeholder="Ex: Média, Difícil"/>
                            {{/if}}
                        </div>
                        <div class="effect-field effect-field-row-auto">
                            <label class="effect-label">Resistido Por</label>
                            <input type="text" name="system.resistance" value="{{system.resistance}}"/>
                        </div>
                        <div class="effect-field effect-field-row-auto">
                            <label class="effect-label">Condição</label>
                            <input type="text" name="system.effect" value="{{system.effect}}" placeholder="Ex: Atordoado"/>
                        </div>
                    </div>
                </div>

                <div class="skill-ability-toggle">
                    <label class="custom-checkbox inline-checkbox">
                        <input type="checkbox"
                            name="system.auto_points"
                            {{checked (ne system.auto_points false)}}/>
                        <span>Calcular Pontos Automaticamente</span>
                    </label>
                </div>

                <div class="skill-ability-grid trio">
                    <div class="skill-stat-card level-card">
                        <div class="stat-label">Nível (Relativo)</div>
                        <div class="stat-value counter-wrapper">
                            <a class="adjust-value" data-action="decrease" data-target="system.skill_level">
                                <i class="fas fa-minus"></i>
                            </a>
                            <input type="number"
                                name="system.skill_level"
                                value="{{system.skill_level}}"
                                data-dtype="Number">
                            <a class="adjust-value" data-action="increase" data-target="system.skill_level">
                                <i class="fas fa-plus"></i>
                            </a>
                        </div>
                    </div>

                    <div class="skill-stat-card">
                        <div class="stat-label">Pontos (NH)</div>
                        <input type="number"
                            name="system.points_skill"
                            value="{{system.points_skill}}"
                            {{#if (ne system.auto_points false)}}disabled{{/if}}/>
                    </div>

                    <div class="skill-stat-card">
                        <div class="stat-label">Mods. NH</div>
                        <input type="number"
                            name="system.other_mods"
                            value="{{system.other_mods}}"/>
                    </div>
                </div>

               {{! SEÇÃO EXTRA DE ROLAGEM DE ATAQUE}}
                <div class="effect-row-grid effect-duration-grid is-two-col-rows advanced-options">
                    <p class="section-hint">Para Poderes que precisam realizar um ataque própio após sua ativação.</p>
                    <div class="effect-row-grid effect-duration-grid is-two-col-rows">
                        <div class="effect-field effect-field-row-auto">
                            <label class="effect-label">Perícia de Ataque <a class="link-skill-button" title="Vincular Perícia do Ator"><i class="fas fa-link"></i></a></label>
                            <input type="text" name="system.attack_roll.skill_name" value="{{system.attack_roll.skill_name}}" placeholder="Ex: Ataque Inato (Projétil), DX, 14"/>
                        </div>
                        <div class="effect-field effect-field-row-auto">
                            <label class="effect-label">Mod. de NH do Ataque</label>
                            <input type="number" name="system.attack_roll.skill_level_mod" value="{{system.attack_roll.skill_level_mod}}"/>
                        </div>
                    </div>
                </div>
            </div>
        </section>


            <section class="effect-card effect-section">
                <div class="effect-section-header">
                    <div>
                        <h4 class="effect-section-title">Dano</h4>
                    </div>
                </div>

                <div class="effect-section-body">
                    <div class="effect-row-grid effect-duration-grid is-two-col-rows">
                        <div class="effect-field effect-field-row-auto">
                            <label class="effect-label">Dano Primário</label>

                                <div class="form-grid-3">
                                    <div class="form-group">
                                        <label>Fórmula</label>
                                        <input type="text" name="system.damage.formula" value="{{system.damage.formula}}"/>
                                    </div>
                                    <div class="form-group">
                                        <label>Tipo</label>
                                        <input type="text" name="system.damage.type" value="{{system.damage.type}}"/>
                                    </div>
                                    <div class="form-group" title="Divisor de Armadura">
                                        <label>Divisor</label>
                                        <input type="number" step="0.1" name="system.damage.armor_divisor" value="{{system.damage.armor_divisor}}"/>
                                    </div>
                                </div>
                        </div>
                    </div>
                    <div class="effect-row-grid effect-duration-grid is-two-col-rows">
                        <div class="effect-field effect-field-row-auto">
                            <label class="effect-label">Dano de Acompanhamento</label>
                            <div class="form-grid-3">
                                <div class="form-group">
                                    <label>Fórmula</label>
                                    <input type="text" name="system.damage.follow_up_damage.formula" value="{{system.damage.follow_up_damage.formula}}"/>
                                </div>
                                <div class="form-group">
                                    <label>Tipo</label>
                                    <input type="text" name="system.damage.follow_up_damage.type" value="{{system.damage.follow_up_damage.type}}"/>
                                </div>
                                <div class="form-group" title="Divisor">
                                    <label>Divisor</label>
                                    <input type="number" step="0.1" name="system.damage.follow_up_damage.armor_divisor" value="{{system.damage.follow_up_damage.armor_divisor}}"/>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="effect-row-grid effect-duration-grid is-two-col-rows">
                        <div class="effect-field effect-field-row-auto">
                            <label class="effect-label">Dano de Fragmentação</label>
                            <div class="form-grid-3">
                                <div class="form-group">
                                    <label>Fórmula</label>
                                    <input type="text" name="system.damage.fragmentation_damage.formula" value="{{system.damage.fragmentation_damage.formula}}"/>
                                </div>
                                <div class="form-group">
                                    <label>Tipo</label>
                                    <input type="text" name="system.damage.fragmentation_damage.type" value="{{system.damage.fragmentation_damage.type}}"/>
                                </div>
                                <div class="form-group" title="Divisor">
                                    <label>Divisor</label>
                                    <input type="number" step="0.1" name="system.damage.fragmentation_damage.armor_divisor" value="{{system.damage.fragmentation_damage.armor_divisor}}"/>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
             </section>
        {{/if}}

        {{!-- ===================================================================== --}}
        {{!-- 		ABA DETALHES: ITEM MODIFICADORES 				 --}}
        {{!-- ===================================================================== --}}
        {{#if (eq item.type "modifier")}}
        <div class="form-section"><h4 class="section-title">Dados do Modificador</h4>
        <div class="form-grid-3">
            <div class="form-group">
            <label>Custo do Modificador (%)</label>
            <input type="text" name="system.cost" value="{{system.cost}}" placeholder="+10%, -20%..."/>
            </div>
            <div class="form-group">
            <label>Nível (se aplicável)</label>
            <input type="number" name="system.level" value="{{system.level}}"/>
            </div>
            
            {{!-- Campo REF com botão --}}
            <div class="form-group">
                <label><a class="open-reference-link" title="Abrir Referência"><i class="fas fa-book-open"></i></a>         Ref. Página</label>
                <div class="input-with-button">
                    <input type="text" name="system.ref" value="{{system.ref}}"/>
                    
                </div>
            </div>
        </div>
        <div class="form-group">
            <label>Efeito Aplicado</label>
            <input type="text" name="system.applied_effect" value="{{system.applied_effect}}" placeholder="Ex: Aura, Ataque de Projétil"/>
        </div>
        
        </div>
        {{/if}}
 </div>

     {{!-- ===================================================================== --}}
     {{!-- 		ABA PROTEÇÃO: ITEM EQUIPAMENTO 				 --}}
     {{!-- ===================================================================== --}}
     {{#if (eq item.type "equipment")}}
     <div class="tab" data-tab="protection">
        <div class="form-section protection-grid">
            <div class="attacks-editor-section">
                <div class="attack-section-header">
                    <h4 class="attack-section-title">Proteção por Localização</h4>
                    <a class="attack-add-button add-dr-location" title="Adicionar RD"><i class="fas fa-plus"></i></a>
                </div>
            </div>

            <ol class="attack-list dr-locations-table">
                {{#each drLocationRows as |row|}}
                    <li class="attack-item dr-location-item" data-dr-location-row>
                        <div class="attack-display-card">
                            <div class="attack-line">
                                <div class="attack-cell">
                                    <input class="dr-location-label" type="text" list="gum-body-location-options" value="{{row.label}}" placeholder="Ex: Braço E"/>
                                    <input class="dr-location-key" type="hidden" value="{{row.key}}"/>
                                </div>
                                <div class="attack-cell">
                                    <input class="dr-location-value" type="text" value="{{row.dr}}" placeholder="0"/>
                                </div>
                                <div class="attack-cell">
                                    <button class="dr-location-delete" type="button" title="Remover"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        </div>
                    </li>
                {{/each}}
            </ol>

            <datalist id="gum-body-location-options">
                {{#each bodyLocationOptions as |loc|}}
                    <option value="{{loc.name}}" data-key="{{loc.id}}"></option>
                {{/each}}
            </datalist>
        </div>
     </div>
     {{/if}}

     {{! ========================================================= }}
    {{!  ABA "DESCRIÇÃO" (COM O EDITOR CORRETO)     }}
    {{! ========================================================= }}
    <div class="tab" data-tab="description">
      <div class="description-tab">
        <div class="description-grid">
          <div class="form-section description-section">
            <div class="description-header">
              <div>
                <h4 class="section-title">Descrição Resumida (Chat)</h4>
                <p class="hint">Use para tooltips e mensagens rápidas.</p>
              </div>
              {{#if editable}}
              <div class="description-actions">
                <button type="button" class="toggle-editor" data-field="system.chat_description">
                  <i class="fas fa-pen"></i>
                </button>
              </div>
              {{/if}}
            </div>
            <div class="description-view">{{{system.chat_description}}}</div>

            <div class="description-editor" style="display:none;">
              {{editor system.chat_description target="system.chat_description" engine="prosemirror" owner=owner editable=editable}}
              <div class="description-actions">
                <button type="button" class="save-description" data-field="system.chat_description"><i class="fas fa-save"></i> Salvar</button>
                <button type="button" class="expand-description" data-expanded="false"><i class="fas fa-expand"></i> Expandir</button>
                <button type="button" class="cancel-description"><i class="fas fa-times"></i> Cancelar</button>
              </div>
            </div>
          </div>

          <div class="form-section description-section">
            <div class="description-header">
              <div>
                <h4 class="section-title">Descrição Completa</h4>
                <p class="hint">Inclua detalhes extensos, efeitos narrativos e referências.</p>
              </div>
              {{#if editable}}
              <div class="description-actions">
                <button type="button" class="toggle-editor" data-field="system.description">
                  <i class="fas fa-pen"></i>
                </button>
              </div>
              {{/if}}
            </div>
            <div class="description-view">{{{system.description}}}</div>

            <div class="description-editor" style="display:none;">
              {{editor system.description target="system.description" engine="prosemirror" owner=owner editable=editable}}
              <div class="description-actions">
                <button type="button" class="save-description" data-field="system.description"><i class="fas fa-save"></i> Salvar</button>
                <button type="button" class="expand-description" data-expanded="false"><i class="fas fa-expand"></i> Expandir</button>
                <button type="button" class="cancel-description"><i class="fas fa-times"></i> Cancelar</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

     {{!-- ===================================================================== --}}
     {{!--    ABA ESPECIAL: MODOS DE ATAQUE (para Equipamentos) --}}
     {{!-- ===================================================================== --}}
     <div class="tab" data-tab="attacks">
        
        {{!-- SEÇÃO DE ATAQUES CORPO A CORPO (MELEE) --}}
        <div class="attacks-editor-section">
         <div class="attack-section-header">
            <h4 class="attack-section-title">Ataques Corpo a Corpo</h4>
            <a class="attack-add-button add-attack" data-type="melee" title="Adicionar Ataque Corpo a Corpo"><i class="fas fa-plus"></i></a>
         </div>
         <ol class="attack-list">
           {{#each system.melee_attacks as |attack key|}}
           <li class="attack-item melee-attack-item" data-attack-id="{{key}}" data-attack-type="melee">
             
{{!-- MODO EXIBIÇÃO - ATAQUE C.C. (NOVO CARD HORIZONTAL) --}}
<div class="attack-display-mode">
  <div class="attack-display-card">
    <div class="attack-line">

      {{!-- Perícia + modo + flags --}}
<div class="attack-cell attack-identity">
  <div class="attack-skill-line">
    <span class="attack-skill">
      {{#if (isNumeric attack.skill_name)}}
        Valor Fixo
      {{else}}
        {{#if attack.skill_name}}{{attack.skill_name}}{{else}}<i>(N/A)</i>{{/if}}
        {{#if (signedMod attack.skill_level_mod)}}
        <span class="attack-skill-mod">{{signedMod attack.skill_level_mod}}</span>
      {{/if}}
      {{/if}}
    </span>

    <span class="attack-flags">
      {{#if (objectValues attack.onDamageEffects)}}
        <span class="pill-stat effect-indicator" title="Este ataque aplica um ou mais efeitos."><i class="fas fa-magic"></i></span>
      {{/if}}
      {{#if attack.unbalanced}}
        <span class="pill-stat flag-u" title="Desbalanceada (Não pode aparar no próximo turno)">U</span>
      {{/if}}
      {{#if attack.fencing}}
        <span class="pill-stat flag-f" title="Esgrima (Bônus em aparar sucessivo)">F</span>
      {{/if}}
    </span>
  </div>
  
  <div class="attack-mode-sub">{{attack.mode}}</div>
</div>

      {{!-- NH --}}
        <div class="attack-cell is-center">
        <div class="attack-label">NH</div>
        <div class="attack-value">
            {{#if (isNumeric attack.skill_name)}}
            {{attack.skill_name}}
            {{else}}
             {{#if attack.final_nh}}
                {{attack.final_nh}}
                {{else}}
                 <span class="nh-pending" title="Calculado quando o item estiver em uma ficha.">⧗</span>
                  {{/if}}
            {{/if}}
        </div>
        </div>

      {{!-- Dano --}}
      <div class="attack-cell">
        <div class="attack-label">Dano</div>
        <div class="attack-value attack-damage-main">
          ({{attack.damage_formula}}) {{attack.damage_type}}
        </div>

        {{#with attack.follow_up_damage}}
          {{#if this.formula}}
            <div class="attack-damage-sub">(FU: {{this.formula}}) {{this.type}}</div>
          {{/if}}
        {{/with}}

        {{#with attack.fragmentation_damage}}
          {{#if this.formula}}
            <div class="attack-damage-sub">[FR: {{this.formula}} {{this.type}}]</div>
          {{/if}}
        {{/with}}
      </div>

      {{!-- APR --}}
      <div class="attack-cell is-center">
        <div class="attack-label">APR</div>
        <div class="attack-value">{{attack.parry}}</div>
      </div>

      {{!-- BLQ --}}
      <div class="attack-cell is-center">
        <div class="attack-label">BLQ</div>
        <div class="attack-value">{{attack.block}}</div>
      </div>

      {{!-- ALC --}}
      <div class="attack-cell is-center">
        <div class="attack-label">ALC</div>
        <div class="attack-value">{{attack.reach}}</div>
      </div>

      {{!-- ST MIN --}}
      <div class="attack-cell is-center">
        <div class="attack-label">ST Min</div>
        <div class="attack-value">{{attack.min_strength}}</div>
      </div>

      {{!-- Ações --}}
      <div class="attack-cell attack-actions">
        <span class="attack-controls">
          <a class="edit-attack-mode" title="Editar Modo"><i class="fas fa-edit"></i></a>
          <a class="delete-attack" data-list="melee_attacks" title="Remover Modo"><i class="fas fa-trash"></i></a>
        </span>
      </div>

    </div>
  </div>
</div>
                 {{!-- MODO EDIÇÃO (O FORMULÁRIO) --}}
                 <div class="attack-edit-mode" style="display:none;">
                     
                     {{!-- GRUPO 1: HABILIDADE --}}
                     <div class="ability-grid">
                         <div class="ability-col-left">
                             <div class="form-group">
                                 <label>Modo de Uso</label>
                                 <input type="text" data-name="system.melee_attacks.{{key}}.mode" value="{{attack.mode}}"/>
                             </div>
                             <div class="form-group">
                                 <label>Perícia Vinculada <a class="link-skill-button" title="Vincular Perícia do Ator"><i class="fas fa-link"></i></a></label>
                                 <input type="text" data-name="system.melee_attacks.{{key}}.skill_name" value="{{attack.skill_name}}" placeholder="Nome da Perícia ou Atributo (ex: DX)"/>
                             </div>
                             <div class="form-group">
                                 <label>Mod. NH</label>
                                 <input type="number" data-name="system.melee_attacks.{{key}}.skill_level_mod" value="{{attack.skill_level_mod}}"/>
                             </div>
                         </div>
                     </div>

                     {{!-- GRUPO 2: ATRIBUTOS DE COMBATE --}}
                     <div class="form-grid-3 attack-stats-grid-compact">
                         <div class="form-group">
                             <label>Dano</label>
                             <input type="text" data-name="system.melee_attacks.{{key}}.damage_formula" value="{{attack.damage_formula}}"/>
                         </div>
                         <div class="form-group input-narrow">
                             <label>Tipo</label>
                             <input type="text" data-name="system.melee_attacks.{{key}}.damage_type" value="{{attack.damage_type}}"/>
                         </div>
                         <div class="form-group input-narrow" title="Divisor de Armadura">
                             <label>Div.</label>
                             <input type="number" step="0.1" data-name="system.melee_attacks.{{key}}.armor_divisor" value="{{attack.armor_divisor}}"/>
                         </div>
                         <div class="form-group input-narrow">
                             <label>Aparar</label>
                             <input type="text" data-name="system.melee_attacks.{{key}}.parry" value="{{attack.parry}}"/>
                         </div>
                         <div class="form-group input-narrow">
                             <label>Bloqueio</label>
                             <input type="text" data-name="system.melee_attacks.{{key}}.block" value="{{attack.block}}"/>
                         </div>
                         <div class="form-group input-narrow">
                             <label>Alcance</label>
                             <input type="text" data-name="system.melee_attacks.{{key}}.reach" value="{{attack.reach}}"/>
                         </div>
                         <div class="form-group input-narrow">
                             <label>ST Mín.</label>
                             <input type="number" data-name="system.melee_attacks.{{key}}.min_strength" value="{{attack.min_strength}}"/>
                         </div>
                     </div>

                     {{!-- GRUPO DE CARACTERÍSTICAS (Checkboxes) --}}
                     <div class="form-grid-3 attack-flags-grid">
                         <label class="custom-checkbox">
                             <input type="checkbox" data-name="system.melee_attacks.{{key}}.unbalanced" {{checked attack.unbalanced}}/>
                             <span>Desbalanceada (U)</span>
                         </label>
                         <label class="custom-checkbox">
                             <input type="checkbox" data-name="system.melee_attacks.{{key}}.fencing" {{checked attack.fencing}}/>
                             <span>Esgrima (F)</span>
                         </label>
                     </div>  

                     {{!-- GRUPO 3: AVANÇADO --}}
                     <details class="advanced-options item-sheet-advanced">
                         <summary>Danos Avançados & Efeitos</summary>
                         <div class="advanced-content">
                             <h5 class="subheader">Dano de Acompanhamento</h5>
                             <div class="form-grid-3">
                                 <div class="form-group"><label>Fórmula</label><input type="text" data-name="system.melee_attacks.{{key}}.follow_up_damage.formula" value="{{attack.follow_up_damage.formula}}"/></div>
                                 <div class="form-group input-narrow"><label>Tipo</label><input type="text" data-name="system.melee_attacks.{{key}}.follow_up_damage.type" value="{{attack.follow_up_damage.type}}"/></div>
                                 <div class="form-group input-narrow" title="Divisor"><label>Div.</label><input type="number" step="0.1" data-name="system.melee_attacks.{{key}}.follow_up_damage.armor_divisor" value="{{attack.follow_up_damage.armor_divisor}}"/></div>
                             </div>
                             <h5 class="subheader">Dano de Fragmentação</h5>
                             <div class="form-grid-3">
                                 <div class="form-group"><label>Fórmula</label><input type="text" data-name="system.melee_attacks.{{key}}.fragmentation_damage.formula" value="{{attack.fragmentation_damage.formula}}"/></div>
                                 <div class="form-group input-narrow"><label>Tipo</label><input type="text" data-name="system.melee_attacks.{{key}}.fragmentation_damage.type" value="{{attack.fragmentation_damage.type}}"/></div>
                                 <div class="form-group input-narrow" title="Divisor"><label>Div.</label><input type="number" step="0.1" data-name="system.melee_attacks.{{key}}.fragmentation_damage.armor_divisor" value="{{attack.fragmentation_damage.armor_divisor}}"/></div>
                             </div>
                             <hr class="section-divider">
                             <h5 class="subheader">Efeitos ao Causar Dano (onDamage)</h5>
                             <div class="effects-list-container">
                                 {{#each (objectValues attack.onDamageEffects)}}
                                 <div class="effect-summary" data-effect-id="{{this.id}}">
                                     <img src="{{this.img}}" alt="{{this.name}}"/>
                                     <span>{{this.name}}</span>
                                     <div class="controls">
                                         <a class="view-original-effect" data-uuid="{{this.effectUuid}}"><i class="fas fa-eye"></i></a>
                                         <a class="delete-attack-effect" data-list="onDamageEffects"><i class="fas fa-trash"></i></a>
                                     </div>
                                 </div>
                                 {{/each}}
                                 <a class="add-attack-effect button" data-list="onDamageEffects"><i class="fas fa-plus"></i> Adicionar</a>
                             </div>
                         </div>
                     </details>
                     
                     <div class="attack-controls-edit">
                         <a class="save-attack-mode button"><i class="fas fa-check"></i> Salvar</a>
                         <a class="cancel-attack-edit button ghost"><i class="fas fa-times"></i> Cancelar</a>
                     </div>
                 </div>
                 </li>
                   {{else}}
                    <li class="attack-empty">
                    Nenhum ataque corpo a corpo adicionado.
                    </li>
                 {{/each}}          
             </ol>
        </div>

        {{!-- SEÇÃO DE ATAQUES À DISTÂNCIA (RANGED) --}}
        <div class="attacks-editor-section">
         <div class="attack-section-header">
            <h4 class="attack-section-title">Ataques à Distância</h4>
            <a class="attack-add-button add-attack" data-type="ranged" title="Adicionar Ataque à Distância"><i class="fas fa-plus"></i></a>
         </div>
         <ol class="attack-list">
           {{#each system.ranged_attacks as |attack key|}}
           <li class="attack-item ranged-attack-item" data-attack-id="{{key}}" data-attack-type="ranged">
             
{{!-- MODO EXIBIÇÃO - ATAQUE L.D. (NOVO CARD HORIZONTAL) --}}
<div class="attack-display-mode">
  <div class="attack-display-card">
    <div class="attack-line">

      {{!-- Perícia + modo + flags --}}
      <div class="attack-cell attack-identity">
        <div class="attack-skill-line">
          <span class="attack-skill">
            {{#if (isNumeric attack.skill_name)}}
              Valor Fixo
            {{else}}
              {{#if attack.skill_name}}{{attack.skill_name}}{{else}}<i>(N/A)</i>{{/if}}
              {{#if (signedMod attack.skill_level_mod)}}
                <span class="attack-skill-mod">{{signedMod attack.skill_level_mod}}</span>
              {{/if}}
            {{/if}}
          </span>

          <span class="attack-flags">
            {{#if (objectValues attack.onDamageEffects)}}
              <span class="pill-stat effect-indicator" title="Este ataque aplica um ou mais efeitos."><i class="fas fa-magic"></i></span>
            {{/if}}
            {{#if attack.unbalanced}}
              <span class="pill-stat flag-u" title="Desbalanceada (Não pode aparar no próximo turno)">U</span>
            {{/if}}
            {{#if attack.fencing}}
              <span class="pill-stat flag-f" title="Esgrima (Bônus em aparar sucessivo)">F</span>
            {{/if}}
          </span>
        </div>

        <div class="attack-mode-sub">{{attack.mode}}</div>
        {{#if attack.range}}
            <div class="attack-line-sub">Alc.: {{attack.range}}</div>
        {{/if}}
      </div>

      {{!-- NH --}}
      <div class="attack-cell is-center">
        <div class="attack-label">NH</div>
        <div class="attack-value">
          {{#if (isNumeric attack.skill_name)}}
            {{attack.skill_name}}
          {{else}}
            {{#if attack.final_nh}}
              {{attack.final_nh}}
            {{else}}
              <span class="nh-pending" title="Calculado quando o item estiver em uma ficha.">⧗</span>
            {{/if}}
          {{/if}}
        </div>
      </div>

      {{!-- Dano --}}
      <div class="attack-cell">
        <div class="attack-label">Dano</div>
        <div class="attack-value attack-damage-main">
          ({{attack.damage_formula}}) {{attack.damage_type}}
        </div>

        {{#with attack.follow_up_damage}}
          {{#if this.formula}}
            <div class="attack-damage-sub">(FU: {{this.formula}}) {{this.type}}</div>
          {{/if}}
        {{/with}}

        {{#with attack.fragmentation_damage}}
          {{#if this.formula}}
            <div class="attack-damage-sub">[FR: {{this.formula}} {{this.type}}]</div>
          {{/if}}
        {{/with}}
      </div>

      {{!-- PREC --}}
      <div class="attack-cell is-center">
        <div class="attack-label">PREC</div>
        <div class="attack-value">{{attack.accuracy}}</div>
      </div>

      {{!-- CdT×T --}}
      <div class="attack-cell is-center">
        <div class="attack-label">CdT×T</div>
        <div class="attack-value">
          {{#if attack.rof}}{{attack.rof}}{{else}}—{{/if}}×{{#if attack.shots}}{{attack.shots}}{{else}}—{{/if}}
        </div>
      </div>

      {{!-- RCO --}}
      <div class="attack-cell is-center">
        <div class="attack-label">RCO</div>
        <div class="attack-value">{{attack.rcl}}</div>
      </div>

      {{!-- Mag --}}
      <div class="attack-cell is-center">
        <div class="attack-label">Mag</div>
        <div class="attack-value">{{attack.mag}}</div>
      </div>

      {{!-- ST MIN --}}
      <div class="attack-cell is-center">
        <div class="attack-label">ST Min</div>
        <div class="attack-value">{{attack.min_strength}}</div>
      </div>

      {{!-- Ações --}}
      <div class="attack-cell attack-actions">
        <span class="attack-controls">
          <a class="edit-attack-mode" title="Editar Modo"><i class="fas fa-edit"></i></a>
          <a class="delete-attack" data-list="ranged_attacks" title="Remover Modo"><i class="fas fa-trash"></i></a>
        </span>
      </div>

    </div>
  </div>
</div>


                 {{!-- MODO EDIÇÃO (O FORMULÁRIO) L.D. --}}
                 <div class="attack-edit-mode" style="display:none;">
                     
                     {{!-- GRUPO 1: HABILIDADE --}}
                     <div class="ability-grid">
                         <div class="ability-col-left">
                             <div class="form-group">
                                 <label>Modo de Uso</label>
                                 <input type="text" data-name="system.ranged_attacks.{{key}}.mode" value="{{attack.mode}}"/>
                             </div>
                             <div class="form-group">
                                 <label>Perícia Vinculada <a class="link-skill-button" title="Vincular Perícia do Ator"><i class="fas fa-link"></i></a></label>
                                 <input type="text" data-name="system.ranged_attacks.{{key}}.skill_name" value="{{attack.skill_name}}" placeholder="Nome da Perícia ou Atributo (ex: DX)"/>
                             </div>
                             <div class="form-group input-narrow">
                                 <label>Mod. NH</label>
                                 <input type="number" data-name="system.ranged_attacks.{{key}}.skill_level_mod" value="{{attack.skill_level_mod}}"/>
                             </div>
                         </div>
                     </div>

                     {{!-- GRUPO 2: ATRIBUTOS DE COMBATE --}}
                     <div class="form-grid-3 attack-stats-grid-compact">
                         <div class="form-group">
                             <label>Dano</label>
                             <input type="text" data-name="system.ranged_attacks.{{key}}.damage_formula" value="{{attack.damage_formula}}"/>
                         </div>
                         <div class="form-group input-narrow">
                             <label>Tipo</label>
                             <input type="text" data-name="system.ranged_attacks.{{key}}.damage_type" value="{{attack.damage_type}}"/>
                         </div>
                         <div class="form-group input-narrow" title="Divisor de Armadura">
                             <label>Div.</label>
                             <input type="number" step="0.1" data-name="system.ranged_attacks.{{key}}.armor_divisor" value="{{attack.armor_divisor}}"/>
                         </div>
                         <div class="form-group input-narrow">
                             <label>Prec.</label>
                             <input type="text" data-name="system.ranged_attacks.{{key}}.accuracy" value="{{attack.accuracy}}"/>
                         </div>
                         <div class="form-group">
                             <label>Alcance</label>
                             <input type="text" data-name="system.ranged_attacks.{{key}}.range" value="{{attack.range}}"/>
                         </div>
                         <div class="form-group input-narrow">
                             <label>CdT</label>
                             <input type="text" data-name="system.ranged_attacks.{{key}}.rof" value="{{attack.rof}}"/>
                         </div>
                         <div class="form-group input-narrow">
                             <label>Tiros</label>
                             <input type="text" data-name="system.ranged_attacks.{{key}}.shots" value="{{attack.shots}}"/>
                         </div>
                         <div class="form-group input-narrow">
                             <label>Recuo</label>
                             <input type="text" data-name="system.ranged_attacks.{{key}}.rcl" value="{{attack.rcl}}"/>
                         </div>
                         <div class="form-group input-narrow">
                             <label>Mag.</label>
                             <input type="text" data-name="system.ranged_attacks.{{key}}.mag" value="{{attack.mag}}"/>
                         </div>
                         <div class="form-group input-narrow">
                             <label>ST Mín.</label>
                             <input type="number" data-name="system.ranged_attacks.{{key}}.min_strength" value="{{attack.min_strength}}"/>
                         </div>
                     </div>

                     {{!-- GRUPO DE CARACTERÍSTICAS (Checkboxes) --}}
                     <div class="form-grid-3 attack-flags-grid">
                         <label class="custom-checkbox">
                             <input type="checkbox" data-name="system.ranged_attacks.{{key}}.unbalanced" {{checked attack.unbalanced}}/>
                             <span>Desbalanceada (U)</span>
                         </label>
                         <label class="custom-checkbox">
                             <input type="checkbox" data-name="system.ranged_attacks.{{key}}.fencing" {{checked attack.fencing}}/>
                             <span>Esgrima (F)</span>
                         </label>
                     </div>

                     {{!-- GRUPO 3: AVANÇADO --}}
                     <details class="advanced-options item-sheet-advanced">
                         <summary>Danos Avançados & Efeitos</summary>
                         <div class="advanced-content">
                             <h5 class="subheader">Dano de Acompanhamento</h5>
                             <div class="form-grid-3">
                                 <div class="form-group"><label>Fórmula</label><input type="text" data-name="system.ranged_attacks.{{key}}.follow_up_damage.formula" value="{{attack.follow_up_damage.formula}}"/></div>
                                 <div class="form-group input-narrow"><label>Tipo</label><input type="text" data-name="system.ranged_attacks.{{key}}.follow_up_damage.type" value="{{attack.follow_up_damage.type}}"/></div>
                                 <div class="form-group input-narrow" title="Divisor"><label>Div.</label><input type="number" step="0.1" data-name="system.ranged_attacks.{{key}}.follow_up_damage.armor_divisor" value="{{attack.follow_up_damage.armor_divisor}}"/></div>
                             </div>
                             <h5 class="subheader">Dano de Fragmentação</h5>
                             <div class="form-grid-3">
                                 <div class="form-group"><label>Fórmula</label><input type="text" data-name="system.ranged_attacks.{{key}}.fragmentation_damage.formula" value="{{attack.fragmentation_damage.formula}}"/></div>
                                 <div class="form-group input-narrow"><label>Tipo</label><input type="text" data-name="system.ranged_attacks.{{key}}.fragmentation_damage.type" value="{{attack.fragmentation_damage.type}}"/></div>
                                 <div class="form-group input-narrow" title="Divisor"><label>Div.</label><input type="number" step="0.1" data-name="system.ranged_attacks.{{key}}.fragmentation_damage.armor_divisor" value="{{attack.fragmentation_damage.armor_divisor}}"/></div>
                             </div>
                             <hr class="section-divider">
                             <h5 class="subheader">Efeitos ao Causar Dano (onDamage)</h5>
                             <div class="effects-list-container">
                                 {{#each (objectValues attack.onDamageEffects)}}
                                 <div class="effect-summary" data-effect-id="{{this.id}}">
                                     <img src="{{this.img}}" alt="{{this.name}}"/>
                                     <span>{{this.name}}</span>
                                     <div class="controls">
                                         <a class="view-original-effect" data-uuid="{{this.effectUuid}}"><i class="fas fa-eye"></i></a>
                                         <a class="delete-attack-effect" data-list="onDamageEffects"><i class="fas fa-trash"></i></a>
                                     </div>
                                 </div>
                                 {{/each}}
                                 <a class="add-attack-effect button" data-list="onDamageEffects"><i class="fas fa-plus"></i> Adicionar</a>
                             </div>
                         </div>
                     </details>
                     
                     <div class="attack-controls-edit">
                         <a class="save-attack-mode button"><i class="fas fa-check"></i> Salvar</a>
                         <a class="cancel-attack-edit button ghost"><i class="fas fa-times"></i> Cancelar</a>
                     </div>
                 </div>
                 </li>
                   {{else}}
                    <li class="attack-empty">
                    Nenhum ataque a Distância adicionado.
                    </li>
                 {{/each}}
             </ol>
             </div>
         </div>
     
     {{!-- ===================================================================== --}}
     {{!--     ABA ESPECIAL: EFEITO                                  --}}
     {{!-- ===================================================================== --}}
     <div class="tab" data-tab="effects">
         {{!-- Aqui nós chamamos nosso bloco reutilizável --}}
         {{> effectsTab}}
     </div>

{{!-- ===================================================================== --}}
{{!--    ABA ESPECIAL: MODIFICADORES (MESMO LAYOUT DO EQP_MODIFIERS)         --}}
{{!-- ===================================================================== --}}
<div class="tab" data-tab="modifiers">
  {{#if (or (eq item.type "advantage") (eq item.type "disadvantage") (eq item.type "power"))}}

    <div class="modifiers-tab">
      <div class="eqpmod-block">

        {{!-- Header padrão + plus minimalista --}}
        <div class="eqpmod-block-header">
          <h4 class="eqpmod-block-title">Modificadores</h4>
          <a class="eqpmod-add-button add-modifier" title="Adicionar Modificador">
            <i class="fas fa-plus"></i>
          </a>
        </div>

        {{!-- Lista em linhas (mesma do eqp_modifiers) --}}
        <ol class="eqpmod-line-list">
          {{#each sortedModifiers as |modifier|}}
            <li class="eqpmod-line-item {{#if modifier.isLimitation}}is-limitation{{else}}is-enhancement{{/if}}"
                data-modifier-id="{{modifier.id}}">
              <div class="eqpmod-line">

                {{!-- Identidade: ícone + nome --}}
                <div class="eqpmod-cell eqpmod-identity">
                  {{#if modifier.img}}
                    <img src="{{modifier.img}}" class="eqpmod-icon" />
                  {{else}}
                    <img src="icons/svg/aura.svg" class="eqpmod-icon" />
                  {{/if}}

                  <div class="eqpmod-text">
                    <div class="eqpmod-name">{{modifier.name}}</div>
                        {{!-- Subline discreta: efeito aplicado --}}
                        {{#if modifier.applied_effect}}
                            <div class="eqpmod-subline">{{modifier.applied_effect}}</div>
                        {{/if}}
                  </div>
                </div>


                {{!-- Custo (%) --}}
                <div class="eqpmod-cell eqpmod-stat is-center">
                  <div class="eqpmod-label">Custo</div>
                  <div class="eqpmod-value">{{modifier.cost}}</div>
                </div>

                {{!-- Nível --}}
                <div class="eqpmod-cell eqpmod-stat is-center">
                  <div class="eqpmod-label">Nível</div>
                  <div class="eqpmod-value">{{modifier.level}}</div>
                </div>

                {{!-- Ações --}}
                <div class="eqpmod-cell eqpmod-actions">
                  <span class="eqpmod-controls">
                    <a class="view-modifier" title="Visualizar Detalhes" data-modifier-id="{{modifier.id}}">
                      <i class="fas fa-eye"></i>
                    </a>
                    <a class="delete-modifier" title="Remover" data-modifier-id="{{modifier.id}}">
                      <i class="fas fa-trash"></i>
                    </a>
                  </span>
                </div>

              </div>
            </li>

          {{else}}
            <li class="eqpmod-empty">Nenhum modificador aplicado.</li>
          {{/each}}
        </ol>

      </div>
    </div>

  {{/if}}
</div>

       
       {{!-- ===================================================================== --}}
    {{!--           ABA ESPECIAL: MODIFICADORES DE EQUIPAMENTO                  --}}
    {{!-- ===================================================================== --}}
    <div class="tab" data-tab="eqp_modifiers">
        {{#if (or (eq item.type "equipment") (eq item.type "armor"))}}
            
<div class="modifiers-tab">
  <div class="eqpmod-block">

    {{!-- Header vermelho + plus minimalista --}}
    <div class="eqpmod-block-header">
      <h4 class="eqpmod-block-title">Modificadores de Equipamento</h4>
      <a class="eqpmod-add-button add-eqp-modifier" title="Adicionar Modificador"><i class="fas fa-plus"></i></a>
    </div>

    {{!-- Lista em linhas --}}
    <ol class="eqpmod-line-list">
      {{#each eqpModifiersList as |mod|}}
        <li class="eqpmod-line-item" data-modifier-id="{{mod.id}}">
          <div class="eqpmod-line">

            {{!-- Identidade: ícone + nome --}}
            <div class="eqpmod-cell eqpmod-identity">
              {{#if mod.img}}
                <img src="{{mod.img}}" class="eqpmod-icon" />
              {{else}}
                <img src="icons/svg/item-bag.svg" class="eqpmod-icon" />
              {{/if}}

              <div class="eqpmod-text">
                <div class="eqpmod-name">{{mod.name}}</div>
              </div>
            </div>

            {{!-- CF --}}
            <div class="eqpmod-cell eqpmod-stat is-center">
              <div class="eqpmod-label">CF</div>
              <div class="eqpmod-value">{{#if (gt mod.cost_factor 0)}}+{{/if}}{{mod.cost_factor}}</div>
            </div>

            {{!-- Peso --}}
            <div class="eqpmod-cell eqpmod-stat is-center">
              <div class="eqpmod-label">Peso</div>
              <div class="eqpmod-value">{{mod.weight_mod}}</div>
            </div>

            {{!-- Ações --}}
            <div class="eqpmod-cell eqpmod-actions">
              <span class="eqpmod-controls">
                {{!-- se você já tiver handler "view", mantenha essa classe; se não, deixa só o delete --}}
                <a class="view-eqp-modifier" title="Visualizar"><i class="fas fa-eye"></i></a>
                <a class="delete-eqp-modifier" title="Remover"><i class="fas fa-trash"></i></a>
              </span>
            </div>

          </div>

          {{!-- Opcional: notas/efeitos em linha extra bem discreta --}}
          {{#if mod.features}}
            <div class="eqpmod-subline">{{mod.features}}</div>
          {{/if}}
        </li>
      {{else}}
        <li class="eqpmod-empty">Nenhum modificador de equipamento aplicado.</li>
      {{/each}}
    </ol>

  </div>
</div>


        {{/if}}
    </div>
   </section>
</section>