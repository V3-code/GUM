<form class="{{cssClass}} actor-sheet " autocomplete="off">

  {{! A ficha inteira é um grande "grid" que define as macrorregiões --}}
  <div class="sheet-grid">

    {{! ================================================================== }}
    {{! MACRORREGIÃO 1: CABEÇALHO PRINCIPAL                              }}
    {{! ================================================================== }}
    <header class="sheet-header">
      <div class="header-grid">
        <div class="header-identity">
          {{! Classes já alinhadas com o CSS novo }}
          <input name="name" class="char-name-input" type="text" value="{{actor.name}}" placeholder="Nome do Personagem"/>
          <input name="system.details.concept" class="char-concept-input" type="text" value="{{actor.system.details.concept}}" placeholder="Conceito, Título ou Arquétipo"/>
        </div>
        <div class="header-points">
          <div class="points-cluster">
            <div class="points-display total-points">
              <label>Pontos Totais</label>
              <input type="text" name="system.points.total" value="{{actor.system.points.total}}" />
            </div>
            <div class="points-display unspent-points">
              <label>Pontos Livres</label>
              <input type="text" name="system.points.unspent" value="{{actor.system.points.unspent}}"/>
            </div>
          </div>
        </div>
      </div>
    </header>

    {{! ================================================================== }}
    {{! MACRORREGIÃO 2: SIDEBAR (NOVA ESTRUTURA DE DESIGN)               }}
    {{! ================================================================== }}
    <aside class="sheet-sidebar">
      <div class="sidebar-design-container">

        {{!-- 1. FOTO --}}
        <div class="sidebar-block profile-block">
          <div class="profile-frame">
            <img class="profile-img" src="{{actor.img}}" data-edit="img" title="{{actor.name}}"/>
          </div>
        </div>

        {{!-- 2. CARD HÍBRIDO: CARGA & ESQUIVA (MEDALHÃO CIRCULAR) --}}
        <div class="sidebar-block encumbrance-dodge-bar">
          {{!-- Lado Esquerdo --}}
          <div class="enc-col left-col">
            <a class="enc-label link edit-lifting-st">Base Carga</a>
            <span class="enc-val">{{actor.system.attributes.basic_lift.value}} kg</span>
          </div>

          {{!-- Centro: Medalhão de Esquiva --}}
          <div class="enc-col center-col">
            <div class="badge-wrapper">
              <svg class="dodge-badge-svg" viewBox="0 0 100 100">
                <circle class="badge-bg" cx="50" cy="50" r="48" />
                <circle class="badge-border" cx="50" cy="50" r="44" />
              </svg>
              <a class="rollable dodge-value" data-type="defense" data-roll-value="{{actor.system.attributes.dodge.final}}" data-label="Teste de Esquiva">
                {{actor.system.attributes.dodge.final}}
              </a>
              <div class="badge-label-curved">ESQUIVA</div>
            </div>
          </div>

          {{!-- Lado Direito --}}
          <div class="enc-col right-col">
            <span class="enc-label">Nível Carga</span>
            <span class="enc-val {{actor.system.encumbrance.level_name}}">{{actor.system.encumbrance.level_name}}</span>
          </div>
        </div>

        {{!-- 3. DADOS QUADRADOS --}}
        <div class="sidebar-block stats-cluster">
          <div class="cluster-header">
            <span class="cluster-title">ATRIBUTOS SECUNDÁRIOS</span>
            <a class="edit-secondary-stats-btn" title="Editar Atributos"><i class="fas fa-cog"></i></a>
          </div>

          <div class="dice-row">
            <div class="d6-stat" title="Velocidade Básica">
              <div class="d6-face">
                <span class="d6-val">{{actor.system.attributes.basic_speed.final}}</span>
                <span class="d6-label">VELOC.</span>
              </div>
            </div>
            <div class="d6-stat main-d6" title="Deslocamento">
              <div class="d6-face">
                <span class="d6-val">{{actor.system.attributes.basic_move.final}}</span>
                <span class="d6-label">DESLOC.</span>
              </div>
            </div>
            <div class="d6-stat" title="Modificador de Tamanho">
              <div class="d6-face">
                <span class="d6-val">{{actor.system.attributes.mt.final}}</span>
                <span class="d6-label">MT</span>
              </div>
            </div>
          </div>

          <div class="senses-container">
            <div class="sense-box">
              <a class="rollable" data-type="skill" data-roll-value="{{actor.system.attributes.vision.final}}" data-label="Teste de Visão" data-attribute-key="vision"><i class="fas fa-eye"></i> Visão</a>
              <span class="sense-value">{{actor.system.attributes.vision.final}}</span>
            </div>
            <div class="sense-box">
              <a class="rollable" data-type="skill" data-roll-value="{{actor.system.attributes.hearing.final}}" data-label="Teste de Audição" data-attribute-key="hearing"><i class="fas fa-deaf"></i> Audição</a>
              <span class="sense-value">{{actor.system.attributes.hearing.final}}</span>
            </div>
            <div class="sense-box">
              <a class="rollable" data-type="skill" data-roll-value="{{actor.system.attributes.tastesmell.final}}" data-label="Teste de Paladar/Olfato" data-attribute-key="tastesmell"><i class="fas fa-wine-bottle"></i> Olfato</a>
              <span class="sense-value">{{actor.system.attributes.tastesmell.final}}</span>
            </div>
            <div class="sense-box">
              <a class="rollable" data-type="skill" data-roll-value="{{actor.system.attributes.touch.final}}" data-label="Teste de Tato" data-attribute-key="touch"><i class="fas fa-hand-paper"></i> Tato</a>
              <span class="sense-value">{{actor.system.attributes.touch.final}}</span>
            </div>
          </div>

          <div class="basic-damage-card sidebar-basic-damage secondary-basic-damage">
            <div class="sidebar-basic-damage-header">
              <span class="sidebar-basic-damage-title">Dano Básico</span>
            </div>
            <div class="sidebar-basic-damage-values">
              <a class="sidebar-basic-damage-item rollable-basic-damage" 
                 data-roll-formula="{{actor.system.attributes.thrust_damage}}" 
                 data-label="Dano de Golpe de Ponta (GdP)">
                <span class="label">GdP</span>
                <span class="value">{{actor.system.attributes.thrust_damage}}</span>
              </a>
              <a class="sidebar-basic-damage-item rollable-basic-damage" 
                 data-roll-formula="{{actor.system.attributes.swing_damage}}" 
                 data-label="Dano de Golpe em Balanço (GeB)">
                <span class="label">GeB</span>
                <span class="value">{{actor.system.attributes.swing_damage}}</span>
              </a>
            </div>
          </div>
        </div>

        {{!-- 4. BARRAS --}}
        <div class="sidebar-block bars-block">
          <div class="bar-group">
            <div class="bar-label">
              <span>PONTOS DE VIDA</span>
              <a class="edit-resource-bar" data-stat="hp"><i class="fas fa-cog"></i></a>
            </div>
            <div class="resource-bar original-style">
              <div class="bar-fill hp" style="{{bar_style actor.system.attributes.hp.value actor.system.attributes.hp.final 'hp'}}"></div>
              <div class="bar-inputs">
                <input type="number" name="system.attributes.hp.value" value="{{actor.system.attributes.hp.value}}"/>
                <span>/</span>
                <span class="final-max-value">{{actor.system.attributes.hp.final}}</span>
              </div>
            </div>
          </div>
          <div class="bar-group">
            <div class="bar-label">
              <span>PONTOS DE FADIGA</span>
              <a class="edit-resource-bar" data-stat="fp"><i class="fas fa-cog"></i></a>
            </div>
            <div class="resource-bar original-style">
              <div class="bar-fill fp" style="{{bar_style actor.system.attributes.fp.value actor.system.attributes.fp.final 'fp'}}"></div>
              <div class="bar-inputs">
                <input type="number" name="system.attributes.fp.value" value="{{actor.system.attributes.fp.value}}"/>
                <span>/</span>
                <span class="final-max-value">{{actor.system.attributes.fp.final}}</span>
              </div>
            </div>
          </div>
        </div>

        {{!-- 6. SOBREVIVÊNCIA (AGORA COM DETAILS/SUMMARY NATIVO) --}}
        <div class="sidebar-footer">
          <details class="sidebar-collapsible" data-group-id="sidebar-survival" {{collapsibleState "sidebar-survival" @root.collapsedData}}>
            <summary class="sidebar-summary">
              <h4 class="block-title">SOBREVIVÊNCIA</h4>
              <i class="fas fa-chevron-down expand-icon"></i>
            </summary>
            
            <div class="collapsible-content">
              <div class="survival-grid">
                <div class="survival-item">
                  <label>FOME</label>
                  <div class="counter-wrapper">
                    <a class="adjust-survival" data-action="decrease" data-attr="fome"><i class="fas fa-minus"></i></a>
                    <input type="number" name="system.attributes.fome.value" value="{{actor.system.attributes.fome.value}}" min="0"/>
                    <a class="adjust-survival" data-action="increase" data-attr="fome"><i class="fas fa-plus"></i></a>
                  </div>
                </div>
                <div class="survival-item">
                  <label>SEDE</label>
                  <div class="counter-wrapper">
                    <a class="adjust-survival" data-action="decrease" data-attr="sede"><i class="fas fa-minus"></i></a>
                    <input type="number" name="system.attributes.sede.value" value="{{actor.system.attributes.sede.value}}" min="0"/>
                    <a class="adjust-survival" data-action="increase" data-attr="sede"><i class="fas fa-plus"></i></a>
                  </div>
                </div>
                <div class="survival-item">
                  <label>SONO</label>
                  <div class="counter-wrapper">
                    <a class="adjust-survival" data-action="decrease" data-attr="sono"><i class="fas fa-minus"></i></a>
                    <input type="number" name="system.attributes.sono.value" value="{{actor.system.attributes.sono.value}}" min="0"/>
                    <a class="adjust-survival" data-action="increase" data-attr="sono"><i class="fas fa-plus"></i></a>
                  </div>
                </div>
                <div class="survival-item radiation">
                  <label class="warning-label">RADIAÇÃO</label>
                  <div class="counter-wrapper">
                    <a class="adjust-survival" data-action="decrease" data-attr="radiation"><i class="fas fa-minus"></i></a>
                    <input type="number" name="system.attributes.radiation.value" value="{{actor.system.attributes.radiation.value}}" min="0"/>
                    <a class="adjust-survival" data-action="increase" data-attr="radiation"><i class="fas fa-plus"></i></a>
                  </div>
                </div>
              </div>
            </div>
          </details>
        </div>

      </div>
    </aside>

    {{! ================================================================== }}
    {{! MACRORREGIÃO 3: ÁREA PRINCIPAL (DESIGN RESTAURADO)                 }}
    {{! ================================================================== }}
    <div class="sheet-main-area">
      <div class="sheet-mini-header">
        <div class="primary-attributes-container">
          {{#with actor.system.attributes}}
            
            {{!-- Estrutura para ST --}}
<div class="attribute-box {{#if (or (eq st.override 0) st.override)}}attribute-box-override{{/if}}">
              <a class="rollable" data-type="attribute" data-roll-value="{{st.final}}" data-label="Teste de ST" data-attribute-key="st"><label>ST</label></a>
              <input class="attribute-value" type="number" name="system.attributes.st.value" value="{{st.value}}"/>
              <div class="attribute-corner-pills">
                {{#if (or (eq st.override 0) st.override)}}
                  <span class="attribute-pill attribute-override" title="Override">{{st.override}}</span>
                {{/if}}
                {{#if (ne st.passive 0)}}
                  <span class="attribute-pill attribute-passive {{#if (gt st.passive 0)}}attribute-pill-positive{{/if}}{{#if (lt st.passive 0)}}attribute-pill-negative{{/if}}" title="Passiva">{{st.passive}}</span>
                {{/if}}
                {{#if (ne st.temp 0)}}
                  <span class="attribute-pill attribute-temp {{#if (gt st.temp 0)}}attribute-pill-positive{{/if}}{{#if (lt st.temp 0)}}attribute-pill-negative{{/if}}" title="Temporário">{{st.temp}}</span>
                {{/if}}
              </div>
              <input class="attribute-modifier" type="number" name="system.attributes.st.mod" value="{{st.mod}}" title="Modificador Fixo (Racial, Vantagens, etc)"/>
            </div>

            {{!-- Estrutura para DX --}}
           <div class="attribute-box {{#if (or (eq dx.override 0) dx.override)}}attribute-box-override{{/if}}">
              <a class="rollable" data-type="attribute" data-roll-value="{{dx.final}}" data-label="Teste de DX" data-attribute-key="dx"><label>DX</label></a>
              <input class="attribute-value" type="number" name="system.attributes.dx.value" value="{{dx.value}}"/>
              <div class="attribute-corner-pills">
                {{#if (or (eq dx.override 0) dx.override)}}
                  <span class="attribute-pill attribute-override" title="Override">{{dx.override}}</span>
                {{/if}}
                {{#if (ne dx.passive 0)}}
                  <span class="attribute-pill attribute-passive {{#if (gt dx.passive 0)}}attribute-pill-positive{{/if}}{{#if (lt dx.passive 0)}}attribute-pill-negative{{/if}}" title="Passiva">{{dx.passive}}</span>
                {{/if}}
                {{#if (ne dx.temp 0)}}
                  <span class="attribute-pill attribute-temp {{#if (gt dx.temp 0)}}attribute-pill-positive{{/if}}{{#if (lt dx.temp 0)}}attribute-pill-negative{{/if}}" title="Temporário">{{dx.temp}}</span>
                {{/if}}
              </div>
              <input class="attribute-modifier" type="number" name="system.attributes.dx.mod" value="{{dx.mod}}" title="Modificador Fixo"/>
            </div>

            {{!-- Estrutura para IQ --}}
            <div class="attribute-box {{#if (or (eq iq.override 0) iq.override)}}attribute-box-override{{/if}}">
              <a class="rollable" data-type="attribute" data-roll-value="{{iq.final}}" data-label="Teste de IQ" data-attribute-key="iq"><label>IQ</label></a>
              <input class="attribute-value" type="number" name="system.attributes.iq.value" value="{{iq.value}}"/>
              <div class="attribute-corner-pills">
                {{#if (or (eq iq.override 0) iq.override)}}
                  <span class="attribute-pill attribute-override" title="Override">{{iq.override}}</span>
                {{/if}}
                {{#if (ne iq.passive 0)}}
                  <span class="attribute-pill attribute-passive {{#if (gt iq.passive 0)}}attribute-pill-positive{{/if}}{{#if (lt iq.passive 0)}}attribute-pill-negative{{/if}}" title="Passiva">{{iq.passive}}</span>
                {{/if}}
                {{#if (ne iq.temp 0)}}
                  <span class="attribute-pill attribute-temp {{#if (gt iq.temp 0)}}attribute-pill-positive{{/if}}{{#if (lt iq.temp 0)}}attribute-pill-negative{{/if}}" title="Temporário">{{iq.temp}}</span>
                {{/if}}
              </div>
              <input class="attribute-modifier" type="number" name="system.attributes.iq.mod" value="{{iq.mod}}" title="Modificador Fixo"/>
            </div>

            {{!-- Estrutura para HT --}}
            <div class="attribute-box {{#if (or (eq ht.override 0) ht.override)}}attribute-box-override{{/if}}">
              <a class="rollable" data-type="attribute" data-roll-value="{{ht.final}}" data-label="Teste de HT" data-attribute-key="ht"><label>HT</label></a>
              <input class="attribute-value" type="number" name="system.attributes.ht.value" value="{{ht.value}}"/>
              <div class="attribute-corner-pills">
                {{#if (or (eq ht.override 0) ht.override)}}
                  <span class="attribute-pill attribute-override" title="Override">{{ht.override}}</span>
                {{/if}}
                {{#if (ne ht.passive 0)}}
                  <span class="attribute-pill attribute-passive {{#if (gt ht.passive 0)}}attribute-pill-positive{{/if}}{{#if (lt ht.passive 0)}}attribute-pill-negative{{/if}}" title="Passiva">{{ht.passive}}</span>
                {{/if}}
                {{#if (ne ht.temp 0)}}
                  <span class="attribute-pill attribute-temp {{#if (gt ht.temp 0)}}attribute-pill-positive{{/if}}{{#if (lt ht.temp 0)}}attribute-pill-negative{{/if}}" title="Temporário">{{ht.temp}}</span>
                {{/if}}
              </div>
              <input class="attribute-modifier" type="number" name="system.attributes.ht.mod" value="{{ht.mod}}" title="Modificador Fixo"/>
            </div>

            {{!-- Estrutura para Vontade --}}
            <div class="attribute-box">
              <a class="rollable" data-type="attribute" data-roll-value="{{vont.final}}" data-label="Teste de Vontade" data-attribute-key="vont"><label>Vont</label></a>
              <input class="attribute-value" type="number" name="system.attributes.vont.value" value="{{vont.value}}"/>
              <div class="attribute-corner-pills">
                {{#if (ne vont.passive 0)}}
                  <span class="attribute-pill attribute-passive {{#if (gt vont.passive 0)}}attribute-pill-positive{{/if}}{{#if (lt vont.passive 0)}}attribute-pill-negative{{/if}}" title="Passiva">{{vont.passive}}</span>
                {{/if}}
                {{#if (ne vont.temp 0)}}
                  <span class="attribute-pill attribute-temp {{#if (gt vont.temp 0)}}attribute-pill-positive{{/if}}{{#if (lt vont.temp 0)}}attribute-pill-negative{{/if}}" title="Temporário">{{vont.temp}}</span>
                {{/if}}
              </div>
              <input class="attribute-modifier" type="number" name="system.attributes.vont.mod" value="{{vont.mod}}" title="Modificador Fixo"/>
            </div>

            {{!-- Estrutura para Percepção --}}
            <div class="attribute-box">
              <a class="rollable" data-type="attribute" data-roll-value="{{per.final}}" data-label="Teste de Percepção" data-attribute-key="per"><label>Per</label></a>
              <input class="attribute-value" type="number" name="system.attributes.per.value" value="{{per.value}}"/>
              <div class="attribute-corner-pills">
                {{#if (ne per.passive 0)}}
                  <span class="attribute-pill attribute-passive {{#if (gt per.passive 0)}}attribute-pill-positive{{/if}}{{#if (lt per.passive 0)}}attribute-pill-negative{{/if}}" title="Passiva">{{per.passive}}</span>
                {{/if}}
                {{#if (ne per.temp 0)}}
                  <span class="attribute-pill attribute-temp {{#if (gt per.temp 0)}}attribute-pill-positive{{/if}}{{#if (lt per.temp 0)}}attribute-pill-negative{{/if}}" title="Temporário">{{per.temp}}</span>
                {{/if}}
              </div>
              <input class="attribute-modifier" type="number" name="system.attributes.per.mod" value="{{per.mod}}" title="Modificador Fixo"/>
            </div>
          {{/with}}
        </div>
      </div>

      {{! ================================================================== }}
      {{! MACRORREGIÃO 4: NAVEGAÇÃO DAS ABAS                               }}
      {{! ================================================================== }}
      <main class="sheet-body-content">
        <nav class="sheet-tabs tabs" data-group="primary">
          <a class="item" data-tab="combat" title="Combate">
            <i class="fas fa-khanda"></i>
          </a>
          <a class="item" data-tab="skills" title="Perícias">
            <i class="fas fa-book-reader"></i>
          </a>
          <a class="item" data-tab="spells" title="Conjurações">
            <i class="fas fa-magic"></i>
          </a>
          <a class="item" data-tab="powers" title="Poderes">
            <i class="fas fa-bolt"></i>
          </a>
          <a class="item" data-tab="equipment" title="Equipamento">
            <i class="fas fa-suitcase"></i>
          </a>
          <a class="item" data-tab="characteristics" title="Características">
            <i class="fas fa-star"></i>
          </a>
          <a class="item" data-tab="social" title="Aspectos Sociais">
            <i class="fas fa-users"></i>
          </a>
          <a class="item" data-tab="biography" title="Biografia">
            <i class="fas fa-scroll"></i>
          </a>
          <a class="item" data-tab="conditions" title="Condições">
            <i class="fas fa-heart-pulse"></i>
          </a>
          <a class="item" data-tab="modifiers" title="Modificadores de Rolagens">
              <i class="fas fa-sliders-h"></i>
          </a>
        </nav>

  {{!-- ============   ESSE É O BODY DA FICHA - O QUE FICA DENTRO DE CADA ABA   =============== --}}
  <div class="sheet-body">

    {{! ========================================================= }}
    {{!  ABA DE CONFIGURAÇÃO DE MODIFICADORES (HIERARQUIA V3)     }}
    {{! ========================================================= }}
    <div class="tab modifiers-tab" data-group="primary" data-tab="modifiers">
        
        {{!-- BARRA DE FERRAMENTAS DE MODIFICADORES --}}
        <div class="modifiers-toolbar gum-block">
            
            {{!-- Esquerda: Toggle --}}
            <div class="toolbar-group left">
                <label class="toggle-label" title="Se marcado, a janela de rolagem mostrará itens do Compêndio ALÉM dos itens desta ficha.">
                    <input type="checkbox" class="toggle-default-mods" {{checked (lookup actor.flags.gum 'useDefaultModifiers')}}/>
                    <span>Ler Compêndio</span>
                </label>
            </div>

            {{!-- Centro: Busca (NOVO) --}}
            <div class="toolbar-group center search-wrapper">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="modifier-search" placeholder="Filtrar Modificadores..." autocomplete="off"/>
            </div>

            {{!-- Direita: Ações --}}
            <div class="toolbar-group right">
                <button type="button" class="import-modifiers-btn" title="Importar"><i class="fas fa-file-import"></i></button>
                <button type="button" class="reset-modifiers-btn" title="Resetar"><i class="fas fa-undo"></i></button>
                <button type="button" class="clear-modifiers-btn" title="Limpar"><i class="fas fa-trash"></i></button>
            </div>
        </div>

        <div class="modifiers-masonry-layout">
         {{!-- Loop Nível 1: Contextos (Melee, Ranged, etc.) --}}
            {{#each modifiersBySection as |section key|}}
                {{!-- Só mostra o contexto se tiver subgrupos dentro --}}
                {{#if section.subgroupsArray.length}}
                <div class="context-wrapper">
                    <details class="context-details" data-group-id="mod-context-{{key}}" {{collapsibleState (concat "mod-context-" key) @root.collapsedData}}>
                        <summary class="context-summary">
                            <span class="ctx-title"><i class="{{section.icon}}"></i> {{section.label}}</span>
                            
                            {{!-- Botão Rápido para criar item neste contexto --}}
                            <a class="item-create ctx-add-btn" data-type="gm_modifier" data-section="{{key}}" title="Novo Modificador aqui">
                                <i class="fas fa-plus"></i>
                            </a>
                        </summary>
                        
                        <div class="context-body">
                            {{!-- Loop Nível 2: Categorias (Manobras, Localização...) --}}
                            {{#each section.subgroupsArray as |subgroup|}}
                                <details class="subgroup-details">
                                    <summary class="subgroup-summary">{{subgroup.label}}</summary>
                                    
                                    {{!-- Loop Nível 3: Itens (Grid Compacto) --}}
                                    <div class="mod-mini-grid">
                                        {{#each subgroup.items}}
                                            <div class="mod-mini-card item-row" data-item-id="{{this.id}}">
                                                <div class="mod-info" title="{{this.name}}">
                                                    <img src="{{this.img}}"/>
                                                    <span class="mod-name item-quick-view" style="cursor: pointer;">{{this.name}}</span>
                                                </div>
                                                <span class="mod-val {{#if (lt this.system.modifier 0)}}neg{{/if}}">
                                                    {{numberFormat this.system.modifier sign=true}}
                                                </span>
                                                
                                                {{!-- Controles Invisíveis (aparecem no hover) --}}
                                                <div class="mod-controls">
                                                    <a class="item-edit"><i class="fas fa-edit"></i></a>
                                                    <a class="item-delete"><i class="fas fa-trash"></i></a>
                                                </div>
                                            </div>
                                        {{/each}}
                                    </div>
                                </details>
                            {{/each}}
                        </div>
                    </details>
                </div>
                {{/if}}
            {{/each}}

            {{!-- Mensagem se tudo estiver vazio --}}
            {{#unless actor.items}}
                 <div class="empty-state">
                    <p>Nenhum modificador encontrado. Importe do Compêndio ou crie novos.</p>
                 </div>
            {{/unless}}
         </div>
    </div>

    {{! ============================================================= }}
    {{!  ABA DE ASPECTOS SOCIAIS (ESTRUTURA REFINADA E PADRONIZADA)   }}
    {{! ============================================================= }}
    <div class="tab" data-group="primary" data-tab="social">
      <div class="social-grid">

        <div class="social-block">
          <div class="block-header">
            <h4>Status Social</h4>
            <a class="add-social-entry" data-type="status" title="Adicionar Status Social"><i class="fas fa-plus"></i></a>
          </div>
          <ol class="item-list">
            {{#each actor.system.social_status_entries}}
            <li class="item item-row" data-entry-id="{{@key}}">
              <div class="item-content-wrapper">
                <span class="item-name">{{this.society}}: {{this.status_name}}</span>
                <span class="item-details"> Nível {{this.level}} | {{this.monthly_cost}}</span>
              </div>
              <div class="item-controls">
                <a class="item-control edit-social-entry" data-type="status"><i class="fas fa-edit"></i></a>
                <a class="item-control delete-social-entry" data-type="status"><i class="fas fa-trash"></i></a>
              </div>
            </li>
            {{/each}}
          </ol>
        </div>

        <div class="social-block">
          <div class="block-header">
            <h4>Organização</h4>
            <a class="add-social-entry" data-type="organization" title="Adicionar Organização"><i class="fas fa-plus"></i></a>
          </div>
          <ol class="item-list">
            {{#each actor.system.organization_entries}}
            <li class="item item-row" data-entry-id="{{@key}}">
              <div class="item-content-wrapper">
              <span class="item-name">{{this.organization_name}}: {{this.status_name}}</span>
              <span class="item-details">Nível {{this.level}} | Salário: {{this.salary}}</span>
              </div>
              <div class="item-controls">
                <a class="item-control edit-social-entry" data-type="organization"><i class="fas fa-edit"></i></a>
                <a class="item-control delete-social-entry" data-type="organization"><i class="fas fa-trash"></i></a>
              </div>
            </li>
            {{/each}}
          </ol>
        </div>

        <div class="social-block">
          <div class="block-header">
            <h4>Familiaridade Cultural</h4>
            <a class="add-social-entry" data-type="culture" data-type-name="Cultura"><i class="fas fa-plus"></i></a>
          </div>
          <ol class="item-list">
            {{#each actor.system.culture_entries}}
            <li class="item item-row" data-entry-id="{{@key}}">
              <span class="item-name">{{this.culture_name}}</span>
              <span class="item-details">Nível {{this.level}}</span>
              <div class="item-controls">
                <a class="item-control edit-social-entry" data-type="culture"><i class="fas fa-edit"></i></a>
                <a class="item-control delete-social-entry" data-type="culture"><i class="fas fa-trash"></i></a>
              </div>
            </li>
            {{/each}}
          </ol>
        </div>

        <div class="social-block">
          <div class="block-header">
            <h4>Idioma</h4>
            <a class="add-social-entry" data-type="language" data-type-name="Idioma"><i class="fas fa-plus"></i></a>
          </div>
          <ol class="item-list">
            {{#each actor.system.language_entries}}
            <li class="item item-row" data-entry-id="{{@key}}">
              <div class="item-content-wrapper">
              <span class="item-name">{{this.language_name}}</span>
              <span class="item-details"> Escrita: {{this.written_level}} | Fala: {{this.spoken_level}}</span>
              </div>
              <div class="item-controls">
                <a class="item-control edit-social-entry" data-type="language"><i class="fas fa-edit"></i></a>
                <a class="item-control delete-social-entry" data-type="language"><i class="fas fa-trash"></i></a>
              </div>
            </li>
            {{/each}}
          </ol>
        </div>

        <div class="social-block">
          <div class="block-header">
            <h4>Reputação</h4>
            <a class="add-social-entry" data-type="reputation" data-type-name="Reputação"><i class="fas fa-plus"></i></a>
          </div>
          <ol class="item-list">
            {{#each actor.system.reputation_entries}}
            <li class="item item-row" data-entry-id="{{@key}}">
              <div class="item-content-wrapper">
              <span class="item-name">{{this.title}} ({{this.reaction_modifier}})</span>
              <span class="item-details">{{this.scope}} | {{this.recognition_frequency}}</span>
              </div>
              <div class="item-controls">
                <a class="item-control edit-social-entry" data-type="reputation"><i class="fas fa-edit"></i></a>
                <a class="item-control delete-social-entry" data-type="reputation"><i class="fas fa-trash"></i></a>
              </div>
            </li>
            {{/each}}
          </ol>
        </div>

        <div class="social-block">
          <div class="block-header">
            <h4>Riqueza</h4>
            <a class="add-social-entry" data-type="wealth" data-type-name="Riqueza"><i class="fas fa-plus"></i></a>
          </div>
          <ol class="item-list">
            {{#each actor.system.wealth_entries}}
            <li class="item item-row" data-entry-id="{{@key}}">
              <div class="item-content-wrapper">
              <span class="item-name">{{this.wealth_level}}</span>
              <span class="item-details">{{this.effects}}</span>
              </div>
              <div class="item-controls">
                <a class="item-control edit-social-entry" data-type="wealth"><i class="fas fa-edit"></i></a>
                <a class="item-control delete-social-entry" data-type="wealth"><i class="fas fa-trash"></i></a>
              </div>
            </li>
            {{/each}}
          </ol>
        </div>
      </div>

      <div class="social-block-fullwidth">
        <div class="block-header">
          <h4>Vínculos</h4>
          <a class="add-social-entry" data-type="bond" data-type-name="Vínculo"><i class="fas fa-plus"></i></a>
        </div>
        <ol class="item-list">
          {{#each actor.system.bond_entries}}
          <li class="item item-row bond-row" data-entry-id="{{@key}}">
            <div class="item-content-wrapper">
            <span class="bond-name"><strong>{{this.name}}</strong></span>
            <span class="bond-type">[{{this.bond_type}}]</span>
            <span class="bond-description">{{this.description}}</span>
            </div>
            <div class="item-controls">
              <a class="item-control edit-social-entry" data-type="bond"><i class="fas fa-edit"></i></a>
              <a class="item-control delete-social-entry" data-type="bond"><i class="fas fa-trash"></i></a>
            </div>
          </li>
          {{/each}}
        </ol>
      </div>
    </div>
    
{{!-- ============================================================= --}}
    {{!--   ABA DE CARACTERÍSTICAS (Layout Colapsável e Elegante)       --}}
    {{!-- ============================================================= --}}
    <div class="tab" data-group="primary" data-tab="characteristics">
        
                {{!-- Helper para iterar sobre os 4 blocos (evita repetição de código) --}}
        {{#each (array
            (obj "id" "block1" "title" "Raciais" "isRacial" true)
            (obj "id" "block2" "title" "Vantagens")
            (obj "id" "block3" "title" "Desvantagens")
            (obj "id" "block4" "title" "Especiais")
        ) as |block|}}
            
            {{!-- Transforma a DIV em DETAILS para ser colapsável --}}
            {{!-- O ID é importante para o sistema lembrar o que está aberto/fechado --}}
            <details class="form-section gum-details gum-unified-section" id="char-section-{{block.id}}" data-group-id="char-section-{{block.id}}" {{collapsibleState (concat "char-section-" block.id) @root.collapsedData}}>
                
                {{!-- O Summary atua como o cabeçalho clicável --}}
                <summary class="block-header gum-unified-header">
                    <div class="header-left">
                        <i class="fas fa-chevron-right indicator"></i>
                        <h4 class="block-title">{{block.title}}</h4>
                    </div>
                    <a class="sort-control" data-item-type="characteristic" title="Ordenar"><i class="fas fa-sort-alpha-down"></i></a>
                </summary>
                
                {{#if block.isRacial}}
                    <div class="racial-section">
                        <div class="racial-subsection">
                            <div class="racial-subsection-header">
                                <h5 class="racial-subsection-title">Vantagens Raciais</h5>
                                <span class="racial-subsection-count">{{racialCharacteristics.advantages.length}}</span>
                            </div>
                            <ol class="item-list flex-wrap-container" data-item-type="characteristic">
                                {{#each ../racialCharacteristics.advantages}}
                                    <li class="item characteristic-card" data-item-id="{{this.id}}" draggable="true">
                                        <img src="{{this.img}}" class="item-icon" alt="{{this.name}}"/>
                                        <div class="card-info">
                                            <span class="item-name">
                                                <a class="item-quick-view" title="Visualizar Descrição">{{this.name}}</a>
                                            </span>
                                            <div class="card-details">
                                                <span class="card-points" title="Custo em Pontos">{{this.system.points}} pts</span>
                                                {{#if this.system.self_control_roll}}
                                                <span class="card-cr" title="Nº de Autocontrole">CR: {{this.system.self_control_roll}}</span>
                                                {{/if}}
                                            </div>
                                        </div>
                                        <div class="item-controls">
                                            <a class="item-edit" title="Editar"><i class="fas fa-edit"></i></a>
                                            <a class="item-delete" title="Deletar"><i class="fas fa-trash"></i></a>
                                        </div>
                                    </li>
                                {{/each}}
                                {{#unless ../racialCharacteristics.advantages.length}}
                                    <li class="placeholder-text">Nenhuma vantagem racial adicionada.</li>
                                {{/unless}}
                            </ol>
                        </div>
                        <div class="racial-subsection">
                            <div class="racial-subsection-header">
                                <h5 class="racial-subsection-title">Desvantagens Raciais</h5>
                                <span class="racial-subsection-count">{{racialCharacteristics.disadvantages.length}}</span>
                            </div>
                            <ol class="item-list flex-wrap-container" data-item-type="characteristic">
                                {{#each ../racialCharacteristics.disadvantages}}
                                    <li class="item characteristic-card" data-item-id="{{this.id}}" draggable="true">
                                        <img src="{{this.img}}" class="item-icon" alt="{{this.name}}"/>
                                        <div class="card-info">
                                            <span class="item-name">
                                                <a class="item-quick-view" title="Visualizar Descrição">{{this.name}}</a>
                                            </span>
                                            <div class="card-details">
                                                <span class="card-points" title="Custo em Pontos">{{this.system.points}} pts</span>
                                                {{#if this.system.self_control_roll}}
                                                <span class="card-cr" title="Nº de Autocontrole">CR: {{this.system.self_control_roll}}</span>
                                                {{/if}}
                                            </div>
                                        </div>
                                        <div class="item-controls">
                                            <a class="item-edit" title="Editar"><i class="fas fa-edit"></i></a>
                                            <a class="item-delete" title="Deletar"><i class="fas fa-trash"></i></a>
                                        </div>
                                    </li>
                                {{/each}}
                                {{#unless ../racialCharacteristics.disadvantages.length}}
                                    <li class="placeholder-text">Nenhuma desvantagem racial adicionada.</li>
                                {{/unless}}
                            </ol>
                        </div>
                    </div>
                {{else}}
                    <ol class="item-list flex-wrap-container" data-item-type="characteristic">
                        {{#each (lookup ../characteristicsByBlock block.id)}}
                            <li class="item characteristic-card" data-item-id="{{this.id}}" draggable="true">
                                <img src="{{this.img}}" class="item-icon" alt="{{this.name}}"/>
                                <div class="card-info">
                                    <span class="item-name">
                                        <a class="item-quick-view" title="Visualizar Descrição">{{this.name}}</a>
                                    </span>
                                    <div class="card-details">
                                        <span class="card-points" title="Custo em Pontos">{{this.system.points}} pts</span>
                                        {{#if this.system.self_control_roll}}
                                        <span class="card-cr" title="Nº de Autocontrole">CR: {{this.system.self_control_roll}}</span>
                                        {{/if}}
                                    </div>
                                </div>
                                <div class="item-controls">
                                    <a class="item-edit" title="Editar"><i class="fas fa-edit"></i></a>
                                    <a class="item-delete" title="Deletar"><i class="fas fa-trash"></i></a>
                                </div>
                            </li>
                        {{/each}}
                        {{#unless (lookup ../characteristicsByBlock block.id)}}
                            <li class="placeholder-text">Arraste itens para cá.</li>
                        {{/unless}}
                    </ol>
                {{/if}}
            </details>
        {{/each}}
        
    </div>

    {{! ========================================================= }}
    {{!        ABA DE PERÍCIAS (LAYOUT ÁRVORE BLINDADO)             }}
    {{! ========================================================= }}
    <div class="tab skills-tab" data-group="primary" data-tab="skills">
      
    {{!-- 1. BARRA DE FERRAMENTAS (TOPO) --}}
      <div class="skills-header-tools">
          <div class="skills-search-wrapper">
              <i class="fas fa-search"></i>
              <input type="text" name="search" placeholder="Buscar perícia..." autocomplete="off">
          </div>
          
          <div class="skills-header-buttons">
              {{!-- NOVO: Botão de Alternar Visualização --}}
              <a class="toggle-skills-view" title="Alternar: Grupos / Árvore">
                  {{#if (eq @root.skillsViewMode "tree")}}
                      <i class="fas fa-sitemap"></i> Árvore
                  {{else}}
                      <i class="fas fa-layer-group"></i> Grupos
                  {{/if}}
              </a>

              <a class="item-create" data-type="skill" title="Nova Perícia"><i class="fas fa-plus"></i> Nova</a>
              <a class="sort-control" data-item-type="skill" title="Ordenar"><i class="fas fa-sort-alpha-down"></i></a>
          </div>
      </div>

      {{!-- 2. LISTA --}}
      {{!-- Adiciona a classe 'group' ou 'tree' dinamicamente --}}
      <div class="skills-scroll-area {{#if (eq @root.skillsViewMode 'group')}}group{{else}}tree{{/if}}">

        {{!-- Loop de Grupos --}}
        {{#each skillGroupsKeys as |groupName|}}
            {{#with (lookup ../skillsByGroup groupName) as |skills|}}
            
            {{!-- O ID único combina "skill-" com o nome do grupo para evitar conflitos com outras abas --}}
            <details class="skill-tree-group" data-group-id="skill-{{groupName}}" {{collapsibleState (concat "skill-" groupName) @root.collapsedData}}>
                <summary class="skill-tree-summary">
                    <span class="st-group-title">{{groupName}}</span>
                    <span class="st-group-count">{{skills.length}}</span>
                    <i class="fas fa-chevron-down st-icon"></i>
                </summary>
                
            <ul class="skill-tree-list">
                    {{#each skills}}
                    <li class="item skill-tree-item {{this.indentClass}} {{#if this.isTrunk}}is-trunk{{/if}}" 
                        data-item-id="{{this._id}}" 
                        data-item-type="skill"
                        draggable="true">
                        
                        {{!-- Ícone (Rola) --}}
                        <div class="st-item-icon rollable" 
                             style="background-image: url('{{this.img}}');"
                             data-roll-value="{{this.system.final_nh}}" 
                             data-label="Teste de {{this.name}}" 
                             data-type="skill"
                             data-attribute-key="{{this.system.base_attribute}}"
                             title="Rolar Perícia">
                        </div>

                        {{!-- Info Central --}}
                        <div class="st-item-name">
                            
                            {{!-- Nome (Visualização Rápida) --}}
                            <h4 class="item-quick-view" title="Clique para ver detalhes">{{this.name}}</h4>
                            
                            {{!-- Linha de Detalhes e Caminho (AGORA SEMPRE VISÍVEL) --}}
                            <div class="st-inheritance-path">

                                            {{!-- Meta tags (Dificuldade) --}}
                            <div class="st-meta">
                                 {{#unless this.isTrunk}}
                                    <span>[{{this.system.difficulty}}]</span>
                                {{/unless}}
                            </div>
                                
                                {{!-- REQ 2: Tag de Modificadores Inatos (Só aparece se != 0) --}}
                                {{#if (ne this.system.other_mods 0)}}
                                    <span class="path-node mod" title="Modificadores Inatos/Outros">
                                        <i class="fas fa-adjust"></i>
                                        <span class="path-val">
                                            {{#if (gte this.system.other_mods 0)}}+{{/if}}{{this.system.other_mods}}
                                        </span>
                                    </span>
                                {{/if}}

                                {{!-- REQ 1: Meu Próprio Atributo + Nível (SEMPRE VISÍVEL) --}}
                                <span class="path-node self" title="Base: {{this.system.base_attribute}}">
                                    {{this.system.base_attribute}}
                                    <span class="path-val">
                                        {{#if (gte this.system.skill_level 0)}}+{{/if}}{{this.system.skill_level}}
                                    </span>
                                </span>

                                {{!-- Caminho dos Ancestrais (APENAS NO MODO ÁRVORE) --}}
                                {{#if (eq @root.skillsViewMode "tree")}}
                                    {{#if this.inheritancePath.length}}
                                        {{#each this.inheritancePath}}
                                            <i class="fas fa-chevron-right path-separator"></i>
                                            <span class="path-node {{this.type}}" title="Bônus vindo de: {{this.name}}">
                                                <span class="path-val">{{#if (gte this.value 0)}}+{{/if}}{{this.value}}</span>
                                            </span>
                                        {{/each}}
                                    {{/if}}
                                {{/if}}
                            </div>
                        </div>

                        {{!-- NH Final --}}
                        <div class="st-nh-box">
                            <span>NH</span>
                            <a class="rollable" 
                               data-roll-value="{{this.system.final_nh}}" 
                               data-label="Teste de {{this.name}}" 
                               data-type="skill"
                               data-item-id="{{this._id}}"
                               data-attribute-key="{{this.system.base_attribute}}">
                               {{this.system.final_nh}}
                            </a>
                        </div>

                        {{!-- Pontos --}}
                        <div class="st-pts-box" title="Pontos">
                            <i class="fas fa-star"></i> {{this.system.points}}
                        </div>

                        {{!-- Controles --}}
                        <div class="st-controls">
                            <a class="item-control item-edit" title="Editar Ficha"><i class="fas fa-edit"></i></a>
                            <a class="item-control item-delete" title="Excluir"><i class="fas fa-trash"></i></a>
                        </div>
                    </li>
                    {{/each}}
                </ul>
            </details>
            {{/with}}
        {{/each}}

        {{!-- Vazio --}}
        {{#unless skillGroupsKeys}}
            <div class="empty-placeholder" style="text-align:center; padding:20px; color:#666;">
                <p>Nenhuma perícia adicionada.</p>
            </div>
        {{/unless}}

      </div>
    </div>

    {{! ========================================================= }}
    {{!  ABA DE CONJURAÇÕES (ESTRUTURA REFINADA E PADRONIZADA)    }}
    {{! ========================================================= }}
    <div class="tab" data-group="primary" data-tab="spells">
      <div class="spells-tab-layout">
        <div class="spells-left-column">

            {{!-- Bloco da Habilidade de Conjuração (v3 - múltiplas entradas) --}}
      <div class="casting-ability-box skill-block casting-abilities-box">
        <div class="block-header">
       <h4>Habilidade de Conjuração</h4>
          <div class="header-controls">
           <a class="add-casting-ability" title="Adicionar Habilidade"><i class="fas fa-plus"></i></a>
          </div>
        </div>
 <div class="casting-abilities-list">
          {{#each castingAbilities}}
          <div class="casting-ability-card" data-ability-id="{{this.id}}">
            <div class="casting-ability-main">
              <div class="casting-ability-text">
                <div class="casting-ability-title-row">
                  <span class="casting-ability-name">{{this.name}}</span>
                  <span class="casting-ability-level">Nv {{this.level}}</span>
                </div>
                <div class="casting-ability-source">{{this.source}}</div>
              </div>
              <div class="item-controls casting-ability-controls">
                <div class="gum-action-menu js-action-menu">
                  <a class="item-control gum-action-menu__toggle js-action-menu-toggle" title="Opções da habilidade" aria-label="Opções da habilidade" role="button" aria-haspopup="true" aria-expanded="false">
                    <i class="fas fa-ellipsis-v"></i>
                  </a>
                  <div class="gum-action-menu__panel js-action-menu-panel" role="menu" aria-label="Ações da habilidade de conjuração">
                    <a class="item-control view-casting-ability gum-action-menu__item" role="menuitem" title="Visualizar"><i class="fas fa-eye"></i><span>Visualizar</span></a>
                    <a class="item-control edit-casting-ability gum-action-menu__item" role="menuitem" title="Editar"><i class="fas fa-edit"></i><span>Editar</span></a>
                    <a class="item-control delete-casting-ability gum-action-menu__item is-danger" role="menuitem" title="Deletar"><i class="fas fa-trash"></i><span>Deletar</span></a>
                  </div>
                </div>
              </div>
            </div>
          </div>
          {{/each}}
          {{#unless castingAbilities.length}}
          <div class="empty-placeholder compact">
            <p>Nenhuma habilidade de conjuração adicionada.</p>
          </div>
          {{/unless}}
        </div>
      </div>

      {{!-- Bloco de Reservas (Mantido) --}}
      <div class="energy-reserves-box skill-block combat-meters-box">
        <div class="block-header">
          <h4>Reservas de Energia</h4>
          <div class="header-controls">
            <a class="add-energy-reserve" data-reserve-type="spell" title="Adicionar Reserva"><i class="fas fa-plus"></i></a>
          </div>
        </div>
                <div class="meter-list energy-reserves-list">
          {{#each spellReserves}}
          <div class="item-row reserve-card meter-card" data-reserve-id="{{@key}}" data-reserve-type="spell">
            <div class="meter-main">
              <span class="item-name">{{this.name}} <small>({{this.source}})</small></span>
              <div class="meter-inputs">
                <input type="number" data-property="current" value="{{this.current}}"/>
                <span>/</span>
                <input type="number" data-property="max" value="{{this.max}}"/>
              </div>
              <div class="item-controls meter-controls">
                <div class="gum-action-menu js-action-menu">
                  <a class="item-control gum-action-menu__toggle js-action-menu-toggle" title="Opções da reserva" aria-label="Opções da reserva" role="button" aria-haspopup="true" aria-expanded="false">
                    <i class="fas fa-ellipsis-v"></i>
                  </a>
                  <div class="gum-action-menu__panel js-action-menu-panel" role="menu" aria-label="Ações da reserva">
                    <a class="item-control edit-energy-reserve gum-action-menu__item" role="menuitem" title="Editar"><i class="fas fa-edit"></i><span>Editar</span></a>
                    <a class="item-control delete-energy-reserve gum-action-menu__item is-danger" role="menuitem" title="Deletar"><i class="fas fa-trash"></i><span>Deletar</span></a>
                  </div>
                </div>
              </div>
            </div>
          </div>
          {{/each}}
        </div>
      </div>
      </div>

      {{!-- LISTA DE MAGIAS (AGRUPADA EM BLOCOS / PADRÃO LISTA DE ATAQUES) --}}
      <div class="spells-right-column">
      <div class="spell-groups-grid">
      {{#each spellGroupsKeys as |groupName|}}
          {{#with (lookup ../spellsByGroup groupName) as |spells|}}
          <details class="attack-group-details gum-unified-section spell-group-box" data-group-id="spell-group-{{groupName}}" {{collapsibleState (concat "spell-group-" groupName) @root.collapsedData}}>
            <summary class="group-summary gum-unified-header">
              <div class="summary-left">
                <i class="fas fa-chevron-right indicator"></i>
                <i class="fas fa-hat-wizard item-icon"></i>
                <span class="group-name">{{groupName}}</span>
              </div>
              <div class="summary-right">
                <span class="group-tag sp_cl">{{spells.length}} Magias</span>
              </div>
            </summary>

            <div class="group-content">
            <div class="spell-list-v2 grouped attack-style">
              {{#each spells}}
              <div class="item-wrapper item spell-row-v3" data-item-id="{{this.id}}" draggable="true">
                <div class="spell-row-main">
                  <img class="spell-thumb" src="{{this.img}}" alt="{{this.name}}">

                  <div class="spell-name-stack">
                    <h4 class="spell-name item-quick-view" title="Visualizar Card">{{this.name}}</h4>
                    <div class="spell-school-line">{{this.system.spell_school}} · {{this.system.spell_class}}</div>
                  </div>

                  <div class="spell-meta-cell">
                    <span class="spell-meta-label">NH</span>
                    <a class="rollable spell-meta-value" data-type="spell" data-roll-value="{{this.system.final_nh}}" data-label="Teste de {{this.name}}" data-item-id="{{this.id}}">{{this.system.final_nh}}</a>
                  </div>

                  <div class="spell-meta-cell damage">
                    <span class="spell-meta-label">Dano</span>
                    {{#if this.system.damage.formula}}
                    <a class="rollable-damage spell-meta-value" title="Rolar Dano" data-item-id="{{this.id}}">{{this.system.damage.formula}} {{this.system.damage.type}}</a>
                    {{else}}
                    <span class="spell-meta-value">—</span>
                    {{/if}}
                    {{#if this.system.damage.follow_up_damage.formula}}
                    <span class="spell-meta-sub">FU: {{this.system.damage.follow_up_damage.formula}} {{this.system.damage.follow_up_damage.type}}</span>
                    {{/if}}
                    {{#if this.system.damage.fragmentation_damage.formula}}
                    <span class="spell-meta-sub">FR: {{this.system.damage.fragmentation_damage.formula}} {{this.system.damage.fragmentation_damage.type}}</span>
                    {{/if}}
                  </div>

                  <div class="spell-meta-cell">
                    <span class="spell-meta-label">TxD</span>
                    <span class="spell-meta-value">{{this.system.casting_time}} × {{this.system.duration}}</span>
                  </div>

                  <div class="spell-meta-cell">
                    <span class="spell-meta-label">CCxCM</span>
                    <span class="spell-meta-value">{{this.system.mana_cost}} × {{this.system.mana_maint}}</span>
                  </div>

                  <div class="item-controls spell-controls-row">
                    <div class="gum-action-menu js-action-menu">
                      <a class="item-control gum-action-menu__toggle js-action-menu-toggle" title="Opções da magia" aria-label="Opções da magia" role="button" aria-haspopup="true" aria-expanded="false">
                        <i class="fas fa-ellipsis-v"></i>
                      </a>
                      <div class="gum-action-menu__panel js-action-menu-panel" role="menu" aria-label="Ações da magia">
                        <a class="item-control item-quick-view gum-action-menu__item" data-item-id="{{this.id}}" role="menuitem" title="Visualizar"><i class="fas fa-eye"></i><span>Visualizar</span></a>
                        <a class="item-control item-edit gum-action-menu__item" role="menuitem" title="Editar"><i class="fas fa-edit"></i><span>Editar</span></a>
                        <a class="item-control item-delete gum-action-menu__item is-danger" role="menuitem" title="Deletar"><i class="fas fa-trash"></i><span>Deletar</span></a>
                      </div>
                    </div>
                  </div>
                </div>

              </div>
              {{/each}}
            </div>
            </div>
          </details>
          {{/with}}
        {{/each}}

        {{#unless spellGroupsKeys}}
        <div class="empty-placeholder" style="text-align:center; padding:20px; color:#666;">
          <p>Nenhuma magia adicionada.</p>
        </div>
        {{/unless}}
      </div>
      </div>
      </div>
    </div>
    
    {{! ========================================================= }}
    {{!  ABA DE PODERES (ESTRUTURA REFINADA E PADRONIZADA)        }}
    {{! ========================================================= }}
    <div class="tab" data-group="primary" data-tab="powers">
      <div class="spells-tab-layout">
        <div class="spells-left-column">

    <div class="casting-ability-box skill-block casting-abilities-box">
        <div class="block-header">
            <h4>Fonte de Poder</h4>
          <div class="header-controls">
            <a class="add-power-source" title="Adicionar/Configurar Fonte de Poder"><i class="fas fa-plus"></i></a>
          </div>
        </div>
        <div class="casting-ability-card power-source-card" data-power-source-id="main">
          <div class="casting-ability-main">
            <div class="casting-ability-text">
              <div class="casting-ability-title-row">
                <span class="casting-ability-name">{{actor.system.power_source.name}}</span>
                <span class="casting-ability-level">Nv {{actor.system.power_source.level}}</span>
              </div>
              <div class="casting-ability-source">{{actor.system.power_source.source}} · {{actor.system.power_source.focus}}</div>
              <hr class="casting-ability-divider">
              <div class="casting-ability-source talent">{{actor.system.power_source.power_talent_name}} · Nv {{actor.system.power_source.power_talent_level}}</div>
            </div>
            <div class="item-controls casting-ability-controls">
              <div class="gum-action-menu js-action-menu">
                <a class="item-control gum-action-menu__toggle js-action-menu-toggle" title="Opções da fonte" aria-label="Opções da fonte" role="button" aria-haspopup="true" aria-expanded="false">
                  <i class="fas fa-ellipsis-v"></i>
                </a>
                <div class="gum-action-menu__panel js-action-menu-panel" role="menu" aria-label="Ações da fonte de poder">
                  <a class="item-control view-power-source gum-action-menu__item" role="menuitem" title="Visualizar"><i class="fas fa-eye"></i><span>Visualizar</span></a>
                  <a class="item-control edit-power-source gum-action-menu__item" role="menuitem" title="Editar"><i class="fas fa-edit"></i><span>Editar</span></a>
                  <a class="item-control delete-power-source gum-action-menu__item is-danger" role="menuitem" title="Deletar"><i class="fas fa-trash"></i><span>Deletar</span></a>
                </div>
              </div>
            </div>
          </div>
        </div>
    </div>

      {{!-- Bloco das Reservas de Energia --}}
      <div class="energy-reserves-box skill-block combat-meters-box">
        <div class="block-header">
          <h4>Reservas de Energia</h4>
          <div class="header-controls">
            <a class="add-energy-reserve" data-reserve-type="power" title="Adicionar Reserva"><i class="fas fa-plus"></i></a>
          </div>
        </div>
        <div class="meter-list energy-reserves-list">
          {{#each powerReserves}}
          <div class="item-row reserve-card meter-card" data-reserve-id="{{@key}}" data-reserve-type="power">
            <div class="meter-main">
              <span class="item-name">{{this.name}} <small>({{this.source}})</small></span>
              <div class="meter-inputs">
                <input type="number" data-property="current" value="{{this.current}}"/>
                <span>/</span>
                <input type="number" data-property="max" value="{{this.max}}"/>
              </div>
              <div class="item-controls meter-controls">
                <div class="gum-action-menu js-action-menu">
                  <a class="item-control gum-action-menu__toggle js-action-menu-toggle" title="Opções da reserva" aria-label="Opções da reserva" role="button" aria-haspopup="true" aria-expanded="false">
                    <i class="fas fa-ellipsis-v"></i>
                  </a>
                  <div class="gum-action-menu__panel js-action-menu-panel" role="menu" aria-label="Ações da reserva">
                    <a class="item-control edit-energy-reserve gum-action-menu__item" role="menuitem" title="Editar"><i class="fas fa-edit"></i><span>Editar</span></a>
                    <a class="item-control delete-energy-reserve gum-action-menu__item is-danger" role="menuitem" title="Deletar"><i class="fas fa-trash"></i><span>Deletar</span></a>
                  </div>
                </div>
              </div>
            </div>
          </div>
          {{/each}}
        </div>
      </div>
      </div>

      {{!-- LISTA DE PODERES (AGRUPADA EM BLOCOS / PADRÃO LISTA DE ATAQUES) --}}
      <div class="spells-right-column">
      <div class="spell-groups-grid">
      {{#each powerGroupsKeys as |groupName|}}
          {{#with (lookup ../powersByGroup groupName) as |powers|}}
          <details class="attack-group-details gum-unified-section spell-group-box" data-group-id="power-group-{{groupName}}" {{collapsibleState (concat "power-group-" groupName) @root.collapsedData}}>
            <summary class="group-summary gum-unified-header">
              <div class="summary-left">
                <i class="fas fa-chevron-right indicator"></i>
                <i class="fas fa-bolt item-icon"></i>
                <span class="group-name">{{groupName}}</span>
              </div>
              <div class="summary-right">
                <span class="group-tag pw">{{powers.length}} Poderes</span>
              </div>
            </summary>

            <div class="group-content">
            <div class="spell-list-v2 grouped attack-style">
              {{#each powers}}
              <div class="item-wrapper item spell-row-v3" data-item-id="{{this.id}}" draggable="true">
                <div class="spell-row-main">
                  <img class="spell-thumb" src="{{this.img}}" alt="{{this.name}}">

                  <div class="spell-name-stack">
                    <h4 class="spell-name item-quick-view" title="Visualizar Card">{{this.name}}</h4>
                    <div class="spell-school-line">{{this.system.source}} · {{this.system.spell_class}}</div>
                  </div>

                  <div class="spell-meta-cell">
                    <span class="spell-meta-label">NH</span>
                    <a class="rollable spell-meta-value" data-type="power" data-roll-value="{{this.system.final_nh}}" data-label="Teste de {{this.name}}" data-item-id="{{this.id}}">{{this.system.final_nh}}</a>
                  </div>

                  <div class="spell-meta-cell damage">
                    <span class="spell-meta-label">Dano</span>
                    {{#if this.system.damage.formula}}
                    <a class="rollable-damage spell-meta-value" title="Rolar Dano" data-item-id="{{this.id}}">{{this.system.damage.formula}} {{this.system.damage.type}}</a>
                    {{else}}
                    <span class="spell-meta-value">—</span>
                    {{/if}}
                    {{#if this.system.damage.follow_up_damage.formula}}
                    <span class="spell-meta-sub">FU: {{this.system.damage.follow_up_damage.formula}} {{this.system.damage.follow_up_damage.type}}</span>
                    {{/if}}
                    {{#if this.system.damage.fragmentation_damage.formula}}
                    <span class="spell-meta-sub">FR: {{this.system.damage.fragmentation_damage.formula}} {{this.system.damage.fragmentation_damage.type}}</span>
                    {{/if}}
                  </div>

                  <div class="spell-meta-cell">
                    <span class="spell-meta-label">TxD</span>
                    <span class="spell-meta-value">{{this.system.activation_time}} × {{this.system.duration}}</span>
                  </div>

                  <div class="spell-meta-cell">
                    <span class="spell-meta-label">CCxCM</span>
                    <span class="spell-meta-value">{{this.system.activation_cost}} × {{this.system.maint_cost}}</span>
                  </div>

                  <div class="item-controls spell-controls-row">
                    <div class="gum-action-menu js-action-menu">
                      <a class="item-control gum-action-menu__toggle js-action-menu-toggle" title="Opções do poder" aria-label="Opções do poder" role="button" aria-haspopup="true" aria-expanded="false">
                        <i class="fas fa-ellipsis-v"></i>
                      </a>
                      <div class="gum-action-menu__panel js-action-menu-panel" role="menu" aria-label="Ações do poder">
                        <a class="item-control item-quick-view gum-action-menu__item" role="menuitem" title="Visualizar Card"><i class="fas fa-eye"></i><span>Visualizar Card</span></a>
                        <a class="item-control item-edit gum-action-menu__item" role="menuitem" title="Editar"><i class="fas fa-edit"></i><span>Editar</span></a>
                        <a class="item-control item-delete gum-action-menu__item is-danger" role="menuitem" title="Deletar"><i class="fas fa-trash"></i><span>Deletar</span></a>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              {{/each}}
            </div>
            </div>
          </details>
          {{/with}}
        {{/each}}

        {{#unless powerGroupsKeys}}
        <div class="empty-placeholder" style="text-align:center; padding:20px; color:#666;">
          <p>Nenhum poder adicionado.</p>
        </div>
        {{/unless}}
      </div>
      </div>
    </div>
    </div>

        {{! ========================================================= }}
    {{!       ABA DE EQUIPAMENTOS (VERSÃO OTIMIZADA v3 - CARD UNIFICADO) }}
    {{! ========================================================= }}
    
<div class="tab" data-group="primary" data-tab="equipment">

    {{!-- SUMÁRIO DE CARGA --}}
    <div class="encumbrance-block gum-panel">
        <div class="panel-header">
            <h4 class="panel-title"><i class="fas fa-weight-hanging"></i> Sumário de Carga</h4>
            <div class="encumbrance-total">
                <span class="label">Peso Total:</span>
                <span class="value">{{actor.system.encumbrance.total_weight}} kg</span>
            </div>
        </div>
        <div class="encumbrance-meter">
            {{#each actor.system.encumbrance.level_data}}
            <div class="encumbrance-step {{#if (eq this.name ../actor.system.encumbrance.level_name)}}active{{/if}}">
                <span class="step-name">{{this.name}}</span>
                <span class="step-limit">≤ {{this.max}}</span>
            </div>
            {{/each}}
        </div>
        <div class="panel-footer">
            <label class="checkbox-label">
                <input type="checkbox" name="system.encumbrance.ignore_carried_weight" {{checked actor.system.encumbrance.ignore_carried_weight}}/>
                Ignorar peso carregado
            </label>
        </div>
    </div>

    <div class="equipment-columns">

{{!-- 1. EM USO (Equipped) --}}
<details class="gum-details equipment-column gum-unified-section" data-section="equip_equipped" {{#unless actor.flags.gum.sheet_settings.equip_equipped_closed}}open{{/unless}}>
    <summary class="list-header gum-unified-header">
        <i class="fas fa-chevron-right toggle-icon"></i>
        <h4 class="header-title">Em Uso (Mãos/Corpo)</h4>
    </summary>
    
    <div class="list-content">
        <ol class="item-list flex-wrap-container">
            {{#each equipmentInUse}}
              <li class="item equipment-card" data-item-id="{{this._id}}" draggable="true">
                  {{!-- Coluna 1: Ícone --}}
                  <img src="{{this.img}}" class="item-icon" title="{{this.name}}"/>

                  {{!-- Coluna 2: Informações e Controles --}}
                  <div class="card-info">
                      <span class="item-name"><a class="item-quick-view">{{this.name}}</a></span>
                      
                      {{!-- Linha de Tags --}}
                      <div class="card-details equipment-stats">
                          <span class="equip-stat-tag">x{{this.system.quantity}}</span>
                          <span class="equip-stat-tag">{{this.system.total_weight}} kg</span>
                          {{#if this.system.dr}}<span class="equip-stat-tag shield-tag">RD {{this.system.dr}}</span>{{/if}}
                      </div>

                      {{!-- NOVA POSIÇÃO: Linha de Botões Horizontal --}}
                      <div class="item-controls">
                        <a class="item-control active" title="Em Uso">
                            <i class="fas fa-tshirt" style="color: #389c68;"></i> 
                        </a>
                          <a class="item-control item-toggle-equip {{#if this.system.equipped}}active{{/if}}" title="Equipar/Desequipar">
                              <i class="fas fa-backpack"></i>
                          </a>
                          <a class="item-control item-toggle-stored {{#if this.system.stored}}active{{/if}}" title="Guardar/Sacar">
                              <i class="fas fa-box"></i>
                          </a>
                          <a class="item-control item-edit" title="Editar"><i class="fas fa-edit"></i></a>
                          <a class="item-control item-delete" title="Excluir"><i class="fas fa-trash"></i></a>
                      </div>
                  </div>
              </li>
            {{/each}}
        </ol>
    </div>
</details>

{{!-- 2. CARREGADO (Mochila) --}}
<details class="gum-details equipment-column gum-unified-section" data-section="equip_carried" {{#unless actor.flags.gum.sheet_settings.equip_carried_closed}}open{{/unless}}>
    <summary class="list-header gum-unified-header">
        <i class="fas fa-chevron-right toggle-icon"></i>
        <h4 class="header-title">Carregado (Mochila)</h4>
    </summary>

    <div class="list-content">
        <ol class="item-list flex-wrap-container">
            {{#each equipmentCarried}}
            <li class="item equipment-card" data-item-id="{{this._id}}" draggable="true">
                <img src="{{this.img}}" class="item-icon"/>
                <div class="card-info">
                    <span class="item-name"><a class="item-quick-view">{{this.name}}</a></span>
                    <div class="card-details equipment-stats">
                        <span class="equip-stat-tag">x{{this.system.quantity}}</span>
                        <span class="equip-stat-tag">{{this.system.total_weight}} kg</span>
                    </div>

                    {{!-- CONTROLES LADO A LADO --}}
                    <div class="item-controls">
                        <a class="item-control item-toggle-equip" title="Equipar / Vestir">
                            <i class="fas fa-tshirt" style="opacity: 0.3;"></i>
                        </a>
                        {{!-- Ícone de mochila ativo indicando que está aqui --}}
                        <a class="item-control active" title="Na Mochila">
                            <i class="fas fa-backpack" style="color: #54a0ff;"></i> 
                        </a>
                        <a class="item-control item-toggle-stored" title="Guardar no Baú">
                            <i class="fas fa-box-open" style="opacity: 0.3;"></i>
                        </a>
                        <a class="item-control item-edit" title="Editar"><i class="fas fa-edit"></i></a>
                        <a class="item-control item-delete" title="Excluir"><i class="fas fa-trash"></i></a>
                    </div>
                </div>
            </li>
            {{/each}}
        </ol>
    </div>
</details>

{{!-- 3. ARMAZENADO (Banco/Casa) --}}
<details class="gum-details equipment-column gum-unified-section" data-section="equip_stored" {{#unless actor.flags.gum.sheet_settings.equip_stored_closed}}open{{/unless}}>
    <summary class="list-header gum-unified-header">
        <i class="fas fa-chevron-right toggle-icon"></i>
        <h4 class="header-title">Armazenado (Banco/Casa)</h4>
    </summary>

    <div class="list-content">
        <ol class="item-list flex-wrap-container">
            {{#each equipmentStored}}
            <li class="item equipment-card" data-item-id="{{this._id}}" draggable="true">
                <img src="{{this.img}}" class="item-icon"/>
                <div class="card-info">
                    <span class="item-name"><a class="item-quick-view">{{this.name}}</a></span>
                    <div class="card-details equipment-stats">
                        <span class="equip-stat-tag">x{{this.system.quantity}}</span>
                        <span class="equip-stat-tag">{{this.system.total_weight}} kg</span>
                    </div>

                    {{!-- CONTROLES LADO A LADO --}}
                    <div class="item-controls">
                        <a class="item-control item-toggle-equip" title="Equipar direto do Baú">
                             <i class="fas fa-tshirt" style="opacity: 0.3;"></i>
                        </a>
                        <a class="item-control item-toggle-stored" title="Mover para Mochila">
                            <i class="fas fa-backpack" style="opacity: 0.3;"></i>
                        </a>
                        <a class="item-control item-toggle-stored active" title="No Baú (Sacar para Mochila)">
                            <i class="fas fa-box" style="color: #ee5253;"></i>
                        </a>
                        <a class="item-control item-edit" title="Editar"><i class="fas fa-edit"></i></a>
                        <a class="item-control item-delete" title="Excluir"><i class="fas fa-trash"></i></a>
                    </div>
                </div>
            </li>
            {{/each}}
        </ol>
    </div>
</details>

    </div>
</div>


    {{! ========================================================= }}
    {{!       ABA DE COMBATE (VERSÃO OTIMIZADA v3 - CARD UNIFICADO) }}
    {{! ========================================================= }}
    <div class="tab combat-tab" data-group="primary" data-tab="combat">

      {{! ========================================================= }}
      {{!       CONTAINER DE 2 COLUNAS (ESQUERDA ESTREITA)            }}
      {{! ========================================================= }}
      <div class="combat-main-content">

        {{! --- COLUNA DA ESQUERDA (ESTREITA) --- }}
        <div class="combat-left-column">

          {{! ================================================= }}
          {{!     PAINEL DE RD   }}
          {{! ================================================= }}
          <div class="gum-block dr-location-block">
            <div class="block-header">
              <h4>
                <span class="dr-header-title">Tabela de RD</span>
                <span class="dr-header-subtitle">{{bodyProfileLabel}}</span>
              </h4>
              <div class="header-controls">
                <a class="view-hit-locations" title="Editar Modificadores de RD"><i class="fas fa-edit"></i></a>
              </div>
            </div>
            
<ol class="dr-location-list">
              {{#each drDisplayRows as |row|}}
                {{#if row.isGroup}}
                  <li class="dr-location-row dr-group" data-group-id="{{row.id}}">
                    <div class="dr-row-main">
                      <div class="dr-row-start">
                      <button class="dr-group-toggle" type="button" title="Expandir grupo">
                        <i class="fas fa-chevron-right"></i>
                      </button>
                      <span class="location-name">{{row.label}}</span>
                      </div>
                      <span class="location-dr-value">{{row.base}}</span>
                    </div>
                    {{#if row.extraLine}}
                      <div class="dr-row-extra">{{row.extraLine}}</div>
                    {{/if}}
                    <ol class="dr-group-children">
                      {{#each row.children as |child|}}
                        <li class="dr-location-row is-child" data-location-key="{{child.key}}">
                          <span class="location-name">{{child.label}}</span>
                          <span class="location-dr-value">{{child.base}}</span>
                        </li>
                        {{#if child.extraLine}}
                          <li class="dr-row-extra is-child">{{child.extraLine}}</li>
                        {{/if}}
                      {{/each}}
                    </ol>
                  </li>
                {{else}}
                  <li class="dr-location-row" data-location-key="{{row.key}}">
                    <span class="location-name">{{row.label}}</span>
                    <span class="location-dr-value">{{row.base}}</span>
                  </li>
                  {{#if row.extraLine}}
                    <li class="dr-row-extra">{{row.extraLine}}</li>
                  {{/if}}
                {{/if}}
              {{/each}}
            </ol>
          </div>
                    {{!-- Bloco de Registros de Combate (Agora no topo da direita) --}}
 <div class="gum-block combat-meters-box">
            <div class="block-header">
              <h4>Registros de Combate</h4>
              <div class="header-controls">
                <a class="show-hidden-meters" title="{{#if showHiddenMeters}}Ocultar Registros Ocultos{{else}}Mostrar Registros Ocultos{{/if}}">
                  <i class="fas {{#if showHiddenMeters}}fa-eye{{else}}fa-eye-low-vision{{/if}}"></i>
                </a>
                <a class="add-combat-meter" title="Adicionar Registro"><i class="fas fa-plus"></i></a>
              </div>
            </div>
            <div class="meter-list">
              {{#each preparedCombatMeters}}
                <div class="item-row meter-card {{#if this.meter.hidden}}is-hidden{{/if}}" data-meter-id="{{this.id}}">
                  <div class="meter-main">
                    <span class="item-name">
                      {{this.meter.name}}
                      {{#if this.meter.hidden}}<small>(oculto)</small>{{/if}}
                    </span>
                    <div class="meter-inputs">
                      <input type="number" name="system.combat.combat_meters.{{this.id}}.current" value="{{this.meter.current}}"/>
                      <span>/</span>
                      <input type="number" name="system.combat.combat_meters.{{this.id}}.max" value="{{this.meter.max}}"/>
                    </div>
                    <div class="item-controls meter-controls">
                      <div class="gum-action-menu js-action-menu">
                        <a class="item-control gum-action-menu__toggle js-action-menu-toggle" title="Opções do registro" aria-label="Opções do registro" role="button" aria-haspopup="true" aria-expanded="false">
                          <i class="fas fa-ellipsis-v"></i>
                        </a>
                        <div class="gum-action-menu__panel js-action-menu-panel" role="menu" aria-label="Ações do registro">
                          <a class="item-control edit-combat-meter gum-action-menu__item" role="menuitem" title="Editar"><i class="fas fa-edit"></i><span>Editar</span></a>
                          <a class="item-control hide-combat-meter gum-action-menu__item" role="menuitem" title="{{#if this.meter.hidden}}Reexibir Registro{{else}}Ocultar Registro{{/if}}">
                            <i class="fas {{#if this.meter.hidden}}fa-eye{{else}}fa-eye-slash{{/if}}"></i>
                            <span>{{#if this.meter.hidden}}Reexibir{{else}}Ocultar{{/if}}</span>
                          </a>
                          <a class="item-control delete-combat-meter gum-action-menu__item is-danger" role="menuitem" title="Deletar Registro"><i class="fas fa-trash"></i><span>Deletar</span></a>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              {{/each}}
              {{#unless preparedCombatMeters}}
                <li class="placeholder-text" style="padding: 5px 10px; opacity: 0.7;">Nenhum registro visível.</li>
              {{/unless}}
            </div>
          </div>
        </div>

        {{! --- COLUNA DA DIREITA (LARGA) --- }}
        <div class="combat-right-column">
          


          {{!-- Bloco de Lista de ataque --}}
<div class="attack-group-list-v2">
    {{#each attackGroups as |group|}}
    {{!-- USANDO group.id EM VEZ DE group.name --}}
    <details class="attack-group-details gum-unified-section" data-group-id="attack-group-{{group.id}}" {{collapsibleState (concat "attack-group-" group.id) @root.collapsedData}}>
    
        <summary class="group-summary gum-unified-header">
            <div class="summary-left">
            <i class="fas fa-chevron-right indicator"></i>
            <i class="fas fa-khanda-alt item-icon"></i> 
            <span class="group-name">{{group.name}}</span>
            </div>
            
            <div class="summary-right">
            {{#if (gt group.weight 0)}}
                <span class="group-tag weight">{{group.weight}} kg</span>
            {{/if}}
            {{#if (gt group.defense_bonus 0)}}
                <span class="group-tag db" title="Bônus de Defesa">BD +{{group.defense_bonus}}</span>
            {{/if}}
            <a class="item-control item-edit" data-item-id="{{group.id}}" title="Abrir Ficha do Item">
                <i class="fas fa-cog"></i>
            </a>
            </div>
        </summary>

        <div class="group-content">
            {{#each group.attacks as |attack|}}
              <div class="attack-row item-row attack-row--{{attack.attack_type}}" data-attack-id="{{attack.id}}" data-item-id="{{attack.itemId}}">
                <div class="attack-icon">
                    {{#if (eq attack.attack_type "melee")}}<i class="fas fa-swords" title="Corpo a Corpo"></i>{{/if}}
                    {{#if (eq attack.attack_type "ranged")}}<i class="fas fa-bullseye" title="À Distância"></i>{{/if}}
                </div>
                <div class="attack-info">
                    <div class="attack-line">
                        <div class="attack-cell attack-identity">
                            <div class="attack-skill-line">
                                <span class="attack-skill">{{attack.skill_name}}</span>
                                <span class="attack-flags">
                                  {{#if this.unbalanced}}<span class="attack-flag u" title="Desbalanceada">U</span>{{/if}}
                                  {{#if this.fencing}}<span class="attack-flag f" title="Esgrima">F</span>{{/if}}
                                </span>
                            </div>
                            <div class="attack-mode-sub">{{attack.name}}</div>
                            {{#if (eq attack.attack_type "ranged")}}
                              {{#if attack.range}}
                                <div class="attack-line-sub">Alc.: {{attack.range}}</div>
                              {{/if}}
                            {{/if}}
                        </div>
                        <div class="attack-cell is-center">
                            <div class="attack-label">NH</div>
                            <a class="rollable attack-value" data-type="attack" data-attack-type="{{attack.attack_type}}" data-roll-value="{{attack.final_nh}}" data-label="{{group.name}} ({{attack.name}})" data-item-id="{{attack.itemId}}">{{attack.final_nh}}</a>
                        </div>
                        <div class="attack-cell">
                            <div class="attack-label">Dano</div>
                            <a class="rollable-damage attack-value attack-damage-main"
                                title="Rolar Dano"
                                data-item-id="{{attack.itemId}}"
                                data-attack-id="{{attack.id}}"
                                data-dmg-formula="{{attack.damage_formula}}"
                                data-dmg-type="{{attack.damage_type}}"
                                data-armor-divisor="{{attack.armor_divisor}}"
                                {{#with attack.follow_up_damage}}
                                  {{#if this.formula}}
                                    data-followup-formula="{{this.formula}}"
                                    data-followup-type="{{this.type}}"
                                  {{/if}}
                                {{/with}}>
                                {{attack.damage_formula}}{{#if (gt attack.armor_divisor 1)}}({{attack.armor_divisor}}){{/if}} {{attack.damage_type}}
                            </a>
                            {{#with attack.fragmentation_damage}}
                              {{#if this.formula}}
                                <div class="attack-damage-sub">[ {{this.formula}} {{this.type}}]</div>
                              {{/if}}
                            {{/with}}
                            {{#with attack.follow_up_damage}}
                              {{#if this.formula}}
                                <div class="attack-damage-sub">( {{this.formula}} {{this.type}})</div>
                              {{/if}}
                            {{/with}}
                        </div>
                        {{#if (eq attack.attack_type "melee")}}
                          <div class="attack-cell is-center">
                            <div class="attack-label">APR</div>
                            <a class="rollable attack-value" data-type="defense" data-roll-value="{{attack.parry}}">{{attack.parry}}</a>
                          </div>
                          {{#if attack.final_block}}
                            <div class="attack-cell is-center">
                              <div class="attack-label">BLQ</div>
                              <a class="rollable attack-value" data-type="defense" data-roll-value="{{attack.final_block}}" data-label="Teste de Bloqueio">{{attack.final_block}}</a>
                            </div>
                          {{/if}}
                          <div class="attack-cell is-center">
                            <div class="attack-label">ALC</div>
                            <div class="attack-value">{{attack.reach}}</div>
                          </div>
                          <div class="attack-cell is-center">
                            <div class="attack-label">ST Min</div>
                            <div class="attack-value">{{attack.min_strength}}</div>
                          </div>
                        {{/if}}
                        {{#if (eq attack.attack_type "ranged")}}
                          <div class="attack-cell is-center">
                            <div class="attack-label">Prec</div>
                            <div class="attack-value">{{attack.accuracy}}</div>
                          </div>
                          <div class="attack-cell is-center">
                            <div class="attack-label">CdTxT (RCO)</div>
                            <div class="attack-value">
                              {{#if attack.rof}}{{attack.rof}}{{else}}—{{/if}}x{{#if attack.shots}}{{attack.shots}}{{else}}—{{/if}} ({{#if attack.rcl}}{{attack.rcl}}{{else}}—{{/if}})
                            </div>
                          </div>
                          <div class="attack-cell is-center">
                            <div class="attack-label">Mag</div>
                            <div class="attack-value">{{attack.mag}}</div>
                          </div>
                          <div class="attack-cell is-center">
                            <div class="attack-label">ST Min</div>
                            <div class="attack-value">{{attack.min_strength}}</div>
                          </div>
                        {{/if}}
                    </div>
                </div>
             </div>
            {{/each}}
        </div>
    </details>
    {{/each}}
    {{#unless attackGroups}}
    <div class="placeholder-text">Nenhum ataque disponível.</div>
    {{/unless}}
</div>

        </div>
        
      </div>    
    </div>

    {{! ========================================================= }}
    {{!  ABA DE BIOGRAFIA (ESTRUTURA REFINADA E PADRONIZADA)      }}
    {{! ========================================================= }}
    <div class="tab" data-group="primary" data-tab="biography">
     
      <div class="biography-layout">

        {{!-- Coluna Lateral: Perfil do Personagem --}}
        <div class="biography-details">
          {{!-- A classe .skill-block será o "card" padrão no novo design --}}
          <div class="skill-block">
            <div class="block-header">
              <h4>Perfil</h4>
              <a class="edit-biography-details" title="Editar Perfil"><i class="fas fa-edit"></i></a>
            </div>
            <div class="details-display-list">

              {{!-- a classe .item-row para padronização futura --}}
              <div class="item-row detail-item">
                <span class="detail-label">Gênero</span>
                <span class="detail-value">{{actor.system.details.gender}}</span>
              </div>
              <div class="item-row detail-item">
                <span class="detail-label">Idade</span>
                <span class="detail-value">{{actor.system.details.age}}</span>
              </div>
              <div class="item-row detail-item">
                <span class="detail-label">Altura</span>
                <span class="detail-value">{{actor.system.details.height}}</span>
              </div>
              <div class="item-row detail-item">
                <span class="detail-label">Peso</span>
                <span class="detail-value">{{actor.system.details.weight}}</span>
              </div>
              <div class="item-row detail-item">
                <span class="detail-label">Pele</span>
                <span class="detail-value">{{actor.system.details.skin}}</span>
              </div>
              <div class="item-row detail-item">
                <span class="detail-label">Cabelos</span>
                <span class="detail-value">{{actor.system.details.hair}}</span>
              </div>
              <div class="item-row detail-item full-width">
                <span class="detail-label">Olhos</span>
                <span class="detail-value">{{actor.system.details.eyes}}</span>
              </div>
              <div class="item-row detail-item full-width">
                <span class="detail-label">Alinhamento</span>
                <span class="detail-value">{{actor.system.details.alignment}}</span>
              </div>
              <div class="item-row detail-item full-width">
                <span class="detail-label">Crença / Fé</span>
                <span class="detail-value">{{actor.system.details.belief}}</span>
              </div>
              
            </div>
          </div>
        </div>

    {{!-- Coluna Principal: História do Personagem --}}
    <div class="biography-story">
        <h3 class="block-title">História do Personagem</h3>
        
        {{!-- ✅ INÍCIO: Nova estrutura de Editor de Texto --}}
        <div class="description-section">
            
            {{!-- 1. Modo de Visualização (Texto Renderizado) --}}
            <div class="description-view">
                {{{enrichedBackstory}}}
            </div>
            
            {{!-- 2. Botão "Editar" (Apenas para o dono) --}}
            {{#if editable}}
            <button type="button" class="toggle-editor" data-target="system.details.backstory">
                <i class="fas fa-edit"></i> Editar
            </button>
            {{/if}}

            {{!-- 3. Modo de Edição (Escondido) --}}
            <div class="description-editor" style="display: none;">
                {{!-- O editor em si (note button=false) --}}
               {{editor actor.system.details.backstory target="system.details.backstory" engine="prosemirror" button=false owner=owner editable=editable}}
                
                {{!-- Botões Salvar/Cancelar --}}
                <div class="description-editor-actions">
                        {{!-- Botões Salvar/Cancelar --}}
                        <button type="button" class="save-description" data-field="system.details.backstory">
                            <i class="fas fa-save"></i> Salvar
                        </button>
                        <button type="button" class="expand-description" data-expanded="false">
                            <i class="fas fa-expand"></i> Expandir
                        </button>
                        <button type="button" class="cancel-description">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {{!-- ✅ FIM: Nova estrutura de Editor de Texto --}}
        
    </div>
  </div>
{{!-- ============================================================= --}}
{{!--     ABA DE CONDIÇÕES ("CASTELO SÓLIDO" V5 - FINAL)            --}}
{{!-- ============================================================= --}}
<div class="tab conditions-tab" data-group="primary" data-tab="conditions">

    {{!-- ============================================================= --}}
    {{!--     SEÇÃO 1: EFEITOS TEMPORÁRIOS                              --}}
    {{!-- ============================================================= --}}
    <details class="form-section gum-details temporary-section gum-unified-section" data-group-id="cond-temp" {{collapsibleState "cond-temp" @root.collapsedData}}>
        <summary class="block-header gum-unified-header">
            <div class="header-left">
                <i class="fas fa-chevron-right indicator"></i>
                <span class="header-title">Efeitos Temporários</span>
                <span class="header-counter">{{temporaryEffects.length}}</span>
            </div>
            <p class="header-hint">Duração limitada (rodadas, minutos).</p>
        </summary>
        
        <div class="effects-grid-container"> 
            {{#each temporaryEffects as |effect|}}
                <div class="effect-pill-enhanced temp-effect" data-effect-id="{{effect.id}}">
                    <div class="pill-switch-wrapper">
                        <label class="switch" title="Ativar/Desativar efeito">
                            <input type="checkbox" class="effect-toggle" data-effect-id="{{effect.id}}" {{checked effect.disabled}}>
                            <span class="slider round"></span>
                        </label>
                    </div>
                    <img src="{{effect.img}}" class="pill-icon" title="{{effect.name}}"/>
                    <div class="pill-info">
                        <span class="pill-name">{{effect.name}}</span>
                        <div class="pill-details">
                            <span class="pill-tag duration" title="Duração Restante">
                                <i class="fas fa-hourglass-half"></i> {{effect.durationString}}
                            </span>
                            {{#if effect.disabled}}
                                <span class="pill-tag status off">Desativado</span>
                            {{else}}
                                <span class="pill-tag status on">Ativo</span>
                            {{/if}}
                            {{#if effect.appliedStatusLabel}}
                                <span class="pill-tag status-applied">Status aplicado: {{effect.appliedStatusLabel}}</span>
                            {{/if}}
                            {{#if effect.fonteNome}}
                            <span class="pill-tag source" title="Fonte: {{effect.fonteNome}}">
                                <i class="fas fa-link"></i> {{effect.fonteNome}}
                            </span>
                            {{/if}}
                        </div>
                    </div>
                    <div class="pill-controls">
                        <a class="effect-control quick-view-origin" title="Visualizar Fonte" data-origin-uuid="{{effect.fonteUuid}}"><i class="fas fa-eye"></i></a>
                        <a class="effect-control delete" data-action="delete-effect" data-effect-id="{{effect.id}}" title="Remover"><i class="fas fa-trash"></i></a>
                    </div>
                </div>
            {{/each}}
            
            {{#unless temporaryEffects.length}}
                <div class="placeholder-text">Nenhum efeito temporário ativo.</div>
            {{/unless}}
        </div>
    </details>

    {{!-- ============================================================= --}}
    {{!--     SEÇÃO 2: EFEITOS PERMANENTES                              --}}
    {{!-- ============================================================= --}}
    <details class="form-section gum-details permanent-section gum-unified-section" data-group-id="cond-perm" {{collapsibleState "cond-perm" @root.collapsedData}}>
        <summary class="block-header gum-unified-header">
            <div class="header-left">
                <i class="fas fa-chevron-right indicator"></i>
                <span class="header-title">Efeitos Permanentes</span>
                <span class="header-counter">{{permanentEffects.length}}</span>
            </div>
            <p class="header-hint">Vantagens, equipamentos e passivos.</p>
        </summary>
        
        <div class="effects-grid-container"> 
           {{#each permanentEffects as |effect|}}
                <div class="effect-pill-enhanced perm-effect" data-effect-id="{{effect.id}}">
                    <div class="pill-switch-wrapper">
                        <label class="switch" title="Ativar/Desativar efeito">
                            <input type="checkbox" class="effect-toggle" data-effect-id="{{effect.id}}" {{checked effect.disabled}}>
                            <span class="slider round"></span>
                        </label>
                    </div>
                    <img src="{{effect.img}}" class="pill-icon" title="{{effect.name}}"/>
                    <div class="pill-info">
                        <span class="pill-name">{{effect.name}}</span>
                        <div class="pill-details">
                           {{#if effect.disabled}}
                                <span class="pill-tag status off">Desativado</span>
                            {{else}}
                                <span class="pill-tag status on">Ativo</span>
                            {{/if}}
                            {{#if effect.appliedStatusLabel}}
                                <span class="pill-tag status-applied">Status aplicado: {{effect.appliedStatusLabel}}</span>
                            {{/if}}
                            <span class="pill-tag source" title="Fonte: {{effect.fonteNome}}">
                                <i class="{{effect.fonteIcon}}"></i> {{effect.fonteNome}}
                            </span>
                        </div>
                    </div>
                    <div class="pill-controls">
                        <a class="effect-control quick-view-origin" title="Visualizar Fonte" data-origin-uuid="{{effect.fonteUuid}}"><i class="fas fa-eye"></i></a>
                        <a class="effect-control delete" data-action="delete-effect" data-effect-id="{{effect.id}}" title="Remover"><i class="fas fa-times"></i></a>
                    </div>
                </div>
            {{/each}}
            
            {{#unless permanentEffects.length}}
                <div class="placeholder-text">Nenhum efeito permanente.</div>
            {{/unless}}
        </div>
    </details>

    {{!-- ============================================================= --}}
    {{!--     SEÇÃO 3: CONDIÇÕES PASSIVAS (REGRAS / INSTALLED)          --}}
    {{!-- ============================================================= --}}
    <details class="form-section gum-details passive-section gum-unified-section" data-group-id="cond-passive" {{collapsibleState "cond-passive" @root.collapsedData}}>
        <summary class="block-header gum-unified-header">
            <div class="header-left">
                <i class="fas fa-chevron-right indicator"></i>
                <span class="header-title">Condições Passivas (Regras)</span>
                <span class="header-counter">{{installedConditions.length}}</span>
            </div>
            <p class="header-hint">Automações de sistema e cenário.</p>
        </summary>
        
        <div class="effects-grid-container"> 
            {{#each installedConditions as |item|}}
                <div class="effect-pill-enhanced passive-rule" data-item-id="{{item.id}}">
                    
                    {{!-- O SWITCH --}}
                    <div class="pill-switch-wrapper">
                        <label class="switch" title="Anular Automação (Override)">
                            <input type="checkbox" class="manual-override-toggle" data-item-id="{{item.id}}" {{checked item.flags.gum.manual_override}}>
                            <span class="slider round"></span>
                        </label>
                    </div>

                    <img src="{{item.img}}" class="pill-icon" alt="{{item.name}}"/>
                    
                    <div class="pill-info">
                        <span class="pill-name">{{item.name}}</span>
                        <div class="pill-details">
                            {{#if item.flags.gum.manual_override}}
                                <span class="pill-tag status off">Desativado</span>
                            {{else}}
                                <span class="pill-tag status on">Automático</span>
                            {{/if}}
                        </div>
                    </div>

                    <div class="pill-controls">
                        <a class="effect-control item-edit" title="Editar Regra"><i class="fas fa-edit"></i></a>
                        <a class="effect-control item-delete" title="Remover Regra"><i class="fas fa-trash"></i></a>
                    </div>
                </div>
            {{/each}}
            
            {{#unless installedConditions.length}}
                <div class="placeholder-text">Nenhuma regra de condição instalada.</div>
            {{/unless}}
        </div>
    </details>

</div>


  </div>
  </main>
</div>


{{! ======= ESTRUTURA DO MENU CUSTOMIZADO (TEMPLATE VAZIO) ==========}}
<div class="custom-context-menu">
  {{!-- Este container é preenchido dinamicamente pelo JavaScript. --}}
</div>
</form>