<div class="gm-screen-layout">
    
{{!-- COLUNA ESQUERDA: MONITOR + FERRAMENTAS --}}
    <aside class="screen-sidebar monitor-column">
        
        {{!-- 1. NAVEGAÇÃO (TOPO FIXO) --}}
        <nav class="gum-monitor-tabs monitor-tabs tabs" data-group="monitor">
            <a class="item" data-tab="characters"><i class="fas fa-users"></i> PJs</a>
            <a class="item" data-tab="combat"><i class="fas fa-swords"></i> Combate</a>
        </nav>

        {{!-- 2. ÁREA DE CONTEÚDO (EXPANSÍVEL/ROLÁVEL) --}}
        <section class="monitor-body">
            
            {{!-- ABA PJs --}}
            <div class="tab characters-tab" data-tab="characters">
                <div class="monitor-list">
                    {{#each actors}}
                        {{> monitorCard actor=this}}
                    {{/each}}
                </div>
            </div>

            {{!-- ABA COMBATE --}}
            <div class="tab combat-tab" data-tab="combat">
                {{!-- Controles de Combate (Fixo no Topo desta aba) --}}
                {{#if hasCombat}}
                <div class="combat-controls-header">
                    <button class="combat-btn prev-turn" title="Turno Anterior"><i class="fas fa-backward"></i></button>
                    <button class="combat-btn end-combat" title="Encerrar Combate"><i class="fas fa-stop"></i> Fim</button>
                    <button class="combat-btn next-turn" title="Próximo Turno"><i class="fas fa-forward"></i> Próximo</button>
                </div>
                {{/if}}

                {{!-- Lista de Combatentes (Rola separadamente) --}}
                <div class="monitor-list">
                    {{#if hasCombat}}
                        {{#each combatants}}
                            {{> monitorCard actor=this}}
                        {{/each}}
                    {{else}}
                        <div class="placeholder-text" style="margin-top:20px;">
                            <p>Nenhum combate ativo.</p>
                        </div>
                    {{/if}}
                </div>
            </div>

        </section>

        {{!-- 3. PAINEL DE FERRAMENTAS (RODAPÉ FIXO UNIFICADO) --}}
        <div class="sidebar-tools-footer">
            
            {{!-- A. Modificador Manual --}}
            <div class="manual-mod-section">
                 <div class="manual-mod-toolbar {{#if isManualActive}}active{{/if}}">
                    <div class="manual-row-top">
                        <input type="text" class="manual-name" placeholder="Motivo (ex: Terreno)" value="{{manualCache.name}}">
                        <div class="value-controls">
                            <button class="step-btn" data-action="dec"><i class="fas fa-minus"></i></button>
                            <input type="number" class="manual-value" value="{{manualCache.value}}">
                            <button class="step-btn" data-action="inc"><i class="fas fa-plus"></i></button>
                        </div>
                        <button class="activate-manual-btn" title="Ativar Manual"><i class="fas fa-crosshairs"></i></button>
                    </div>
                    <div class="manual-presets">
                        <button class="preset-btn" data-val="-4">-4</button>
                        <button class="preset-btn" data-val="-2">-2</button>
                        <button class="preset-btn" data-val="-1">-1</button>
                        <button class="preset-btn" data-val="1">+1</button>
                        <button class="preset-btn" data-val="2">+2</button>
                        <button class="preset-btn" data-val="4">+4</button>
                    </div>
                </div>
            </div>

            {{!-- B. Rolador Rápido --}}
            <div class="quick-rollers">
                 <div class="roller-section test-section">
                    <div class="roller-row">
                        <span class="roller-label">NH</span>
                        <input type="number" class="qr-nh" placeholder="10" value="10" title="Nível Base">
                        <div class="qr-mod-display" title="Total Modificadores">+0</div>
                        <button class="qr-toggle-mode active" title="Modo Privado"><i class="fas fa-eye-slash"></i></button>
                        <button class="qr-btn roll-test" title="Rolar Teste"><i class="fas fa-dice"></i></button>
                    </div>
                    <div class="qr-result-display" style="display:none;"></div>
                </div>
                <div class="roller-section damage-section">
                    <div class="roller-row">
                        <span class="roller-label"><i class="fas fa-skull"></i></span>
                        <input type="text" class="qr-formula" placeholder="2d+1" value="1d">
                        <input type="text" class="qr-type" placeholder="Tipo" value="cont">
                        <button class="qr-btn roll-damage" title="Rolar Dano"><i class="fas fa-bolt"></i></button>
                    </div>
                </div>
            </div>
            
        </div>

    </aside>

    {{!-- COLUNA DIREITA: DASHBOARD (LIMPA) --}}
    <section class="screen-main controls-column">
        
        {{!-- Barra de Ferramentas da Paleta --}}
<div class="palette-tools-bar">
            <nav class="gum-screen-tabs screen-tabs tabs" data-group="primary">
                <a class="item" data-tab="modifiers"><i class="fas fa-sliders-h"></i> Dashboard</a>
                <a class="item" data-tab="macros"><i class="fas fa-terminal"></i> Macros</a>
            </nav>
            
            <div class="palette-actions">
                <div class="search-wrapper">
                    <i class="fas fa-search"></i>
                    <input type="text" class="mod-search" placeholder="Filtrar..." autocomplete="off">
                </div>
                <button class="clear-selection-btn" title="Desmarcar Todos">
                    <i class="fas fa-eraser"></i>
                </button>
            </div>
        </div>

        <section class="screen-body">
            <div class="tab modifiers-dashboard" data-tab="modifiers">
                <div class="modular-grid">
                    {{#each columns as |column|}}
                    <div class="modular-column" data-col-id="{{column.id}}">
                        <div class="column-tools">
                            <button class="add-group-btn" data-col="{{column.id}}" title="Criar Grupo"><i class="fas fa-plus"></i></button>
                        </div>
                        <div class="column-groups">
                            {{#each column.groups as |group|}}
                            <div class="modifier-group" data-group-id="{{group.id}}">
                                <div class="group-header">
                                    <span class="group-title">{{group.name}}</span>
                                    <div class="group-actions">
                                        <a class="add-mod-to-group-btn" data-group-id="{{group.id}}"><i class="fas fa-search-plus"></i></a>
                                        <a class="delete-group-btn" data-group-id="{{group.id}}"><i class="fas fa-trash"></i></a>
                                    </div>
                                </div>
                                <div class="group-content-area">
                                    {{#each group.enrichedItems}}
                                    <div class="palette-mod {{#if this.isSelected}}active{{/if}}" data-uuid="{{this.uuid}}" data-value="{{this.system.modifier}}" data-cap="{{this.system.nh_cap}}"data-cap="{{this.system.nh_cap}}">
                                        <div class="mod-left">
                                            <img src="{{this.img}}" class="mod-icon"/>
                                            <span class="mod-name">{{this.name}}</span>
                                        </div>
                                        <div class="mod-right">
                                            <span class="mod-val {{#if (lt this.system.modifier 0)}}neg{{/if}}">
                                                {{numberFormat this.system.modifier sign=true}}
                                            </span>
                                            <div class="mod-hover-controls">
                                                <a class="mod-quick-view"><i class="fas fa-eye"></i></a>
                                                <a class="delete-mod-btn"><i class="fas fa-times"></i></a>
                                            </div>
                                        </div>
                                    </div>
                                    {{/each}}
                                    {{#unless group.enrichedItems}}<div class="empty-group-hint">Vazio</div>{{/unless}}
                                </div>
                            </div>
                            {{/each}}
                        </div>
                    </div>
                    {{/each}}
                </div>
            </div>
            <div class="tab" data-tab="macros"><p class="instruction">Macros em breve.</p></div>
        </section>
    </section>
</div>

{{!-- PARTIAL ATUALIZADO: INICIATIVA DENTRO DO CARD --}}
{{#*inline "monitorCard"}}
<div class="monitor-card {{#if actor.isTurn}}active-turn{{/if}} {{#if actor.isDefeated}}defeated{{/if}}" 
     data-actor-id="{{actor.id}}" 
     data-token-id="{{actor.tokenId}}">

    <div class="card-top">
        <div class="actor-identity">
            <img src="{{actor.img}}" />
            <span class="actor-name">{{actor.name}}</span>
        </div>
        <div class="vital-bars">
            <div class="mini-bar hp"><div class="fill" style="width: {{actor.hp.percent}}%;"></div></div>
            <div class="mini-bar fp"><div class="fill" style="width: {{actor.fp.percent}}%;"></div></div>
        </div>
    </div>
    
    {{!-- LINHA DE DEFESAS + INICIATIVA --}}
    <div class="passive-defenses">
        {{!-- Só mostra iniciativa se existir (ou seja, se estiver na aba de combate) --}}
        {{#if actor.initiative}}
            <span class="def-tag init" title="Iniciativa"><i class="fas fa-bolt"></i> {{actor.initiative}}</span>
            <span class="sep">|</span>
        {{/if}}
        
        <span class="def-tag" title="Esquiva"><i class="fas fa-running"></i> {{actor.defenses.dodge}}</span>
        <span class="def-tag" title="Aparar"><i class="fas fa-swords"></i> {{actor.defenses.parry}}</span>
        <span class="def-tag" title="Bloqueio"><i class="fas fa-shield-alt"></i> {{actor.defenses.block}}</span>
    </div>

    <div class="active-mods-zone">
        {{#if actor.activeGMMods.length}}
            {{#each actor.activeGMMods}}
            <span class="active-mod-tag" data-index="{{@index}}">
                {{this.name}} <strong>{{#if (gt this.value 0)}}+{{/if}}{{this.value}}</strong>
                <i class="fas fa-times remove-mod"></i>
            </span>
            {{/each}}
        {{else}}
            <span class="hint-text">. . .</span>
        {{/if}}
    </div>
</div>
{{/inline}}