<form class="damage-application-window">
    
    {{!-- 1. CABEÇALHO COM ATACANTE, DANOS E ALVO --}}
    <header class="damage-header">
  <div class="header-row">
    <div class="actor-portrait attacker">
      <img src="{{attacker.img}}" title="Atacante: {{attacker.name}}"/>
      </div>

    <div class="damage-cards-area">
      {{!-- Card do Dano Principal --}}
      <a class="damage-card active" data-damage-key="main">
        <div class="damage-value">{{damage.main.total}}</div>
        <div class="damage-label">{{#if (gt damage.main.armorDivisor 1)}}({{damage.main.armorDivisor}}){{/if}} {{damage.main.type}}</div>
      </a>
      {{#if damage.followUp.total}}
      <a class="damage-card follow-up" data-damage-key="followUp">
        <div class="damage-value">{{damage.followUp.total}}</div>
        <div class="damage-label">{{#if (gt damage.followUp.armorDivisor 1)}}({{damage.followUp.armorDivisor}}){{/if}} {{damage.followUp.type}}</div>
      </a>
      {{/if}}
      {{#if damage.fragmentation.total}}
      <a class="damage-card fragmentation" data-damage-key="fragmentation">
        <div class="damage-value">{{damage.fragmentation.total}}</div>
        <div class="damage-label">{{#if (gt damage.fragmentation.armorDivisor 1)}}({{damage.fragmentation.armorDivisor}}){{/if}} {{damage.fragmentation.type}}</div>
      </a>
      {{/if}}
    </div>

    <div class="actor-portrait target">
      <img src="{{target.img}}" title="Alvo: {{target.name}}"/>
      </div>
  </div>

  <div class="header-row selector-row">
    <select name="damage_target_pool">
      {{#each damageablePools as |pool|}}
        <option value="{{pool.path}}">{{pool.label}}</option>
      {{/each}}
    </select>
  </div>
</header>


    <hr class="header-divider">

    {{!-- 2. CORPO COM 3 COLUNAS --}}
    <main class="damage-app-body">
        <div class="body-column hit-locations-panel">
            <div class="panel-header">Ponto de Impacto</div>
            <div class="locations-table">
                {{!-- Cabeçalho da Tabela de RD --}}
                <div class="location-header">
                    <span>Rolagem</span>
                    <span>Local</span>
                    <span>RD</span>
                </div>
                {{!-- Lista de Locais --}}
                {{#each locations}}
                <div class="location-row" data-location-key="{{this.key}}" data-dr="{{this.totalDR}}">
                    <span class="roll">{{this.roll}}</span>
                    <span class="label">{{this.label}}</span>
                        <span class="dr">
                            {{#if this.custom}}
                                <input type="number" name="custom_dr" value="0" min="0" class="custom-dr-input"/>
                            {{else}}
                                {{this.totalDR}}
                            {{/if}}
                        </span>
                </div>
                {{/each}}
            </div>
            <div class="damage-options">
                <label class="custom-checkbox">
                    <input type="checkbox" name="large_area_injury" class="gcs-checkbox"/>
                    <span>Lesão em Larga Escala</span>
                </label>
                <label class="custom-checkbox">
                    <input type="checkbox" name="ignore_dr" class="gcs-checkbox"/>
                    <span>Ignorar RD do Alvo</span>
                </label>
            </div>
        </div>

        
       {{!-- Coluna 2: Modificadores de Ferimento --}}
<div class="body-column wounding-mods-panel">
     <div class="panel-header">Mod. de Ferimento e Lesão</div>
<div class="wounding-table">
  <div class="wounding-table">
  {{#each woundingModifiers}}
    {{#if (or (eq this.abrev "cort") (eq this.abrev "cont") (eq this.abrev "perf"))}}
      <div class="wounding-row group-1">
        <label class="custom-radio">
          <input type="radio" name="wounding_mod_type" value="{{this.mult}}" {{#if this.checked}}checked{{/if}}/>
          <span class="type">{{this.type}} ({{this.abrev}})</span>
          <span class="dots"></span>
          <span class="mult">x{{this.mult}}</span>
        </label>
      </div>
    {{/if}}
  {{/each}}

  {{#each woundingModifiers}}
    {{#if (or (eq this.abrev "qmd") (eq this.abrev "cor") (eq this.abrev "tox"))}}
      <div class="wounding-row group-2">
        <label class="custom-radio">
          <input type="radio" name="wounding_mod_type" value="{{this.mult}}" {{#if this.checked}}checked{{/if}}/>
          <span class="type">{{this.type}} ({{this.abrev}})</span>
          <span class="dots"></span>
          <span class="mult">x{{this.mult}}</span>
        </label>
      </div>
    {{/if}}
  {{/each}}

  {{#each woundingModifiers}}
    {{#if (or (eq this.abrev "pi") (eq this.abrev "pi-") (eq this.abrev "pi+") (eq this.abrev "pi++"))}}
      <div class="wounding-row group-3">
        <label class="custom-radio">
          <input type="radio" name="wounding_mod_type" value="{{this.mult}}" {{#if this.checked}}checked{{/if}}/>
          <span class="type">{{this.type}} ({{this.abrev}})</span>
          <span class="dots"></span>
          <span class="mult">x{{this.mult}}</span>
        </label>
      </div>
    {{/if}}
  {{/each}}

  </div>
</div>

</div>

        {{!-- Colunas 3 --}}
        <div class="body-column situational-mods-panel">
  <div class="panel-header">Situações Especiais</div>
  <div class="situational-options">
   
    <label class="custom-checkbox">
        <input type="checkbox" name="special_apply_effects_only" class="gcs-checkbox"/>
        <span title="Ignora a Lesão e aplica apenas os efeitos contingentes ao alvo.">Aplicar Apenas Efeitos</span>
    </label>
      
    <label class="custom-checkbox">
      <input type="checkbox" name="special_apply_as_heal" class="gcs-checkbox"/>
      <span title="Inverte a Lesão - Recupera ao invés de Ferir">Aplicar como Cura</span>
    </label>
 

  <label class="custom-checkbox">
    <input type="checkbox" name="special_half_damage" class="gcs-checkbox" />
    <span>Acima da Distância 1/2D</span>
  </label>

  <label class="custom-checkbox">
    <input type="checkbox" name="special_explosion" class="gcs-checkbox"/>
    <span>Dano de Explosão</span>
    <input type="number" name="special_explosion_distance" min="0" step="1" value="1" style="width: 40px; margin-left: 6px;" title="Distância em metros/hex do centro da explosão"/>
  </label>

  <label class="custom-checkbox">
    <input type="checkbox" name="show_impact_effects" class="gcs-checkbox"/>
    <span>Mostrar efeitos do ponto de impacto</span>
  </label>


<div class="injury-tolerance-section">
<label class="custom-select">
  <span>Tolerância a Ferimentos:</span>
  <select name="tolerance_type">
    <option value="">Nenhuma</option>
    <option value="nao-vivo">Não Vivo</option>
    <option value="homogeneo">Homogêneo</option>
    <option value="difuso">Difuso (máx. 1 lesão)</option>
  </select>
</label>
</div>

  </div>
</div>

    </main>

    <input type="hidden" name="target_dr" value="0" />

{{!-- ================================== --}}
{{!--  3. RODAPÉ (VERSÃO FINAL 3 COLUNAS) --}}
{{!-- ================================== --}}
<footer class="damage-app-footer">
    
    {{!-- COLUNA 2: EFEITOS (COM A CLASSE CORRETA) --}}
    <div class="footer-column effects-summary">
        {{!-- O JavaScript vai preencher esta área corretamente agora --}}
        <div class="placeholder">Efeitos a serem aplicados</div>
    </div>

    {{!-- COLUNA 1: CÁLCULOS (VERSÃO COMPACTA E ESTILIZADA) --}}
  <div class="footer-column calculation-summary">
      <div class="calc-group-compact">
          <div class="calc-item-compact">
              <label>Dano Básico</label>
              <input type="number" name="damage_rolled" class="calc-input-compact" min="0" step="1"/>
          </div>
          <div class="calc-item-compact">
              <label>Divisor</label>
              <input type="number" name="armor_divisor" class="calc-input-compact" value="1" min="0.1" step="0.1"/>
          </div>
      </div>

      <div class="calc-group-compact">
          <div class="calc-item-compact">
              <label>RD Alvo</label>
              <span class="calc-field-compact" data-field="target_dr">(...)</span>
          </div>
          <div class="calc-item-compact">
              <label>Penetrante</label>
              <span class="calc-field-compact" data-field="penetrating_damage">0</span>
          </div>
      </div>
      
      <div class="calc-item-compact single">
          <label>Mod. Ferimento</label>
          <span class="calc-field-compact" data-field="wounding_mod">x1</span>
      </div>

      {{!--ÁREA PARA NOTAS DE CÁLCULO --}}
  <div class="calculation-notes">
      {{!-- O JavaScript vai inserir as mensagens aqui --}}
  </div>
      <div class="final-injury-compact">
          <label>Lesão</label>
          <span data-field="final_injury">0</span>
      </div>
  </div>




</footer>

    {{!-- BOTÕES DE APLICAÇÃO DO DANO --}}
    <div class="footer-column action-buttons">
        <button type="button" data-action="proposeTests" style="display: none;"><i class="fas fa-dice-d20"></i>TODOS os Testes</button>
        <button type="button" data-action="applyAndPublish"><i class="fas fa-bullhorn"></i> Aplicar e Publicar</button>
        <button type="button" data-action="applyAndClose"><i class="fas fa-check"></i> Aplicar e Fechar</button>
        <button type="button" data-action="applyAndKeepOpen"><i class="fas fa-sync-alt"></i> Aplicar e Manter</button>
    </div>